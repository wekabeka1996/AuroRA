# Governance thresholds & dynamic calibration profiles
profiles:
  default:
    features:
      use_adaptive_icp: true
    service:
      api:
        enabled: true
        host: "0.0.0.0"
        port: 9100
        profile_label: "default"
        expose_metrics_from_profile: "default"
    icp:
      alpha_target: 0.10
      eta: 0.01
      window: 1000
      quantile_fallback: p2   # p2 | deque
    alpha:
      mode: adaptive   # adaptive | static (fail-safe can flip)
      static_value: 0.10
      proxy_eval:
        synth_n: 200
        sigma_grid: [0.1,0.2,0.4,0.8]
        corr_min_synth: 0.60
        corr_min_real_p25: 0.30
        real_window: 256
        degrade_runs: 3
        recover_runs: 5
        state_file: artifacts/alpha/proxy_state.json
    kappa:
      tau_pass: 0.75
      tau_derisk: 0.50
    acceptance:
      coverage_lower_bound: 0.90
      surprisal_p95_guard: 2.5
      latency_p95_max_ms: 120
      max_interval_rel_width: 0.06
      persistence_n: 20
      penalties:
        latency_to_kappa_bonus: -0.05
        coverage_deficit_bonus: -0.10
      hysteresis:
        tau_pass_up: 0.78
        tau_pass_down: 0.72
        tau_derisk_up: 0.55
        tau_derisk_down: 0.48
        surprisal_guard_up: 2.6
        surprisal_guard_down: 2.4
        coverage_lower_bound_up: 0.915
        coverage_lower_bound_down: 0.885
        latency_p95_max_up_ms: 110
        latency_p95_max_down_ms: 130
      dwell:
        pass_up: 5
        pass_down: 2
        derisk_up: 4
        derisk_down: 3
        block_up: 6
        block_down: 8
    dro_es:
      eps_grid: [0.0, 0.01, 0.02, 0.05]
      es_alpha: 0.975
    metrics:
      enabled: true
      mode: "api"  # api => /metrics обслуживается FastAPI сервисом
      port: 9108
      profile_label: "default"
      latency_buckets_ms: [10,25,50,75,100,150,250,400,600]
      surprisal_buckets: [0.1,0.3,0.7,1.2,2.0,3.0,5.0]
      width_buckets: [0.001,0.002,0.004,0.008,0.016,0.032]
      kappa_buckets: [0.2,0.4,0.6,0.7,0.8,0.9,0.95,0.99]
    execution:
      gating:
        base_notional: 1.0
        scale_map:
          PASS: 1.0
          DERISK: 0.4
          BLOCK: 0.0
        hard_block_on_guard: true
        min_notional: 0.0
        max_notional: 10.0
    risk:
      dro_risk:
        enabled: true
        lambda: 1.0   # sensitivity multiplier
        k: 10.0       # curvature for mapping penalty->factor
        floor: 0.5    # minimum multiplicative factor
    ci_gating:
      enabled: true
      hard_override: auto   # auto | force_off | force_on (promote all hard_candidate)
      hard_enabled: true    # global gate to actually enforce hard_meta violations
      panic_file: artifacts/ci/panic_disable_hard_gating  # if exists, hard gating disabled
      window_runs: 5
      enter_warn_runs: 2
      exit_warn_runs: 3
      enter_watch_runs: 1
      cooldown_runs: 3
      persistence_file: artifacts/ci/gating_state.jsonl
      coverage:
        ema_beta: 0.2
        ema_state_file: artifacts/ci/coverage_ema.state
      metrics:
        - name: churn
          source_key: decision_churn_per_1k
          threshold_key: ci.churn.max
          relation: "<="
          hard_candidate: true
        - name: dcts
          source_key: tvf2.dcts
          threshold_key: tvf2.dcts.min
          relation: ">="
          hard_candidate: true
        - name: coverage_abs_err_ema
          source_key: coverage_abs_err_ema
          threshold_key: ci.coverage_tolerance.max
          relation: "<="
          hard_candidate: false
        - name: dro_penalty
          source_key: acceptance.dro_penalty
          threshold_key: risk.max_dro_penalty
          relation: "<="
          hard_candidate: false
    tvf2:
      dcts:
        base_window: 20
        grids: [0.5, 1.0, 2.0]
        aggregator: median_min   # median_min | median | trimmed_mean:p=0.2
    observability:
      prometheus:
        tvf2_dcts_export:
          enabled: true
          export_grids: false
    ci_gating:
      dcts_divergence:
        enabled: true
        abs_delta_max: 0.08
        rel_delta_max: 0.15
        window_runs: 5
        min_breaches: 3
    calibration:
      objective_weights:
        w_pass: 1.0
        w_derisk: 0.5
        w_block: 2.0
        w_viol: 3.0
        w_lat: 1.0
        w_sur: 1.0
        w_flap: 0.5
      hard_constraints:
        - coverage>=bound
        - surprisal<=guard*1.05
        - latency_p95<=slo*1.15
    state:
      enabled: true
      snapshot_path: "snapshots/aurora_default_state.json"
      autosave:
        every_events: 500
        every_seconds: 300
        jitter_seconds: 5
  shadow:
    features:
      use_adaptive_icp: true
    icp:
      alpha_target: 0.12
      eta: 0.015
      window: 800
      quantile_fallback: p2
    kappa:
      tau_pass: 0.70
      tau_derisk: 0.45
    acceptance:
      coverage_lower_bound: 0.88
      surprisal_p95_guard: 2.7
      latency_p95_max_ms: 130
      max_interval_rel_width: 0.07
      persistence_n: 15
      penalties:
        latency_to_kappa_bonus: -0.06
        coverage_deficit_bonus: -0.12
      hysteresis:
        tau_pass_up: 0.76
        tau_pass_down: 0.70
        tau_derisk_up: 0.53
        tau_derisk_down: 0.46
        surprisal_guard_up: 2.8
        surprisal_guard_down: 2.6
        coverage_lower_bound_up: 0.905
        coverage_lower_bound_down: 0.875
        latency_p95_max_up_ms: 115
        latency_p95_max_down_ms: 135
      dwell:
        pass_up: 5
        pass_down: 2
        derisk_up: 4
        derisk_down: 3
        block_up: 6
        block_down: 8
    dro_es:
      eps_grid: [0.0, 0.015, 0.03, 0.06]
      es_alpha: 0.975
    metrics:
      enabled: true
      port: 9110
      profile_label: "shadow"
      latency_buckets_ms: [10,25,50,75,100,150,250,400,600]
      surprisal_buckets: [0.1,0.3,0.7,1.2,2.0,3.0,5.0]
      width_buckets: [0.001,0.002,0.004,0.008,0.016,0.032]
      kappa_buckets: [0.2,0.4,0.6,0.7,0.8,0.9,0.95,0.99]
    execution:
      gating:
        base_notional: 1.0
        scale_map:
          PASS: 1.0
          DERISK: 0.5
          BLOCK: 0.0
        hard_block_on_guard: true
        min_notional: 0.0
        max_notional: 10.0
    state:
      enabled: true
      snapshot_path: "snapshots/aurora_shadow_state.json"
      autosave:
        every_events: 500
        every_seconds: 300
        jitter_seconds: 5
