<!DOCTYPE html><html lang="en"><head><meta charset="UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1.0"><title>Copy/Paste Detector Report</title><link href="styles/tailwind.css" rel="stylesheet"><link href="styles/prism.css" rel="stylesheet"></head><body class="bg-gray-100"><header class="bg-white shadow py-4"><div class="container mx-auto px-4"><h1 class="text-3xl font-semibold text-gray-800">jscpd - copy/paste report</h1></div></header><main class="container mx-auto my-8 p-4 bg-white shadow rounded"><section class="mb-8" id="dashboard"><h2 class="text-2xl font-semibold text-gray-700 mb-4">Dashboard</h2><div class="grid grid-cols-4 gap-4"><div class="bg-blue-200 p-4 rounded text-center"><h3 class="text-lg font-semibold text-blue-800 mb-2">Total Files</h3><span class="text-4xl font-bold text-blue-800">381</span></div><div class="bg-green-200 p-4 rounded text-center"><h3 class="text-lg font-semibold text-green-800 mb-2">Total Lines of Code</h3><span class="text-4xl font-bold text-green-800">71478</span></div><div class="bg-yellow-200 p-4 rounded text-center"><h3 class="text-lg font-semibold text-yellow-800 mb-2">Number of Clones</h3><span class="text-4xl font-bold text-yellow-800">172</span></div><div class="bg-red-200 p-4 rounded text-center"><h3 class="text-lg font-semibold text-red-800 mb-2">Duplicated Lines</h3><span class="text-4xl font-bold text-red-800">2638 (3.69%)</span></div></div></section><section class="mb-8" id="formats"><h2 class="text-2xl font-semibold text-gray-700 mb-4">Formats with Duplications</h2><table class="w-full table-auto"><thead><tr class="bg-gray-200 text-gray-600 uppercase text-sm leading-normal"><th class="py-3 px-6 text-left">Format</th><th class="py-3 px-6 text-left">Files</th><th class="py-3 px-6 text-left">Lines</th><th class="py-3 px-6 text-left">Clones</th><th class="py-3 px-6 text-left">Duplicated Lines</th><th class="py-3 px-6 text-left">Duplicated Tokens</th></tr></thead><tbody><tr class="bg-white border-b border-gray-200 text-gray-800 text-sm"><td class="py-3 px-6"><a class="text-blue-600 hover:underline" href="#python-clones">python</a></td><td class="py-3 px-6">381</td><td class="py-3 px-6">71478</td><td class="py-3 px-6">172</td><td class="py-3 px-6">2638</td><td class="py-3 px-6">23433</td></tr></tbody></table></section><section class="mb-8" id="txt-clones"><a name="python-clones"></a><h2 class="text-2xl font-semibold text-gray-700 mb-4">python</h2><div class="divide-y divide-gray-200 border-b-2"><div class="py-4"><p class="text-gray-600">tests\unit\api\test_api_survived_mutants.py (Line 240:32 - Line 272:60), tests\unit\core_aurora\test_core_aurora_survived_mutants.py (Line 297:30 - Line 329:58)</p><button class="bg-gray-500 text-white px-1 py-0.5 text-xs rounded focus:outline-none ml-2" id="expandBtn0" onclick="toggleCodeBlock('cloneGroup0', 'expandBtn0', 'collapseBtn0')">Show code</button><button class="bg-gray-500 text-white px-1 py-0.5 text-xs rounded focus:outline-none ml-2 hidden" id="collapseBtn0" onclick="toggleCodeBlock('cloneGroup0', 'expandBtn0', 'collapseBtn0')">Hide code</button><pre class="bg-gray-100 border border-gray-200 p-4 rounded mt-2 hidden" id="cloneGroup0"><code class="language-python text-sm text-gray-800">:
    &quot;&quot;&quot;Targeted tests for dictionary access pattern mutants&quot;&quot;&quot;

    def test_get_or_default_patterns_mutant(self):
        &quot;&quot;&quot;Kill mutant: 'or' -&gt; 'and' in dict.get() or default patterns&quot;&quot;&quot;

        test_dicts = [
            {},  # Empty dict
            {&quot;key&quot;: &quot;value&quot;},  # Has key
            {&quot;other_key&quot;: &quot;value&quot;},  # Missing key
        ]

        for d in test_dicts:
            # Test pattern: d.get('key') or default
            result = d.get('key') or &quot;default&quot;
            assert result is not None

            # Test pattern: d.get('key') or {}
            result_dict = d.get('key') or {}
            assert isinstance(result_dict, (str, dict))

    def test_compound_get_or_patterns_mutant(self):
        &quot;&quot;&quot;Kill mutant: boolean logic in compound get() or patterns&quot;&quot;&quot;

        test_dicts = [
            {},  # Missing both
            {&quot;guards&quot;: {}},  # Has guards
            {&quot;gates&quot;: {}},   # Has gates
            {&quot;guards&quot;: {}, &quot;gates&quot;: {}},  # Has both
        ]

        for d in test_dicts:
            # Test pattern: ((d.get('guards') or d.get('gates') or {}))</code></pre></div><div class="py-4"><p class="text-gray-600">tests\integration\oms\test_order_lifecycle.py (Line 306:9 - Line 319:26), tests\integration\oms\test_order_lifecycle.py (Line 252:9 - Line 265:36)</p><button class="bg-gray-500 text-white px-1 py-0.5 text-xs rounded focus:outline-none ml-2" id="expandBtn1" onclick="toggleCodeBlock('cloneGroup1', 'expandBtn1', 'collapseBtn1')">Show code</button><button class="bg-gray-500 text-white px-1 py-0.5 text-xs rounded focus:outline-none ml-2 hidden" id="collapseBtn1" onclick="toggleCodeBlock('cloneGroup1', 'expandBtn1', 'collapseBtn1')">Hide code</button><pre class="bg-gray-100 border border-gray-200 p-4 rounded mt-2 hidden" id="cloneGroup1"><code class="language-python text-sm text-gray-800">)

        # Submit order
        xai.emit(&quot;ORDER.SUBMIT&quot;, {&quot;order&quot;: order.__dict__, &quot;action&quot;: &quot;submit&quot;}, {}, &quot;Order submission&quot;, 0.9)
        result = await om.submit_order(order)
        assert result[&quot;status&quot;] == &quot;accepted&quot;

        # Configure status for cancelled order
        om.get_order_status.return_value = {
            &quot;status&quot;: &quot;cancelled&quot;,
            &quot;order_id&quot;: result[&quot;order_id&quot;]
        }

        # Wait for FOK evaluation</code></pre></div><div class="py-4"><p class="text-gray-600">tests\integration\oms\test_order_lifecycle.py (Line 508:6 - Line 519:17), tests\integration\oms\test_order_lifecycle.py (Line 182:6 - Line 193:21)</p><button class="bg-gray-500 text-white px-1 py-0.5 text-xs rounded focus:outline-none ml-2" id="expandBtn2" onclick="toggleCodeBlock('cloneGroup2', 'expandBtn2', 'collapseBtn2')">Show code</button><button class="bg-gray-500 text-white px-1 py-0.5 text-xs rounded focus:outline-none ml-2 hidden" id="collapseBtn2" onclick="toggleCodeBlock('cloneGroup2', 'expandBtn2', 'collapseBtn2')">Hide code</button><pre class="bg-gray-100 border border-gray-200 p-4 rounded mt-2 hidden" id="cloneGroup2"><code class="language-python text-sm text-gray-800">)),
                fee=float(Decimal(&quot;0.001&quot;)),
                fee_asset=&quot;USDT&quot;,
                ts_ns=int(time.time() * 1_000_000_000)
            )
        ]
        om.get_order_fills.return_value = mock_fills
        xai.emit(&quot;ORDER.SUBMIT&quot;, {&quot;order&quot;: order.__dict__, &quot;action&quot;: &quot;submit&quot;}, {}, &quot;Order submission&quot;, 0.9)
        result = await om.submit_order(order)
        assert result[&quot;status&quot;] == &quot;accepted&quot;

        # Wait for fills</code></pre></div><div class="py-4"><p class="text-gray-600">core\execution\exchange\common.py (Line 234:5 - Line 239:76), core\execution\exchange\unified.py (Line 128:5 - Line 133:6)</p><button class="bg-gray-500 text-white px-1 py-0.5 text-xs rounded focus:outline-none ml-2" id="expandBtn3" onclick="toggleCodeBlock('cloneGroup3', 'expandBtn3', 'collapseBtn3')">Show code</button><button class="bg-gray-500 text-white px-1 py-0.5 text-xs rounded focus:outline-none ml-2 hidden" id="collapseBtn3" onclick="toggleCodeBlock('cloneGroup3', 'expandBtn3', 'collapseBtn3')">Hide code</button><pre class="bg-gray-100 border border-gray-200 p-4 rounded mt-2 hidden" id="cloneGroup3"><code class="language-python text-sm text-gray-800">def request(self, method: str, url: str, *, params: Optional[Mapping[str, object]] = None,
                headers: Optional[Mapping[str, str]] = None, json: Optional[object] = None) -&gt; Mapping[str, object]:
        ...


# --------------------------- Abstract Exchange ---------------------------</code></pre></div><div class="py-4"><p class="text-gray-600">core\execution\exchange\common.py (Line 283:2 - Line 290:2), core\execution\exchange\gate.py (Line 106:2 - Line 113:52)</p><button class="bg-gray-500 text-white px-1 py-0.5 text-xs rounded focus:outline-none ml-2" id="expandBtn4" onclick="toggleCodeBlock('cloneGroup4', 'expandBtn4', 'collapseBtn4')">Show code</button><button class="bg-gray-500 text-white px-1 py-0.5 text-xs rounded focus:outline-none ml-2 hidden" id="collapseBtn4" onclick="toggleCodeBlock('cloneGroup4', 'expandBtn4', 'collapseBtn4')">Hide code</button><pre class="bg-gray-100 border border-gray-200 p-4 rounded mt-2 hidden" id="cloneGroup4"><code class="language-python text-sm text-gray-800">make_idempotency_key(&quot;oid&quot;, {
                    &quot;s&quot;: clean.symbol,
                    &quot;sd&quot;: clean.side.value,
                    &quot;t&quot;: clean.type.value,
                    &quot;q&quot;: clean.quantity,
                    &quot;p&quot;: clean.price if clean.price is not None else &quot;&quot;,
                })
            )</code></pre></div><div class="py-4"><p class="text-gray-600">core\execution\exchange\binance.py (Line 134:9 - Line 141:3), core\execution\exchange\gate.py (Line 106:9 - Line 113:52)</p><button class="bg-gray-500 text-white px-1 py-0.5 text-xs rounded focus:outline-none ml-2" id="expandBtn5" onclick="toggleCodeBlock('cloneGroup5', 'expandBtn5', 'collapseBtn5')">Show code</button><button class="bg-gray-500 text-white px-1 py-0.5 text-xs rounded focus:outline-none ml-2 hidden" id="collapseBtn5" onclick="toggleCodeBlock('cloneGroup5', 'expandBtn5', 'collapseBtn5')">Hide code</button><pre class="bg-gray-100 border border-gray-200 p-4 rounded mt-2 hidden" id="cloneGroup5"><code class="language-python text-sm text-gray-800">coid = clean.client_order_id or make_idempotency_key(&quot;oid&quot;, {
            &quot;s&quot;: clean.symbol,
            &quot;sd&quot;: clean.side.value,
            &quot;t&quot;: clean.type.value,
            &quot;q&quot;: clean.quantity,
            &quot;p&quot;: clean.price if clean.price is not None else &quot;&quot;,
        })
        ts</code></pre></div><div class="py-4"><p class="text-gray-600">core\execution\exchange\binance.py (Line 181:13 - Line 189:3), core\execution\exchange\gate.py (Line 145:13 - Line 153:5)</p><button class="bg-gray-500 text-white px-1 py-0.5 text-xs rounded focus:outline-none ml-2" id="expandBtn6" onclick="toggleCodeBlock('cloneGroup6', 'expandBtn6', 'collapseBtn6')">Show code</button><button class="bg-gray-500 text-white px-1 py-0.5 text-xs rounded focus:outline-none ml-2 hidden" id="collapseBtn6" onclick="toggleCodeBlock('cloneGroup6', 'expandBtn6', 'collapseBtn6')">Hide code</button><pre class="bg-gray-100 border border-gray-200 p-4 rounded mt-2 hidden" id="cloneGroup6"><code class="language-python text-sm text-gray-800">,
            cumm_quote_cost=cumm_quote_cost,
            fills=fills,
            ts_ns=int(self.server_time_ns_hint()),
            raw=res,
        )

    def cancel_order(self, symbol: str, order_id: str | None = None, client_order_id: str | None = None) -&gt; Mapping[str, object]:
        ts</code></pre></div><div class="py-4"><p class="text-gray-600">core\execution\exchange\binance.py (Line 201:10 - Line 212:6), core\execution\exchange\binance.py (Line 188:13 - Line 199:9)</p><button class="bg-gray-500 text-white px-1 py-0.5 text-xs rounded focus:outline-none ml-2" id="expandBtn7" onclick="toggleCodeBlock('cloneGroup7', 'expandBtn7', 'collapseBtn7')">Show code</button><button class="bg-gray-500 text-white px-1 py-0.5 text-xs rounded focus:outline-none ml-2 hidden" id="collapseBtn7" onclick="toggleCodeBlock('cloneGroup7', 'expandBtn7', 'collapseBtn7')">Hide code</button><pre class="bg-gray-100 border border-gray-200 p-4 rounded mt-2 hidden" id="cloneGroup7"><code class="language-python text-sm text-gray-800">(self, symbol: str, order_id: str | None = None, client_order_id: str | None = None) -&gt; Mapping[str, object]:
        ts = self.get_server_time_ms()
        params = {
            &quot;symbol&quot;: self.normalize_symbol(symbol),
            &quot;timestamp&quot;: ts,
            &quot;recvWindow&quot;: 5000,
        }
        if order_id:
            params[&quot;orderId&quot;] = order_id
        if client_order_id:
            params[&quot;origClientOrderId&quot;] = client_order_id
        return cast(Dict[str, Any], self._signed_request(&quot;GET&quot;</code></pre></div><div class="py-4"><p class="text-gray-600">tests\unit\test_tca_identity.py (Line 68:7 - Line 86:53), tests\unit\test_tca_identity.py (Line 16:6 - Line 34:151)</p><button class="bg-gray-500 text-white px-1 py-0.5 text-xs rounded focus:outline-none ml-2" id="expandBtn8" onclick="toggleCodeBlock('cloneGroup8', 'expandBtn8', 'collapseBtn8')">Show code</button><button class="bg-gray-500 text-white px-1 py-0.5 text-xs rounded focus:outline-none ml-2 hidden" id="collapseBtn8" onclick="toggleCodeBlock('cloneGroup8', 'expandBtn8', 'collapseBtn8')">Hide code</button><pre class="bg-gray-100 border border-gray-200 p-4 rounded mt-2 hidden" id="cloneGroup8"><code class="language-python text-sm text-gray-800">,
        target_qty=1.0,
        fills=fills,
        arrival_ts_ns=1000000000,
        decision_ts_ns=1000000000,
        arrival_price=100.0,
        arrival_spread_bps=2.0,
        latency_ms=10.0
    )

    market_data = {
        'mid_price': 100.0,
        'micro_price': 100.0,
        'slip_bps': 5.0
    }

    metrics = analyzer.analyze_order(execution, market_data)

    # Check identity using legacy-positive decomposition</code></pre></div><div class="py-4"><p class="text-gray-600">tests\unit\test_tca_identity.py (Line 87:5 - Line 109:31), tests\unit\test_tca_identity.py (Line 35:5 - Line 57:20)</p><button class="bg-gray-500 text-white px-1 py-0.5 text-xs rounded focus:outline-none ml-2" id="expandBtn9" onclick="toggleCodeBlock('cloneGroup9', 'expandBtn9', 'collapseBtn9')">Show code</button><button class="bg-gray-500 text-white px-1 py-0.5 text-xs rounded focus:outline-none ml-2 hidden" id="collapseBtn9" onclick="toggleCodeBlock('cloneGroup9', 'expandBtn9', 'collapseBtn9')">Hide code</button><pre class="bg-gray-100 border border-gray-200 p-4 rounded mt-2 hidden" id="cloneGroup9"><code class="language-python text-sm text-gray-800">components_sum = (
        metrics.raw_edge_bps +
        metrics.fees_bps +
        metrics.spread_cost_bps +
        metrics.latency_slippage_bps +
        metrics.adverse_selection_bps +
        metrics.temporary_impact_bps +
        metrics.rebate_bps
    )

    assert abs(metrics.implementation_shortfall_bps - components_sum) &lt;= 1e-6

    # Check sign conventions
    assert metrics.fees_bps &lt;= 0
    assert metrics.slippage_in_bps &lt;= 0  # Maker profile -&gt; 0
    assert metrics.slippage_out_bps &lt;= 0
    assert metrics.adverse_bps &lt;= 0
    assert metrics.latency_bps &lt;= 0
    assert metrics.impact_bps &lt;= 0
    assert metrics.rebate_bps &gt;= 0


def test_maker_profile_with_rebate</code></pre></div><div class="py-4"><p class="text-gray-600">tests\unit\test_tca_identity.py (Line 119:13 - Line 134:4), tests\unit\test_tca_identity.py (Line 14:12 - Line 29:4)</p><button class="bg-gray-500 text-white px-1 py-0.5 text-xs rounded focus:outline-none ml-2" id="expandBtn10" onclick="toggleCodeBlock('cloneGroup10', 'expandBtn10', 'collapseBtn10')">Show code</button><button class="bg-gray-500 text-white px-1 py-0.5 text-xs rounded focus:outline-none ml-2 hidden" id="collapseBtn10" onclick="toggleCodeBlock('cloneGroup10', 'expandBtn10', 'collapseBtn10')">Hide code</button><pre class="bg-gray-100 border border-gray-200 p-4 rounded mt-2 hidden" id="cloneGroup10"><code class="language-python text-sm text-gray-800">,
        symbol=&quot;BTCUSDT&quot;,
        side=&quot;BUY&quot;,
        target_qty=1.0,
        fills=fills,
        arrival_ts_ns=1000000000,
        decision_ts_ns=1000000000,
        arrival_price=100.0,
        arrival_spread_bps=2.0,
        latency_ms=10.0
    )

    market_data = {
        'mid_price': 100.0,
        'micro_price': 100.0,
        'slip_bps': 2.0</code></pre></div><div class="py-4"><p class="text-gray-600">tests\unit\test_tca_identity.py (Line 172:13 - Line 192:16), tests\unit\test_tca_identity.py (Line 14:12 - Line 34:151)</p><button class="bg-gray-500 text-white px-1 py-0.5 text-xs rounded focus:outline-none ml-2" id="expandBtn11" onclick="toggleCodeBlock('cloneGroup11', 'expandBtn11', 'collapseBtn11')">Show code</button><button class="bg-gray-500 text-white px-1 py-0.5 text-xs rounded focus:outline-none ml-2 hidden" id="collapseBtn11" onclick="toggleCodeBlock('cloneGroup11', 'expandBtn11', 'collapseBtn11')">Hide code</button><pre class="bg-gray-100 border border-gray-200 p-4 rounded mt-2 hidden" id="cloneGroup11"><code class="language-python text-sm text-gray-800">,
        symbol=&quot;BTCUSDT&quot;,
        side=&quot;BUY&quot;,
        target_qty=1.0,
        fills=fills,
        arrival_ts_ns=1000000000,
        decision_ts_ns=1000000000,
        arrival_price=100.0,
        arrival_spread_bps=2.0,
        latency_ms=10.0
    )

    market_data = {
        'mid_price': 100.0,
        'micro_price': 100.0,
        'slip_bps': 5.0
    }

    metrics = analyzer.analyze_order(execution, market_data)

    # Taker profile</code></pre></div><div class="py-4"><p class="text-gray-600">tests\unit\test_tca_identity.py (Line 224:22 - Line 242:58), tests\unit\test_tca_identity.py (Line 14:12 - Line 32:8)</p><button class="bg-gray-500 text-white px-1 py-0.5 text-xs rounded focus:outline-none ml-2" id="expandBtn12" onclick="toggleCodeBlock('cloneGroup12', 'expandBtn12', 'collapseBtn12')">Show code</button><button class="bg-gray-500 text-white px-1 py-0.5 text-xs rounded focus:outline-none ml-2 hidden" id="collapseBtn12" onclick="toggleCodeBlock('cloneGroup12', 'expandBtn12', 'collapseBtn12')">Hide code</button><pre class="bg-gray-100 border border-gray-200 p-4 rounded mt-2 hidden" id="cloneGroup12"><code class="language-python text-sm text-gray-800">,
        symbol=&quot;BTCUSDT&quot;,
        side=&quot;BUY&quot;,
        target_qty=1.0,
        fills=fills,
        arrival_ts_ns=1000000000,
        decision_ts_ns=1000000000,
        arrival_price=100.0,
        arrival_spread_bps=2.0,
        latency_ms=10.0
    )

    market_data = {
        'mid_price': 100.0,
        'micro_price': 100.0,
        'slip_bps': 5.0
    }

    # This should raise ValueError due to sign gate violation</code></pre></div><div class="py-4"><p class="text-gray-600">tests\unit\test_tca_analyzer.py (Line 375:12 - Line 389:44), tests\unit\test_tca_analyzer.py (Line 173:15 - Line 187:25)</p><button class="bg-gray-500 text-white px-1 py-0.5 text-xs rounded focus:outline-none ml-2" id="expandBtn13" onclick="toggleCodeBlock('cloneGroup13', 'expandBtn13', 'collapseBtn13')">Show code</button><button class="bg-gray-500 text-white px-1 py-0.5 text-xs rounded focus:outline-none ml-2 hidden" id="collapseBtn13" onclick="toggleCodeBlock('cloneGroup13', 'expandBtn13', 'collapseBtn13')">Hide code</button><pre class="bg-gray-100 border border-gray-200 p-4 rounded mt-2 hidden" id="cloneGroup13"><code class="language-python text-sm text-gray-800">,
            symbol='BTCUSDT',
            side='BUY',
            target_qty=100.0,
            fills=fills,
            arrival_ts_ns=int(time.time_ns()),
            decision_ts_ns=int(time.time_ns()) - 1000000,
            arrival_price=100.0,
            arrival_spread_bps=10.0,
            latency_ms=1.0
        )

        metrics = analyzer.analyze_order(execution, sample_market_data)

        # Total fees should be sum of all fill fees</code></pre></div><div class="py-4"><p class="text-gray-600">tests\unit\test_tca_analyzer.py (Line 507:17 - Line 519:47), tests\unit\test_tca_analyzer.py (Line 173:15 - Line 185:8)</p><button class="bg-gray-500 text-white px-1 py-0.5 text-xs rounded focus:outline-none ml-2" id="expandBtn14" onclick="toggleCodeBlock('cloneGroup14', 'expandBtn14', 'collapseBtn14')">Show code</button><button class="bg-gray-500 text-white px-1 py-0.5 text-xs rounded focus:outline-none ml-2 hidden" id="collapseBtn14" onclick="toggleCodeBlock('cloneGroup14', 'expandBtn14', 'collapseBtn14')">Hide code</button><pre class="bg-gray-100 border border-gray-200 p-4 rounded mt-2 hidden" id="cloneGroup14"><code class="language-python text-sm text-gray-800">,
            symbol='BTCUSDT',
            side='BUY',
            target_qty=100.0,
            fills=fills,
            arrival_ts_ns=int(time.time_ns()),
            decision_ts_ns=int(time.time_ns()) - 1000000,
            arrival_price=100.0,
            arrival_spread_bps=10.0,
            latency_ms=1.0
        )

        # Mock market data with different mid vs micro</code></pre></div><div class="py-4"><p class="text-gray-600">tests\unit\test_tca_analyzer.py (Line 601:13 - Line 615:42), tests\unit\test_tca_analyzer.py (Line 173:15 - Line 187:25)</p><button class="bg-gray-500 text-white px-1 py-0.5 text-xs rounded focus:outline-none ml-2" id="expandBtn15" onclick="toggleCodeBlock('cloneGroup15', 'expandBtn15', 'collapseBtn15')">Show code</button><button class="bg-gray-500 text-white px-1 py-0.5 text-xs rounded focus:outline-none ml-2 hidden" id="collapseBtn15" onclick="toggleCodeBlock('cloneGroup15', 'expandBtn15', 'collapseBtn15')">Hide code</button><pre class="bg-gray-100 border border-gray-200 p-4 rounded mt-2 hidden" id="cloneGroup15"><code class="language-python text-sm text-gray-800">,
            symbol='BTCUSDT',
            side='BUY',
            target_qty=100.0,
            fills=fills,
            arrival_ts_ns=int(time.time_ns()),
            decision_ts_ns=int(time.time_ns()) - 1000000,
            arrival_price=100.0,
            arrival_spread_bps=10.0,
            latency_ms=1.0
        )

        metrics = analyzer.analyze_order(execution, sample_market_data)

        # Should calculate average queue position</code></pre></div><div class="py-4"><p class="text-gray-600">tests\unit\test_sim_local_sink_coverage.py (Line 10:1 - Line 18:8), tests\unit\test_sim_local_tca_and_determinism.py (Line 3:1 - Line 11:2)</p><button class="bg-gray-500 text-white px-1 py-0.5 text-xs rounded focus:outline-none ml-2" id="expandBtn16" onclick="toggleCodeBlock('cloneGroup16', 'expandBtn16', 'collapseBtn16')">Show code</button><button class="bg-gray-500 text-white px-1 py-0.5 text-xs rounded focus:outline-none ml-2 hidden" id="collapseBtn16" onclick="toggleCodeBlock('cloneGroup16', 'expandBtn16', 'collapseBtn16')">Hide code</button><pre class="bg-gray-100 border border-gray-200 p-4 rounded mt-2 hidden" id="cloneGroup16"><code class="language-python text-sm text-gray-800">from core.execution.sim_local_sink import SimLocalSink


def make_market(bid=99.0, ask=101.0, bid_qty=10.0, ask_qty=10.0):
    return {
        'best_bid': bid,
        'best_ask': ask,
        'liquidity': {'bid': bid_qty, 'ask': ask_qty},
        'depth'</code></pre></div><div class="py-4"><p class="text-gray-600">tests\unit\test_sim_local_basic.py (Line 5:1 - Line 18:4), tests\unit\test_sim_local_tca_and_determinism.py (Line 3:1 - Line 23:6)</p><button class="bg-gray-500 text-white px-1 py-0.5 text-xs rounded focus:outline-none ml-2" id="expandBtn17" onclick="toggleCodeBlock('cloneGroup17', 'expandBtn17', 'collapseBtn17')">Show code</button><button class="bg-gray-500 text-white px-1 py-0.5 text-xs rounded focus:outline-none ml-2 hidden" id="collapseBtn17" onclick="toggleCodeBlock('cloneGroup17', 'expandBtn17', 'collapseBtn17')">Hide code</button><pre class="bg-gray-100 border border-gray-200 p-4 rounded mt-2 hidden" id="cloneGroup17"><code class="language-python text-sm text-gray-800">from core.execution.sim_local_sink import SimLocalSink


def make_market(bid=99.0, ask=101.0, bid_qty=10.0, ask_qty=10.0):
    return {
        'best_bid': bid,
        'best_ask': ask,
        'liquidity': {'bid': bid_qty, 'ask': ask_qty},
        'depth': {'at_price': {}, 'levels_sum': {}},
        'traded_since_last': {},
    }


def</code></pre></div><div class="py-4"><p class="text-gray-600">tests\unit\test_shadow_broker_old.py (Line 83:9 - Line 104:25), tests\unit\test_shadow_broker_old.py (Line 39:9 - Line 60:17)</p><button class="bg-gray-500 text-white px-1 py-0.5 text-xs rounded focus:outline-none ml-2" id="expandBtn18" onclick="toggleCodeBlock('cloneGroup18', 'expandBtn18', 'collapseBtn18')">Show code</button><button class="bg-gray-500 text-white px-1 py-0.5 text-xs rounded focus:outline-none ml-2 hidden" id="collapseBtn18" onclick="toggleCodeBlock('cloneGroup18', 'expandBtn18', 'collapseBtn18')">Hide code</button><pre class="bg-gray-100 border border-gray-200 p-4 rounded mt-2 hidden" id="cloneGroup18"><code class="language-python text-sm text-gray-800">@patch('core.env_config.load_binance_cfg')
        def test_inner(mock_load_cfg):
            mock_cfg = Mock()
            mock_cfg.base_url = &quot;https://api.binance.com&quot;
            mock_load_cfg.return_value = mock_cfg

            broker = ShadowBroker(symbols=[&quot;BTCUSDT&quot;])

            # Mock filters
            broker.filters = {
                &quot;BTCUSDT&quot;: BinanceFilters(
                    lot_size_min_qty=Decimal(&quot;0.001&quot;),
                    lot_size_max_qty=Decimal(&quot;1000&quot;),
                    lot_size_step_size=Decimal(&quot;0.001&quot;),
                    price_filter_min_price=Decimal(&quot;0.01&quot;),
                    price_filter_max_price=Decimal(&quot;100000&quot;),
                    price_filter_tick_size=Decimal(&quot;0.01&quot;),
                    min_notional=Decimal(&quot;10.0&quot;)
                )
            }

            # Quantity below minimum</code></pre></div><div class="py-4"><p class="text-gray-600">tests\unit\test_shadow_broker_old.py (Line 115:9 - Line 136:25), tests\unit\test_shadow_broker_old.py (Line 39:9 - Line 60:17)</p><button class="bg-gray-500 text-white px-1 py-0.5 text-xs rounded focus:outline-none ml-2" id="expandBtn19" onclick="toggleCodeBlock('cloneGroup19', 'expandBtn19', 'collapseBtn19')">Show code</button><button class="bg-gray-500 text-white px-1 py-0.5 text-xs rounded focus:outline-none ml-2 hidden" id="collapseBtn19" onclick="toggleCodeBlock('cloneGroup19', 'expandBtn19', 'collapseBtn19')">Hide code</button><pre class="bg-gray-100 border border-gray-200 p-4 rounded mt-2 hidden" id="cloneGroup19"><code class="language-python text-sm text-gray-800">@patch('core.env_config.load_binance_cfg')
        def test_inner(mock_load_cfg):
            mock_cfg = Mock()
            mock_cfg.base_url = &quot;https://api.binance.com&quot;
            mock_load_cfg.return_value = mock_cfg

            broker = ShadowBroker(symbols=[&quot;BTCUSDT&quot;])

            # Mock filters
            broker.filters = {
                &quot;BTCUSDT&quot;: BinanceFilters(
                    lot_size_min_qty=Decimal(&quot;0.001&quot;),
                    lot_size_max_qty=Decimal(&quot;1000&quot;),
                    lot_size_step_size=Decimal(&quot;0.001&quot;),
                    price_filter_min_price=Decimal(&quot;0.01&quot;),
                    price_filter_max_price=Decimal(&quot;100000&quot;),
                    price_filter_tick_size=Decimal(&quot;0.01&quot;),
                    min_notional=Decimal(&quot;10.0&quot;)
                )
            }

            # Quantity above maximum</code></pre></div><div class="py-4"><p class="text-gray-600">tests\unit\test_shadow_broker_old.py (Line 178:9 - Line 198:14), tests\unit\test_shadow_broker_old.py (Line 147:9 - Line 60:17)</p><button class="bg-gray-500 text-white px-1 py-0.5 text-xs rounded focus:outline-none ml-2" id="expandBtn20" onclick="toggleCodeBlock('cloneGroup20', 'expandBtn20', 'collapseBtn20')">Show code</button><button class="bg-gray-500 text-white px-1 py-0.5 text-xs rounded focus:outline-none ml-2 hidden" id="collapseBtn20" onclick="toggleCodeBlock('cloneGroup20', 'expandBtn20', 'collapseBtn20')">Hide code</button><pre class="bg-gray-100 border border-gray-200 p-4 rounded mt-2 hidden" id="cloneGroup20"><code class="language-python text-sm text-gray-800">@patch('core.env_config.load_binance_cfg')
        @patch.object(ShadowBroker, '_fetch_exchange_info')
        def test_inner(mock_fetch, mock_load_cfg):
            mock_cfg = Mock()
            mock_cfg.base_url = &quot;https://api.binance.com&quot;
            mock_load_cfg.return_value = mock_cfg

            broker = ShadowBroker(symbols=[&quot;BTCUSDT&quot;])

            # Mock filters
            broker.filters = {
                &quot;BTCUSDT&quot;: BinanceFilters(
                    lot_size_min_qty=Decimal(&quot;0.001&quot;),
                    lot_size_max_qty=Decimal(&quot;1000&quot;),
                    lot_size_step_size=Decimal(&quot;0.001&quot;),
                    price_filter_min_price=Decimal(&quot;0.01&quot;),
                    price_filter_max_price=Decimal(&quot;100000&quot;),
                    price_filter_tick_size=Decimal(&quot;0.01&quot;),
                    min_notional=Decimal(&quot;10.0&quot;)
                )
            }            # Valid price</code></pre></div><div class="py-4"><p class="text-gray-600">tests\unit\test_shadow_broker_old.py (Line 221:9 - Line 242:22), tests\unit\test_shadow_broker_old.py (Line 39:9 - Line 60:17)</p><button class="bg-gray-500 text-white px-1 py-0.5 text-xs rounded focus:outline-none ml-2" id="expandBtn21" onclick="toggleCodeBlock('cloneGroup21', 'expandBtn21', 'collapseBtn21')">Show code</button><button class="bg-gray-500 text-white px-1 py-0.5 text-xs rounded focus:outline-none ml-2 hidden" id="collapseBtn21" onclick="toggleCodeBlock('cloneGroup21', 'expandBtn21', 'collapseBtn21')">Hide code</button><pre class="bg-gray-100 border border-gray-200 p-4 rounded mt-2 hidden" id="cloneGroup21"><code class="language-python text-sm text-gray-800">@patch('core.env_config.load_binance_cfg')
        def test_inner(mock_load_cfg):
            mock_cfg = Mock()
            mock_cfg.base_url = &quot;https://api.binance.com&quot;
            mock_load_cfg.return_value = mock_cfg

            broker = ShadowBroker(symbols=[&quot;BTCUSDT&quot;])

            # Mock filters
            broker.filters = {
                &quot;BTCUSDT&quot;: BinanceFilters(
                    lot_size_min_qty=Decimal(&quot;0.001&quot;),
                    lot_size_max_qty=Decimal(&quot;1000&quot;),
                    lot_size_step_size=Decimal(&quot;0.001&quot;),
                    price_filter_min_price=Decimal(&quot;0.01&quot;),
                    price_filter_max_price=Decimal(&quot;100000&quot;),
                    price_filter_tick_size=Decimal(&quot;0.01&quot;),
                    min_notional=Decimal(&quot;10.0&quot;)
                )
            }

            # Price below minimum</code></pre></div><div class="py-4"><p class="text-gray-600">tests\unit\test_shadow_broker_old.py (Line 253:9 - Line 274:22), tests\unit\test_shadow_broker_old.py (Line 39:9 - Line 60:17)</p><button class="bg-gray-500 text-white px-1 py-0.5 text-xs rounded focus:outline-none ml-2" id="expandBtn22" onclick="toggleCodeBlock('cloneGroup22', 'expandBtn22', 'collapseBtn22')">Show code</button><button class="bg-gray-500 text-white px-1 py-0.5 text-xs rounded focus:outline-none ml-2 hidden" id="collapseBtn22" onclick="toggleCodeBlock('cloneGroup22', 'expandBtn22', 'collapseBtn22')">Hide code</button><pre class="bg-gray-100 border border-gray-200 p-4 rounded mt-2 hidden" id="cloneGroup22"><code class="language-python text-sm text-gray-800">@patch('core.env_config.load_binance_cfg')
        def test_inner(mock_load_cfg):
            mock_cfg = Mock()
            mock_cfg.base_url = &quot;https://api.binance.com&quot;
            mock_load_cfg.return_value = mock_cfg

            broker = ShadowBroker(symbols=[&quot;BTCUSDT&quot;])

            # Mock filters
            broker.filters = {
                &quot;BTCUSDT&quot;: BinanceFilters(
                    lot_size_min_qty=Decimal(&quot;0.001&quot;),
                    lot_size_max_qty=Decimal(&quot;1000&quot;),
                    lot_size_step_size=Decimal(&quot;0.001&quot;),
                    price_filter_min_price=Decimal(&quot;0.01&quot;),
                    price_filter_max_price=Decimal(&quot;100000&quot;),
                    price_filter_tick_size=Decimal(&quot;0.01&quot;),
                    min_notional=Decimal(&quot;10.0&quot;)
                )
            }

            # Price above maximum</code></pre></div><div class="py-4"><p class="text-gray-600">tests\unit\test_shadow_broker_old.py (Line 285:9 - Line 301:8), tests\unit\test_shadow_broker_old.py (Line 147:9 - Line 54:9)</p><button class="bg-gray-500 text-white px-1 py-0.5 text-xs rounded focus:outline-none ml-2" id="expandBtn23" onclick="toggleCodeBlock('cloneGroup23', 'expandBtn23', 'collapseBtn23')">Show code</button><button class="bg-gray-500 text-white px-1 py-0.5 text-xs rounded focus:outline-none ml-2 hidden" id="collapseBtn23" onclick="toggleCodeBlock('cloneGroup23', 'expandBtn23', 'collapseBtn23')">Hide code</button><pre class="bg-gray-100 border border-gray-200 p-4 rounded mt-2 hidden" id="cloneGroup23"><code class="language-python text-sm text-gray-800">@patch('core.env_config.load_binance_cfg')
        @patch.object(ShadowBroker, '_fetch_exchange_info')
        def test_inner(mock_fetch, mock_load_cfg):
            mock_cfg = Mock()
            mock_cfg.base_url = &quot;https://api.binance.com&quot;
            mock_load_cfg.return_value = mock_cfg

            broker = ShadowBroker(symbols=[&quot;BTCUSDT&quot;])

            # Mock filters
            broker.filters = {
                &quot;BTCUSDT&quot;: BinanceFilters(
                    lot_size_min_qty=Decimal(&quot;0.001&quot;),
                    lot_size_max_qty=Decimal(&quot;1000&quot;),
                    lot_size_step_size=Decimal(&quot;0.001&quot;),
                    price_filter_min_price=Decimal(&quot;0.01&quot;),
                    price_filter_max_price=Decimal(&quot;49.99&quot;</code></pre></div><div class="py-4"><p class="text-gray-600">tests\unit\test_shadow_broker_old.py (Line 316:9 - Line 337:44), tests\unit\test_shadow_broker_old.py (Line 39:9 - Line 60:17)</p><button class="bg-gray-500 text-white px-1 py-0.5 text-xs rounded focus:outline-none ml-2" id="expandBtn24" onclick="toggleCodeBlock('cloneGroup24', 'expandBtn24', 'collapseBtn24')">Show code</button><button class="bg-gray-500 text-white px-1 py-0.5 text-xs rounded focus:outline-none ml-2 hidden" id="collapseBtn24" onclick="toggleCodeBlock('cloneGroup24', 'expandBtn24', 'collapseBtn24')">Hide code</button><pre class="bg-gray-100 border border-gray-200 p-4 rounded mt-2 hidden" id="cloneGroup24"><code class="language-python text-sm text-gray-800">@patch('core.env_config.load_binance_cfg')
        def test_inner(mock_load_cfg):
            mock_cfg = Mock()
            mock_cfg.base_url = &quot;https://api.binance.com&quot;
            mock_load_cfg.return_value = mock_cfg

            broker = ShadowBroker(symbols=[&quot;BTCUSDT&quot;])

            # Mock filters
            broker.filters = {
                &quot;BTCUSDT&quot;: BinanceFilters(
                    lot_size_min_qty=Decimal(&quot;0.001&quot;),
                    lot_size_max_qty=Decimal(&quot;1000&quot;),
                    lot_size_step_size=Decimal(&quot;0.001&quot;),
                    price_filter_min_price=Decimal(&quot;0.01&quot;),
                    price_filter_max_price=Decimal(&quot;100000&quot;),
                    price_filter_tick_size=Decimal(&quot;0.01&quot;),
                    min_notional=Decimal(&quot;10.0&quot;)
                )
            }

            # Valid notional (1.0 * 15.0 = 15.0 &gt; 10.0)</code></pre></div><div class="py-4"><p class="text-gray-600">tests\unit\test_shadow_broker_old.py (Line 348:9 - Line 369:47), tests\unit\test_shadow_broker_old.py (Line 39:9 - Line 60:17)</p><button class="bg-gray-500 text-white px-1 py-0.5 text-xs rounded focus:outline-none ml-2" id="expandBtn25" onclick="toggleCodeBlock('cloneGroup25', 'expandBtn25', 'collapseBtn25')">Show code</button><button class="bg-gray-500 text-white px-1 py-0.5 text-xs rounded focus:outline-none ml-2 hidden" id="collapseBtn25" onclick="toggleCodeBlock('cloneGroup25', 'expandBtn25', 'collapseBtn25')">Hide code</button><pre class="bg-gray-100 border border-gray-200 p-4 rounded mt-2 hidden" id="cloneGroup25"><code class="language-python text-sm text-gray-800">@patch('core.env_config.load_binance_cfg')
        def test_inner(mock_load_cfg):
            mock_cfg = Mock()
            mock_cfg.base_url = &quot;https://api.binance.com&quot;
            mock_load_cfg.return_value = mock_cfg

            broker = ShadowBroker(symbols=[&quot;BTCUSDT&quot;])

            # Mock filters
            broker.filters = {
                &quot;BTCUSDT&quot;: BinanceFilters(
                    lot_size_min_qty=Decimal(&quot;0.001&quot;),
                    lot_size_max_qty=Decimal(&quot;1000&quot;),
                    lot_size_step_size=Decimal(&quot;0.001&quot;),
                    price_filter_min_price=Decimal(&quot;0.01&quot;),
                    price_filter_max_price=Decimal(&quot;100000&quot;),
                    price_filter_tick_size=Decimal(&quot;0.01&quot;),
                    min_notional=Decimal(&quot;10.0&quot;)
                )
            }

            # Notional too small (0.5 * 15.0 = 7.5 &lt; 10.0)</code></pre></div><div class="py-4"><p class="text-gray-600">tests\unit\test_shadow_broker_old.py (Line 517:9 - Line 534:70), tests\unit\test_shadow_broker_old.py (Line 43:13 - Line 60:17)</p><button class="bg-gray-500 text-white px-1 py-0.5 text-xs rounded focus:outline-none ml-2" id="expandBtn26" onclick="toggleCodeBlock('cloneGroup26', 'expandBtn26', 'collapseBtn26')">Show code</button><button class="bg-gray-500 text-white px-1 py-0.5 text-xs rounded focus:outline-none ml-2 hidden" id="collapseBtn26" onclick="toggleCodeBlock('cloneGroup26', 'expandBtn26', 'collapseBtn26')">Hide code</button><pre class="bg-gray-100 border border-gray-200 p-4 rounded mt-2 hidden" id="cloneGroup26"><code class="language-python text-sm text-gray-800">mock_load_cfg.return_value = mock_cfg

        broker = ShadowBroker(symbols=[&quot;BTCUSDT&quot;])

        # Mock filters
        broker.filters = {
            &quot;BTCUSDT&quot;: BinanceFilters(
                lot_size_min_qty=Decimal(&quot;0.001&quot;),
                lot_size_max_qty=Decimal(&quot;1000&quot;),
                lot_size_step_size=Decimal(&quot;0.001&quot;),
                price_filter_min_price=Decimal(&quot;0.01&quot;),
                price_filter_max_price=Decimal(&quot;100000&quot;),
                price_filter_tick_size=Decimal(&quot;0.01&quot;),
                min_notional=Decimal(&quot;10.0&quot;)
            )
        }

        # Use validate_and_round_order instead of non-existent validate_order</code></pre></div><div class="py-4"><p class="text-gray-600">tests\unit\test_shadow_broker_old.py (Line 526:8 - Line 536:7), tests\unit\test_shadow_broker_old.py (Line 494:10 - Line 504:6)</p><button class="bg-gray-500 text-white px-1 py-0.5 text-xs rounded focus:outline-none ml-2" id="expandBtn27" onclick="toggleCodeBlock('cloneGroup27', 'expandBtn27', 'collapseBtn27')">Show code</button><button class="bg-gray-500 text-white px-1 py-0.5 text-xs rounded focus:outline-none ml-2 hidden" id="collapseBtn27" onclick="toggleCodeBlock('cloneGroup27', 'expandBtn27', 'collapseBtn27')">Hide code</button><pre class="bg-gray-100 border border-gray-200 p-4 rounded mt-2 hidden" id="cloneGroup27"><code class="language-python text-sm text-gray-800">),
                price_filter_min_price=Decimal(&quot;0.01&quot;),
                price_filter_max_price=Decimal(&quot;100000&quot;),
                price_filter_tick_size=Decimal(&quot;0.01&quot;),
                min_notional=Decimal(&quot;10.0&quot;)
            )
        }

        # Use validate_and_round_order instead of non-existent validate_order
        is_valid, message, rounded_qty, rounded_price = broker.validate_and_round_order(
            &quot;BTCUSDT&quot;, &quot;BUY&quot;, &quot;LIMIT&quot;, 0.0005</code></pre></div><div class="py-4"><p class="text-gray-600">tests\unit\test_shadow_broker_old.py (Line 547:2 - Line 567:6), tests\unit\test_shadow_broker_old.py (Line 514:2 - Line 60:17)</p><button class="bg-gray-500 text-white px-1 py-0.5 text-xs rounded focus:outline-none ml-2" id="expandBtn28" onclick="toggleCodeBlock('cloneGroup28', 'expandBtn28', 'collapseBtn28')">Show code</button><button class="bg-gray-500 text-white px-1 py-0.5 text-xs rounded focus:outline-none ml-2 hidden" id="collapseBtn28" onclick="toggleCodeBlock('cloneGroup28', 'expandBtn28', 'collapseBtn28')">Hide code</button><pre class="bg-gray-100 border border-gray-200 p-4 rounded mt-2 hidden" id="cloneGroup28"><code class="language-python text-sm text-gray-800">= &quot;https://api.binance.com&quot;
        mock_cfg.api_key = &quot;test_key&quot;
        mock_cfg.api_secret = &quot;test_secret&quot;
        mock_load_cfg.return_value = mock_cfg

        broker = ShadowBroker(symbols=[&quot;BTCUSDT&quot;])

        # Mock filters
        broker.filters = {
            &quot;BTCUSDT&quot;: BinanceFilters(
                lot_size_min_qty=Decimal(&quot;0.001&quot;),
                lot_size_max_qty=Decimal(&quot;1000&quot;),
                lot_size_step_size=Decimal(&quot;0.001&quot;),
                price_filter_min_price=Decimal(&quot;0.01&quot;),
                price_filter_max_price=Decimal(&quot;100000&quot;),
                price_filter_tick_size=Decimal(&quot;0.01&quot;),
                min_notional=Decimal(&quot;10.0&quot;)
            )
        }

        order</code></pre></div><div class="py-4"><p class="text-gray-600">tests\unit\test_shadow_broker_old.py (Line 627:7 - Line 639:7), tests\unit\test_shadow_broker_old.py (Line 597:6 - Line 609:6)</p><button class="bg-gray-500 text-white px-1 py-0.5 text-xs rounded focus:outline-none ml-2" id="expandBtn29" onclick="toggleCodeBlock('cloneGroup29', 'expandBtn29', 'collapseBtn29')">Show code</button><button class="bg-gray-500 text-white px-1 py-0.5 text-xs rounded focus:outline-none ml-2 hidden" id="collapseBtn29" onclick="toggleCodeBlock('cloneGroup29', 'expandBtn29', 'collapseBtn29')">Hide code</button><pre class="bg-gray-100 border border-gray-200 p-4 rounded mt-2 hidden" id="cloneGroup29"><code class="language-python text-sm text-gray-800">,
            &quot;type&quot;: &quot;MARKET&quot;,
            &quot;quantity&quot;: &quot;0.001&quot;
        }

        # Use submit_order instead of non-existent simulate_fill
        result = broker.submit_order(
            order[&quot;symbol&quot;], order[&quot;side&quot;], order[&quot;type&quot;],
            float(order[&quot;quantity&quot;])
        )

        assert result[&quot;symbol&quot;] == &quot;BTCUSDT&quot;
        assert result[&quot;side&quot;] == &quot;SELL&quot;</code></pre></div><div class="py-4"><p class="text-gray-600">tests\unit\test_shadow_broker_old.py (Line 679:9 - Line 692:11), tests\unit\test_shadow_broker_old.py (Line 647:9 - Line 660:11)</p><button class="bg-gray-500 text-white px-1 py-0.5 text-xs rounded focus:outline-none ml-2" id="expandBtn30" onclick="toggleCodeBlock('cloneGroup30', 'expandBtn30', 'collapseBtn30')">Show code</button><button class="bg-gray-500 text-white px-1 py-0.5 text-xs rounded focus:outline-none ml-2 hidden" id="collapseBtn30" onclick="toggleCodeBlock('cloneGroup30', 'expandBtn30', 'collapseBtn30')">Hide code</button><pre class="bg-gray-100 border border-gray-200 p-4 rounded mt-2 hidden" id="cloneGroup30"><code class="language-python text-sm text-gray-800">mock_cfg = Mock()
        mock_cfg.spot_url = &quot;https://api.binance.com&quot;
        mock_cfg.api_key = &quot;test_key&quot;
        mock_cfg.api_secret = &quot;test_secret&quot;
        mock_load_cfg.return_value = mock_cfg

        broker = ShadowBroker(symbols=[&quot;BTCUSDT&quot;])

        order = {
            &quot;symbol&quot;: &quot;BTCUSDT&quot;,
            &quot;side&quot;: &quot;BUY&quot;,
            &quot;type&quot;: &quot;LIMIT&quot;,
            &quot;quantity&quot;: &quot;0.001&quot;,
            &quot;price&quot;: &quot;50000.00&quot;</code></pre></div><div class="py-4"><p class="text-gray-600">tests\unit\test_shadow_broker.py (Line 15:5 - Line 36:6), tests\unit\test_shadow_broker_old.py (Line 17:5 - Line 37:4)</p><button class="bg-gray-500 text-white px-1 py-0.5 text-xs rounded focus:outline-none ml-2" id="expandBtn31" onclick="toggleCodeBlock('cloneGroup31', 'expandBtn31', 'collapseBtn31')">Show code</button><button class="bg-gray-500 text-white px-1 py-0.5 text-xs rounded focus:outline-none ml-2 hidden" id="collapseBtn31" onclick="toggleCodeBlock('cloneGroup31', 'expandBtn31', 'collapseBtn31')">Hide code</button><pre class="bg-gray-100 border border-gray-200 p-4 rounded mt-2 hidden" id="cloneGroup31"><code class="language-python text-sm text-gray-800">def test_binance_filters_creation(self):
        &quot;&quot;&quot;Test valid BinanceFilters creation.&quot;&quot;&quot;
        filters = BinanceFilters(
            lot_size_min_qty=Decimal(&quot;0.00001&quot;),
            lot_size_max_qty=Decimal(&quot;100000&quot;),
            lot_size_step_size=Decimal(&quot;0.00001&quot;),
            price_filter_min_price=Decimal(&quot;0.01&quot;),
            price_filter_max_price=Decimal(&quot;1000000&quot;),
            price_filter_tick_size=Decimal(&quot;0.01&quot;),
            min_notional=Decimal(&quot;10.0&quot;)
        )

        assert filters.lot_size_min_qty == Decimal(&quot;0.00001&quot;)
        assert filters.lot_size_max_qty == Decimal(&quot;100000&quot;)
        assert filters.lot_size_step_size == Decimal(&quot;0.00001&quot;)
        assert filters.price_filter_min_price == Decimal(&quot;0.01&quot;)
        assert filters.price_filter_max_price == Decimal(&quot;1000000&quot;)
        assert filters.price_filter_tick_size == Decimal(&quot;0.01&quot;)
        assert filters.min_notional == Decimal(&quot;10.0&quot;)


class</code></pre></div><div class="py-4"><p class="text-gray-600">tests\unit\test_shadow_broker.py (Line 65:9 - Line 77:10), tests\unit\test_shadow_broker.py (Line 43:9 - Line 55:10)</p><button class="bg-gray-500 text-white px-1 py-0.5 text-xs rounded focus:outline-none ml-2" id="expandBtn32" onclick="toggleCodeBlock('cloneGroup32', 'expandBtn32', 'collapseBtn32')">Show code</button><button class="bg-gray-500 text-white px-1 py-0.5 text-xs rounded focus:outline-none ml-2 hidden" id="collapseBtn32" onclick="toggleCodeBlock('cloneGroup32', 'expandBtn32', 'collapseBtn32')">Hide code</button><pre class="bg-gray-100 border border-gray-200 p-4 rounded mt-2 hidden" id="cloneGroup32"><code class="language-python text-sm text-gray-800">mock_cfg = Mock()
        mock_cfg.base_url = &quot;https://api.binance.com&quot;
        mock_cfg.api_key = &quot;test_key&quot;
        mock_cfg.api_secret = &quot;test_secret&quot;
        mock_load_cfg.return_value = mock_cfg

        # Mock exchange info response
        mock_response = Mock()
        mock_response.ok = True
        mock_response.json.return_value = {&quot;symbols&quot;: []}
        mock_get.return_value = mock_response

        broker = ShadowBroker(symbols=[&quot;ETHUSDT&quot;</code></pre></div><div class="py-4"><p class="text-gray-600">tests\unit\test_shadow_broker.py (Line 94:9 - Line 121:8), tests\unit\test_shadow_broker_old.py (Line 412:9 - Line 440:33)</p><button class="bg-gray-500 text-white px-1 py-0.5 text-xs rounded focus:outline-none ml-2" id="expandBtn33" onclick="toggleCodeBlock('cloneGroup33', 'expandBtn33', 'collapseBtn33')">Show code</button><button class="bg-gray-500 text-white px-1 py-0.5 text-xs rounded focus:outline-none ml-2 hidden" id="collapseBtn33" onclick="toggleCodeBlock('cloneGroup33', 'expandBtn33', 'collapseBtn33')">Hide code</button><pre class="bg-gray-100 border border-gray-200 p-4 rounded mt-2 hidden" id="cloneGroup33"><code class="language-python text-sm text-gray-800">mock_response.json.return_value = {
            &quot;symbols&quot;: [{
                &quot;symbol&quot;: &quot;BTCUSDT&quot;,
                &quot;status&quot;: &quot;TRADING&quot;,
                &quot;filters&quot;: [
                    {
                        &quot;filterType&quot;: &quot;LOT_SIZE&quot;,
                        &quot;minQty&quot;: &quot;0.00001000&quot;,
                        &quot;maxQty&quot;: &quot;9000.00000000&quot;,
                        &quot;stepSize&quot;: &quot;0.00001000&quot;
                    },
                    {
                        &quot;filterType&quot;: &quot;PRICE_FILTER&quot;,
                        &quot;minPrice&quot;: &quot;0.01000000&quot;,
                        &quot;maxPrice&quot;: &quot;1000000.00000000&quot;,
                        &quot;tickSize&quot;: &quot;0.01000000&quot;
                    },
                    {
                        &quot;filterType&quot;: &quot;MIN_NOTIONAL&quot;,
                        &quot;minNotional&quot;: &quot;10.00000000&quot;
                    }
                ]
            }]
        }
        mock_get.return_value = mock_response

        broker = ShadowBroker(symbols=[&quot;BTCUSDT&quot;])
        filters</code></pre></div><div class="py-4"><p class="text-gray-600">tests\unit\test_shadow_broker.py (Line 169:9 - Line 183:8), tests\unit\test_shadow_broker.py (Line 133:9 - Line 147:10)</p><button class="bg-gray-500 text-white px-1 py-0.5 text-xs rounded focus:outline-none ml-2" id="expandBtn34" onclick="toggleCodeBlock('cloneGroup34', 'expandBtn34', 'collapseBtn34')">Show code</button><button class="bg-gray-500 text-white px-1 py-0.5 text-xs rounded focus:outline-none ml-2 hidden" id="collapseBtn34" onclick="toggleCodeBlock('cloneGroup34', 'expandBtn34', 'collapseBtn34')">Hide code</button><pre class="bg-gray-100 border border-gray-200 p-4 rounded mt-2 hidden" id="cloneGroup34"><code class="language-python text-sm text-gray-800">mock_cfg = Mock()
        mock_cfg.base_url = &quot;https://api.binance.com&quot;
        mock_load_cfg.return_value = mock_cfg

        # Mock exchange info response
        mock_response = Mock()
        mock_response.ok = True
        mock_response.json.return_value = {&quot;symbols&quot;: []}
        mock_get.return_value = mock_response

        broker = ShadowBroker(symbols=[&quot;BTCUSDT&quot;])

        # Set up test filters manually
        broker.filters[&quot;BTCUSDT&quot;] = BinanceFilters(
            lot_size_min_qty=Decimal(&quot;0.001&quot;</code></pre></div><div class="py-4"><p class="text-gray-600">tests\unit\test_shadow_broker.py (Line 182:2 - Line 192:26), tests\unit\test_shadow_broker_old.py (Line 49:2 - Line 58:2)</p><button class="bg-gray-500 text-white px-1 py-0.5 text-xs rounded focus:outline-none ml-2" id="expandBtn35" onclick="toggleCodeBlock('cloneGroup35', 'expandBtn35', 'collapseBtn35')">Show code</button><button class="bg-gray-500 text-white px-1 py-0.5 text-xs rounded focus:outline-none ml-2 hidden" id="collapseBtn35" onclick="toggleCodeBlock('cloneGroup35', 'expandBtn35', 'collapseBtn35')">Hide code</button><pre class="bg-gray-100 border border-gray-200 p-4 rounded mt-2 hidden" id="cloneGroup35"><code class="language-python text-sm text-gray-800">BinanceFilters(
            lot_size_min_qty=Decimal(&quot;0.001&quot;),
            lot_size_max_qty=Decimal(&quot;1000&quot;),
            lot_size_step_size=Decimal(&quot;0.001&quot;),
            price_filter_min_price=Decimal(&quot;0.01&quot;),
            price_filter_max_price=Decimal(&quot;100000&quot;),
            price_filter_tick_size=Decimal(&quot;0.01&quot;),
            min_notional=Decimal(&quot;10.0&quot;)
        )

        # Test quantity too small</code></pre></div><div class="py-4"><p class="text-gray-600">tests\unit\test_shadow_broker.py (Line 205:9 - Line 228:58), tests\unit\test_shadow_broker.py (Line 133:9 - Line 58:2)</p><button class="bg-gray-500 text-white px-1 py-0.5 text-xs rounded focus:outline-none ml-2" id="expandBtn36" onclick="toggleCodeBlock('cloneGroup36', 'expandBtn36', 'collapseBtn36')">Show code</button><button class="bg-gray-500 text-white px-1 py-0.5 text-xs rounded focus:outline-none ml-2 hidden" id="collapseBtn36" onclick="toggleCodeBlock('cloneGroup36', 'expandBtn36', 'collapseBtn36')">Hide code</button><pre class="bg-gray-100 border border-gray-200 p-4 rounded mt-2 hidden" id="cloneGroup36"><code class="language-python text-sm text-gray-800">mock_cfg = Mock()
        mock_cfg.base_url = &quot;https://api.binance.com&quot;
        mock_load_cfg.return_value = mock_cfg

        # Mock exchange info response
        mock_response = Mock()
        mock_response.ok = True
        mock_response.json.return_value = {&quot;symbols&quot;: []}
        mock_get.return_value = mock_response

        broker = ShadowBroker(symbols=[&quot;BTCUSDT&quot;])

        # Set up test filters manually
        broker.filters[&quot;BTCUSDT&quot;] = BinanceFilters(
            lot_size_min_qty=Decimal(&quot;0.001&quot;),
            lot_size_max_qty=Decimal(&quot;1000&quot;),
            lot_size_step_size=Decimal(&quot;0.001&quot;),
            price_filter_min_price=Decimal(&quot;0.01&quot;),
            price_filter_max_price=Decimal(&quot;100000&quot;),
            price_filter_tick_size=Decimal(&quot;0.01&quot;),
            min_notional=Decimal(&quot;10.0&quot;)
        )

        # Test insufficient notional (0.001 * 1.0 = 0.001 &lt; 10.0)</code></pre></div><div class="py-4"><p class="text-gray-600">tests\unit\test_shadow_broker.py (Line 240:9 - Line 250:2), tests\unit\test_shadow_broker.py (Line 133:9 - Line 143:2)</p><button class="bg-gray-500 text-white px-1 py-0.5 text-xs rounded focus:outline-none ml-2" id="expandBtn37" onclick="toggleCodeBlock('cloneGroup37', 'expandBtn37', 'collapseBtn37')">Show code</button><button class="bg-gray-500 text-white px-1 py-0.5 text-xs rounded focus:outline-none ml-2 hidden" id="collapseBtn37" onclick="toggleCodeBlock('cloneGroup37', 'expandBtn37', 'collapseBtn37')">Hide code</button><pre class="bg-gray-100 border border-gray-200 p-4 rounded mt-2 hidden" id="cloneGroup37"><code class="language-python text-sm text-gray-800">mock_cfg = Mock()
        mock_cfg.base_url = &quot;https://api.binance.com&quot;
        mock_load_cfg.return_value = mock_cfg

        # Mock exchange info response
        mock_response = Mock()
        mock_response.ok = True
        mock_response.json.return_value = {&quot;symbols&quot;: []}
        mock_get.return_value = mock_response

        broker = ShadowBroker(symbols=[&quot;BTCUSDT&quot;],</code></pre></div><div class="py-4"><p class="text-gray-600">tests\unit\test_shadow_broker.py (Line 250:4 - Line 263:7), tests\unit\test_shadow_broker.py (Line 179:2 - Line 58:2)</p><button class="bg-gray-500 text-white px-1 py-0.5 text-xs rounded focus:outline-none ml-2" id="expandBtn38" onclick="toggleCodeBlock('cloneGroup38', 'expandBtn38', 'collapseBtn38')">Show code</button><button class="bg-gray-500 text-white px-1 py-0.5 text-xs rounded focus:outline-none ml-2 hidden" id="collapseBtn38" onclick="toggleCodeBlock('cloneGroup38', 'expandBtn38', 'collapseBtn38')">Hide code</button><pre class="bg-gray-100 border border-gray-200 p-4 rounded mt-2 hidden" id="cloneGroup38"><code class="language-python text-sm text-gray-800">)

        # Set up test filters manually
        broker.filters[&quot;BTCUSDT&quot;] = BinanceFilters(
            lot_size_min_qty=Decimal(&quot;0.001&quot;),
            lot_size_max_qty=Decimal(&quot;1000&quot;),
            lot_size_step_size=Decimal(&quot;0.001&quot;),
            price_filter_min_price=Decimal(&quot;0.01&quot;),
            price_filter_max_price=Decimal(&quot;100000&quot;),
            price_filter_tick_size=Decimal(&quot;0.01&quot;),
            min_notional=Decimal(&quot;10.0&quot;)
        )

        result</code></pre></div><div class="py-4"><p class="text-gray-600">tests\unit\test_shadow_broker.py (Line 277:9 - Line 300:8), tests\unit\test_shadow_broker.py (Line 133:9 - Line 263:9)</p><button class="bg-gray-500 text-white px-1 py-0.5 text-xs rounded focus:outline-none ml-2" id="expandBtn39" onclick="toggleCodeBlock('cloneGroup39', 'expandBtn39', 'collapseBtn39')">Show code</button><button class="bg-gray-500 text-white px-1 py-0.5 text-xs rounded focus:outline-none ml-2 hidden" id="collapseBtn39" onclick="toggleCodeBlock('cloneGroup39', 'expandBtn39', 'collapseBtn39')">Hide code</button><pre class="bg-gray-100 border border-gray-200 p-4 rounded mt-2 hidden" id="cloneGroup39"><code class="language-python text-sm text-gray-800">mock_cfg = Mock()
        mock_cfg.base_url = &quot;https://api.binance.com&quot;
        mock_load_cfg.return_value = mock_cfg

        # Mock exchange info response
        mock_response = Mock()
        mock_response.ok = True
        mock_response.json.return_value = {&quot;symbols&quot;: []}
        mock_get.return_value = mock_response

        broker = ShadowBroker(symbols=[&quot;BTCUSDT&quot;])

        # Set up test filters manually
        broker.filters[&quot;BTCUSDT&quot;] = BinanceFilters(
            lot_size_min_qty=Decimal(&quot;0.001&quot;),
            lot_size_max_qty=Decimal(&quot;1000&quot;),
            lot_size_step_size=Decimal(&quot;0.001&quot;),
            price_filter_min_price=Decimal(&quot;0.01&quot;),
            price_filter_max_price=Decimal(&quot;100000&quot;),
            price_filter_tick_size=Decimal(&quot;0.01&quot;),
            min_notional=Decimal(&quot;10.0&quot;)
        )

        result = broker.submit_order(&quot;BTCUSDT&quot;, &quot;BUY&quot;, &quot;LIMIT&quot;</code></pre></div><div class="py-4"><p class="text-gray-600">tests\unit\test_shadow_broker.py (Line 313:9 - Line 336:37), tests\unit\test_shadow_broker.py (Line 133:9 - Line 58:2)</p><button class="bg-gray-500 text-white px-1 py-0.5 text-xs rounded focus:outline-none ml-2" id="expandBtn40" onclick="toggleCodeBlock('cloneGroup40', 'expandBtn40', 'collapseBtn40')">Show code</button><button class="bg-gray-500 text-white px-1 py-0.5 text-xs rounded focus:outline-none ml-2 hidden" id="collapseBtn40" onclick="toggleCodeBlock('cloneGroup40', 'expandBtn40', 'collapseBtn40')">Hide code</button><pre class="bg-gray-100 border border-gray-200 p-4 rounded mt-2 hidden" id="cloneGroup40"><code class="language-python text-sm text-gray-800">mock_cfg = Mock()
        mock_cfg.base_url = &quot;https://api.binance.com&quot;
        mock_load_cfg.return_value = mock_cfg

        # Mock exchange info response
        mock_response = Mock()
        mock_response.ok = True
        mock_response.json.return_value = {&quot;symbols&quot;: []}
        mock_get.return_value = mock_response

        broker = ShadowBroker(symbols=[&quot;BTCUSDT&quot;])

        # Set up test filters manually
        broker.filters[&quot;BTCUSDT&quot;] = BinanceFilters(
            lot_size_min_qty=Decimal(&quot;0.001&quot;),
            lot_size_max_qty=Decimal(&quot;1000&quot;),
            lot_size_step_size=Decimal(&quot;0.001&quot;),
            price_filter_min_price=Decimal(&quot;0.01&quot;),
            price_filter_max_price=Decimal(&quot;100000&quot;),
            price_filter_tick_size=Decimal(&quot;0.01&quot;),
            min_notional=Decimal(&quot;10.0&quot;)
        )

        # Submit order with invalid quantity</code></pre></div><div class="py-4"><p class="text-gray-600">tests\unit\test_shadow_broker.py (Line 354:48 - Line 376:48), tests\unit\test_shadow_broker.py (Line 40:48 - Line 62:48)</p><button class="bg-gray-500 text-white px-1 py-0.5 text-xs rounded focus:outline-none ml-2" id="expandBtn41" onclick="toggleCodeBlock('cloneGroup41', 'expandBtn41', 'collapseBtn41')">Show code</button><button class="bg-gray-500 text-white px-1 py-0.5 text-xs rounded focus:outline-none ml-2 hidden" id="collapseBtn41" onclick="toggleCodeBlock('cloneGroup41', 'expandBtn41', 'collapseBtn41')">Hide code</button><pre class="bg-gray-100 border border-gray-200 p-4 rounded mt-2 hidden" id="cloneGroup41"><code class="language-python text-sm text-gray-800">)
    def test_shadow_broker_initialization(self, mock_load_cfg, mock_get):
        &quot;&quot;&quot;Test ShadowBroker initialization with proper config loading.&quot;&quot;&quot;
        mock_cfg = Mock()
        mock_cfg.base_url = &quot;https://api.binance.com&quot;
        mock_cfg.api_key = &quot;test_key&quot;
        mock_cfg.api_secret = &quot;test_secret&quot;
        mock_load_cfg.return_value = mock_cfg

        # Mock exchange info response
        mock_response = Mock()
        mock_response.ok = True
        mock_response.json.return_value = {&quot;symbols&quot;: []}
        mock_get.return_value = mock_response

        broker = ShadowBroker(symbols=[&quot;BTCUSDT&quot;])

        assert &quot;BTCUSDT&quot; in broker.symbols
        assert broker.slippage_bps == 2.0
        mock_load_cfg.assert_called_once()

    @patch(&quot;requests.get&quot;)
    @patch('core.execution.shadow_broker.load_binance_cfg'</code></pre></div><div class="py-4"><p class="text-gray-600">tests\unit\test_shadow_broker.py (Line 376:48 - Line 397:48), tests\unit\test_shadow_broker.py (Line 62:48 - Line 83:15)</p><button class="bg-gray-500 text-white px-1 py-0.5 text-xs rounded focus:outline-none ml-2" id="expandBtn42" onclick="toggleCodeBlock('cloneGroup42', 'expandBtn42', 'collapseBtn42')">Show code</button><button class="bg-gray-500 text-white px-1 py-0.5 text-xs rounded focus:outline-none ml-2 hidden" id="collapseBtn42" onclick="toggleCodeBlock('cloneGroup42', 'expandBtn42', 'collapseBtn42')">Hide code</button><pre class="bg-gray-100 border border-gray-200 p-4 rounded mt-2 hidden" id="cloneGroup42"><code class="language-python text-sm text-gray-800">)
    def test_shadow_broker_with_custom_slippage(self, mock_load_cfg, mock_get):
        &quot;&quot;&quot;Test ShadowBroker initialization with custom slippage config.&quot;&quot;&quot;
        mock_cfg = Mock()
        mock_cfg.base_url = &quot;https://api.binance.com&quot;
        mock_cfg.api_key = &quot;test_key&quot;
        mock_cfg.api_secret = &quot;test_secret&quot;
        mock_load_cfg.return_value = mock_cfg

        # Mock exchange info response
        mock_response = Mock()
        mock_response.ok = True
        mock_response.json.return_value = {&quot;symbols&quot;: []}
        mock_get.return_value = mock_response

        broker = ShadowBroker(symbols=[&quot;ETHUSDT&quot;], slippage_bps=5.0)

        assert &quot;ETHUSDT&quot; in broker.symbols
        assert broker.slippage_bps == 5.0
        mock_load_cfg.assert_called_once()

    @patch(&quot;core.execution.shadow_broker.load_binance_cfg&quot;</code></pre></div><div class="py-4"><p class="text-gray-600">tests\unit\test_shadow_broker.py (Line 399:15 - Line 443:48), tests\unit\test_shadow_broker.py (Line 85:17 - Line 129:15)</p><button class="bg-gray-500 text-white px-1 py-0.5 text-xs rounded focus:outline-none ml-2" id="expandBtn43" onclick="toggleCodeBlock('cloneGroup43', 'expandBtn43', 'collapseBtn43')">Show code</button><button class="bg-gray-500 text-white px-1 py-0.5 text-xs rounded focus:outline-none ml-2 hidden" id="collapseBtn43" onclick="toggleCodeBlock('cloneGroup43', 'expandBtn43', 'collapseBtn43')">Hide code</button><pre class="bg-gray-100 border border-gray-200 p-4 rounded mt-2 hidden" id="cloneGroup43"><code class="language-python text-sm text-gray-800">(self, mock_load_cfg, mock_get):
        &quot;&quot;&quot;Test getting filters for symbol.&quot;&quot;&quot;
        mock_cfg = Mock()
        mock_cfg.base_url = &quot;https://api.binance.com&quot;
        mock_load_cfg.return_value = mock_cfg

        # Mock exchange info response
        mock_response = Mock()
        mock_response.ok = True
        mock_response.json.return_value = {
            &quot;symbols&quot;: [{
                &quot;symbol&quot;: &quot;BTCUSDT&quot;,
                &quot;status&quot;: &quot;TRADING&quot;,
                &quot;filters&quot;: [
                    {
                        &quot;filterType&quot;: &quot;LOT_SIZE&quot;,
                        &quot;minQty&quot;: &quot;0.00001000&quot;,
                        &quot;maxQty&quot;: &quot;9000.00000000&quot;,
                        &quot;stepSize&quot;: &quot;0.00001000&quot;
                    },
                    {
                        &quot;filterType&quot;: &quot;PRICE_FILTER&quot;,
                        &quot;minPrice&quot;: &quot;0.01000000&quot;,
                        &quot;maxPrice&quot;: &quot;1000000.00000000&quot;,
                        &quot;tickSize&quot;: &quot;0.01000000&quot;
                    },
                    {
                        &quot;filterType&quot;: &quot;MIN_NOTIONAL&quot;,
                        &quot;minNotional&quot;: &quot;10.00000000&quot;
                    }
                ]
            }]
        }
        mock_get.return_value = mock_response

        broker = ShadowBroker(symbols=[&quot;BTCUSDT&quot;])
        filters = broker.get_filters(&quot;BTCUSDT&quot;)

        assert filters is not None
        assert filters.lot_size_min_qty == Decimal(&quot;0.00001000&quot;)
        assert filters.lot_size_max_qty == Decimal(&quot;9000.00000000&quot;)
        assert filters.lot_size_step_size == Decimal(&quot;0.00001000&quot;)
        assert filters.min_notional == Decimal(&quot;10.00000000&quot;)

    @patch(&quot;core.execution.shadow_broker.load_binance_cfg&quot;</code></pre></div><div class="py-4"><p class="text-gray-600">tests\unit\test_shadow_broker.py (Line 445:15 - Line 479:48), tests\unit\test_shadow_broker.py (Line 131:36 - Line 165:15)</p><button class="bg-gray-500 text-white px-1 py-0.5 text-xs rounded focus:outline-none ml-2" id="expandBtn44" onclick="toggleCodeBlock('cloneGroup44', 'expandBtn44', 'collapseBtn44')">Show code</button><button class="bg-gray-500 text-white px-1 py-0.5 text-xs rounded focus:outline-none ml-2 hidden" id="collapseBtn44" onclick="toggleCodeBlock('cloneGroup44', 'expandBtn44', 'collapseBtn44')">Hide code</button><pre class="bg-gray-100 border border-gray-200 p-4 rounded mt-2 hidden" id="cloneGroup44"><code class="language-python text-sm text-gray-800">(self, mock_load_cfg, mock_get):
        &quot;&quot;&quot;Test successful order validation and rounding.&quot;&quot;&quot;
        mock_cfg = Mock()
        mock_cfg.base_url = &quot;https://api.binance.com&quot;
        mock_load_cfg.return_value = mock_cfg

        # Mock exchange info response
        mock_response = Mock()
        mock_response.ok = True
        mock_response.json.return_value = {&quot;symbols&quot;: []}
        mock_get.return_value = mock_response

        broker = ShadowBroker(symbols=[&quot;BTCUSDT&quot;])

        # Set up test filters manually
        broker.filters[&quot;BTCUSDT&quot;] = BinanceFilters(
            lot_size_min_qty=Decimal(&quot;0.00001&quot;),
            lot_size_max_qty=Decimal(&quot;9000&quot;),
            lot_size_step_size=Decimal(&quot;0.00001&quot;),
            price_filter_min_price=Decimal(&quot;0.01&quot;),
            price_filter_max_price=Decimal(&quot;1000000&quot;),
            price_filter_tick_size=Decimal(&quot;0.01&quot;),
            min_notional=Decimal(&quot;10.0&quot;)
        )

        is_valid, message, qty, price = broker.validate_and_round_order(
            &quot;BTCUSDT&quot;, &quot;BUY&quot;, &quot;LIMIT&quot;, 1.0, 50000.0
        )

        assert is_valid is True
        assert message == &quot;OK&quot;
        assert qty == 1.0
        assert price == 50000.0

    @patch(&quot;core.execution.shadow_broker.load_binance_cfg&quot;</code></pre></div><div class="py-4"><p class="text-gray-600">tests\unit\test_shadow_broker.py (Line 481:15 - Line 515:48), tests\unit\test_shadow_broker.py (Line 167:47 - Line 201:15)</p><button class="bg-gray-500 text-white px-1 py-0.5 text-xs rounded focus:outline-none ml-2" id="expandBtn45" onclick="toggleCodeBlock('cloneGroup45', 'expandBtn45', 'collapseBtn45')">Show code</button><button class="bg-gray-500 text-white px-1 py-0.5 text-xs rounded focus:outline-none ml-2 hidden" id="collapseBtn45" onclick="toggleCodeBlock('cloneGroup45', 'expandBtn45', 'collapseBtn45')">Hide code</button><pre class="bg-gray-100 border border-gray-200 p-4 rounded mt-2 hidden" id="cloneGroup45"><code class="language-python text-sm text-gray-800">(self, mock_load_cfg, mock_get):
        &quot;&quot;&quot;Test order validation with invalid quantity.&quot;&quot;&quot;
        mock_cfg = Mock()
        mock_cfg.base_url = &quot;https://api.binance.com&quot;
        mock_load_cfg.return_value = mock_cfg

        # Mock exchange info response
        mock_response = Mock()
        mock_response.ok = True
        mock_response.json.return_value = {&quot;symbols&quot;: []}
        mock_get.return_value = mock_response

        broker = ShadowBroker(symbols=[&quot;BTCUSDT&quot;])

        # Set up test filters manually
        broker.filters[&quot;BTCUSDT&quot;] = BinanceFilters(
            lot_size_min_qty=Decimal(&quot;0.001&quot;),
            lot_size_max_qty=Decimal(&quot;1000&quot;),
            lot_size_step_size=Decimal(&quot;0.001&quot;),
            price_filter_min_price=Decimal(&quot;0.01&quot;),
            price_filter_max_price=Decimal(&quot;100000&quot;),
            price_filter_tick_size=Decimal(&quot;0.01&quot;),
            min_notional=Decimal(&quot;10.0&quot;)
        )

        # Test quantity too small
        is_valid, message, qty, price = broker.validate_and_round_order(
            &quot;BTCUSDT&quot;, &quot;BUY&quot;, &quot;LIMIT&quot;, 0.0005, 50000.0
        )

        assert is_valid is False
        assert &quot;LOT_SIZE&quot; in message
        assert &quot;Quantity&quot; in message

    @patch(&quot;core.execution.shadow_broker.load_binance_cfg&quot;</code></pre></div><div class="py-4"><p class="text-gray-600">tests\unit\test_shadow_broker.py (Line 517:15 - Line 584:7), tests\unit\test_shadow_broker.py (Line 203:47 - Line 269:24)</p><button class="bg-gray-500 text-white px-1 py-0.5 text-xs rounded focus:outline-none ml-2" id="expandBtn46" onclick="toggleCodeBlock('cloneGroup46', 'expandBtn46', 'collapseBtn46')">Show code</button><button class="bg-gray-500 text-white px-1 py-0.5 text-xs rounded focus:outline-none ml-2 hidden" id="collapseBtn46" onclick="toggleCodeBlock('cloneGroup46', 'expandBtn46', 'collapseBtn46')">Hide code</button><pre class="bg-gray-100 border border-gray-200 p-4 rounded mt-2 hidden" id="cloneGroup46"><code class="language-python text-sm text-gray-800">(self, mock_load_cfg, mock_get):
        &quot;&quot;&quot;Test order validation with insufficient notional value.&quot;&quot;&quot;
        mock_cfg = Mock()
        mock_cfg.base_url = &quot;https://api.binance.com&quot;
        mock_load_cfg.return_value = mock_cfg

        # Mock exchange info response
        mock_response = Mock()
        mock_response.ok = True
        mock_response.json.return_value = {&quot;symbols&quot;: []}
        mock_get.return_value = mock_response

        broker = ShadowBroker(symbols=[&quot;BTCUSDT&quot;])

        # Set up test filters manually
        broker.filters[&quot;BTCUSDT&quot;] = BinanceFilters(
            lot_size_min_qty=Decimal(&quot;0.001&quot;),
            lot_size_max_qty=Decimal(&quot;1000&quot;),
            lot_size_step_size=Decimal(&quot;0.001&quot;),
            price_filter_min_price=Decimal(&quot;0.01&quot;),
            price_filter_max_price=Decimal(&quot;100000&quot;),
            price_filter_tick_size=Decimal(&quot;0.01&quot;),
            min_notional=Decimal(&quot;10.0&quot;)
        )

        # Test insufficient notional (0.001 * 1.0 = 0.001 &lt; 10.0)
        is_valid, message, qty, price = broker.validate_and_round_order(
            &quot;BTCUSDT&quot;, &quot;BUY&quot;, &quot;LIMIT&quot;, 0.001, 1.0
        )

        assert is_valid is False
        assert &quot;MIN_NOTIONAL&quot; in message

    @patch(&quot;requests.get&quot;)
    @patch(&quot;core.execution.shadow_broker.load_binance_cfg&quot;)
    def test_submit_order_market_buy(self, mock_load_cfg, mock_get):
        &quot;&quot;&quot;Test market buy order submission with slippage simulation.&quot;&quot;&quot;
        mock_cfg = Mock()
        mock_cfg.base_url = &quot;https://api.binance.com&quot;
        mock_load_cfg.return_value = mock_cfg

        # Mock exchange info response
        mock_response = Mock()
        mock_response.ok = True
        mock_response.json.return_value = {&quot;symbols&quot;: []}
        mock_get.return_value = mock_response

        broker = ShadowBroker(symbols=[&quot;BTCUSDT&quot;], slippage_bps=2.0)

        # Set up test filters manually
        broker.filters[&quot;BTCUSDT&quot;] = BinanceFilters(
            lot_size_min_qty=Decimal(&quot;0.001&quot;),
            lot_size_max_qty=Decimal(&quot;1000&quot;),
            lot_size_step_size=Decimal(&quot;0.001&quot;),
            price_filter_min_price=Decimal(&quot;0.01&quot;),
            price_filter_max_price=Decimal(&quot;100000&quot;),
            price_filter_tick_size=Decimal(&quot;0.01&quot;),
            min_notional=Decimal(&quot;10.0&quot;)
        )

        result = broker.submit_order(&quot;BTCUSDT&quot;, &quot;BUY&quot;, &quot;MARKET&quot;, 1.0)

        assert result[&quot;status&quot;] == &quot;FILLED&quot;
        assert result[&quot;symbol&quot;] == &quot;BTCUSDT&quot;
        assert result[&quot;side&quot;] == &quot;BUY&quot;
        assert result[&quot;type&quot;] == &quot;MARKET&quot;
        assert result[&quot;executedQty&quot;] == &quot;1.000&quot;
        assert</code></pre></div><div class="py-4"><p class="text-gray-600">tests\unit\test_shadow_broker.py (Line 584:9 - Line 621:7), tests\unit\test_shadow_broker.py (Line 270:9 - Line 306:24)</p><button class="bg-gray-500 text-white px-1 py-0.5 text-xs rounded focus:outline-none ml-2" id="expandBtn47" onclick="toggleCodeBlock('cloneGroup47', 'expandBtn47', 'collapseBtn47')">Show code</button><button class="bg-gray-500 text-white px-1 py-0.5 text-xs rounded focus:outline-none ml-2 hidden" id="collapseBtn47" onclick="toggleCodeBlock('cloneGroup47', 'expandBtn47', 'collapseBtn47')">Hide code</button><pre class="bg-gray-100 border border-gray-200 p-4 rounded mt-2 hidden" id="cloneGroup47"><code class="language-python text-sm text-gray-800">assert &quot;orderId&quot; in result
        assert &quot;fills&quot; in result

    @patch(&quot;requests.get&quot;)
    @patch(&quot;core.execution.shadow_broker.load_binance_cfg&quot;)
    def test_submit_order_limit_order(self, mock_load_cfg, mock_get):
        &quot;&quot;&quot;Test limit order submission at specified price.&quot;&quot;&quot;
        mock_cfg = Mock()
        mock_cfg.base_url = &quot;https://api.binance.com&quot;
        mock_load_cfg.return_value = mock_cfg

        # Mock exchange info response
        mock_response = Mock()
        mock_response.ok = True
        mock_response.json.return_value = {&quot;symbols&quot;: []}
        mock_get.return_value = mock_response

        broker = ShadowBroker(symbols=[&quot;BTCUSDT&quot;])

        # Set up test filters manually
        broker.filters[&quot;BTCUSDT&quot;] = BinanceFilters(
            lot_size_min_qty=Decimal(&quot;0.001&quot;),
            lot_size_max_qty=Decimal(&quot;1000&quot;),
            lot_size_step_size=Decimal(&quot;0.001&quot;),
            price_filter_min_price=Decimal(&quot;0.01&quot;),
            price_filter_max_price=Decimal(&quot;100000&quot;),
            price_filter_tick_size=Decimal(&quot;0.01&quot;),
            min_notional=Decimal(&quot;10.0&quot;)
        )

        result = broker.submit_order(&quot;BTCUSDT&quot;, &quot;BUY&quot;, &quot;LIMIT&quot;, 1.0, 50000.0)

        assert result[&quot;status&quot;] == &quot;FILLED&quot;
        assert result[&quot;symbol&quot;] == &quot;BTCUSDT&quot;
        assert result[&quot;side&quot;] == &quot;BUY&quot;
        assert result[&quot;type&quot;] == &quot;LIMIT&quot;
        assert result[&quot;executedQty&quot;] == &quot;1.000&quot;
        assert</code></pre></div><div class="py-4"><p class="text-gray-600">tests\unit\test_shadow_broker.py (Line 621:9 - Line 661:2), tests\unit\test_shadow_broker.py (Line 307:9 - Line 347:2)</p><button class="bg-gray-500 text-white px-1 py-0.5 text-xs rounded focus:outline-none ml-2" id="expandBtn48" onclick="toggleCodeBlock('cloneGroup48', 'expandBtn48', 'collapseBtn48')">Show code</button><button class="bg-gray-500 text-white px-1 py-0.5 text-xs rounded focus:outline-none ml-2 hidden" id="collapseBtn48" onclick="toggleCodeBlock('cloneGroup48', 'expandBtn48', 'collapseBtn48')">Hide code</button><pre class="bg-gray-100 border border-gray-200 p-4 rounded mt-2 hidden" id="cloneGroup48"><code class="language-python text-sm text-gray-800">assert float(result[&quot;fills&quot;][0][&quot;price&quot;]) == 50000.0

    @patch(&quot;requests.get&quot;)
    @patch(&quot;core.execution.shadow_broker.load_binance_cfg&quot;)
    def test_submit_order_validation_failure(self, mock_load_cfg, mock_get):
        &quot;&quot;&quot;Test order rejection due to validation failure.&quot;&quot;&quot;
        mock_cfg = Mock()
        mock_cfg.base_url = &quot;https://api.binance.com&quot;
        mock_load_cfg.return_value = mock_cfg

        # Mock exchange info response
        mock_response = Mock()
        mock_response.ok = True
        mock_response.json.return_value = {&quot;symbols&quot;: []}
        mock_get.return_value = mock_response

        broker = ShadowBroker(symbols=[&quot;BTCUSDT&quot;])

        # Set up test filters manually
        broker.filters[&quot;BTCUSDT&quot;] = BinanceFilters(
            lot_size_min_qty=Decimal(&quot;0.001&quot;),
            lot_size_max_qty=Decimal(&quot;1000&quot;),
            lot_size_step_size=Decimal(&quot;0.001&quot;),
            price_filter_min_price=Decimal(&quot;0.01&quot;),
            price_filter_max_price=Decimal(&quot;100000&quot;),
            price_filter_tick_size=Decimal(&quot;0.01&quot;),
            min_notional=Decimal(&quot;10.0&quot;)
        )

        # Submit order with invalid quantity
        result = broker.submit_order(&quot;BTCUSDT&quot;, &quot;BUY&quot;, &quot;LIMIT&quot;, 0.0005, 50000.0)

        # Fixed expected format for validation failure
        assert &quot;code&quot; in result
        assert result[&quot;code&quot;] == -1013
        assert &quot;Filter failure&quot; in result[&quot;msg&quot;]
        assert &quot;LOT_SIZE&quot; in result[&quot;msg&quot;]


if __name__ == &quot;__main__&quot;:
    unittest.main()</code></pre></div><div class="py-4"><p class="text-gray-600">tests\unit\test_run_live_aurora_complete.py (Line 245:9 - Line 251:4), tests\unit\test_run_live_aurora_complete.py (Line 222:9 - Line 227:4)</p><button class="bg-gray-500 text-white px-1 py-0.5 text-xs rounded focus:outline-none ml-2" id="expandBtn49" onclick="toggleCodeBlock('cloneGroup49', 'expandBtn49', 'collapseBtn49')">Show code</button><button class="bg-gray-500 text-white px-1 py-0.5 text-xs rounded focus:outline-none ml-2 hidden" id="collapseBtn49" onclick="toggleCodeBlock('cloneGroup49', 'expandBtn49', 'collapseBtn49')">Hide code</button><pre class="bg-gray-100 border border-gray-200 p-4 rounded mt-2 hidden" id="cloneGroup49"><code class="language-python text-sm text-gray-800">mock_adapter = Mock()
        mock_adapter.symbol = &quot;BTCUSDT&quot;
        mock_adapter.fetch_top_of_book.return_value = (100.0, 0.01, [(99.99, 1.0)], [(100.01, 1.0)], [])
        mock_create_adapter.return_value = mock_adapter

        with patch.dict(os.environ, {
            'AURORA_MAX_TICKS': '1'</code></pre></div><div class="py-4"><p class="text-gray-600">tests\unit\test_run_live_aurora_complete.py (Line 280:9 - Line 285:2), tests\unit\test_run_live_aurora_complete.py (Line 222:9 - Line 251:2)</p><button class="bg-gray-500 text-white px-1 py-0.5 text-xs rounded focus:outline-none ml-2" id="expandBtn50" onclick="toggleCodeBlock('cloneGroup50', 'expandBtn50', 'collapseBtn50')">Show code</button><button class="bg-gray-500 text-white px-1 py-0.5 text-xs rounded focus:outline-none ml-2 hidden" id="collapseBtn50" onclick="toggleCodeBlock('cloneGroup50', 'expandBtn50', 'collapseBtn50')">Hide code</button><pre class="bg-gray-100 border border-gray-200 p-4 rounded mt-2 hidden" id="cloneGroup50"><code class="language-python text-sm text-gray-800">mock_adapter = Mock()
        mock_adapter.symbol = &quot;BTCUSDT&quot;
        mock_adapter.fetch_top_of_book.return_value = (100.0, 0.01, [(99.99, 1.0)], [(100.01, 1.0)], [])
        mock_create_adapter.return_value = mock_adapter

        with patch.dict(os.environ, {'AURORA_MAX_TICKS': '1'}</code></pre></div><div class="py-4"><p class="text-gray-600">tests\unit\test_run_live_aurora_complete.py (Line 330:9 - Line 338:46), tests\unit\test_run_live_aurora_complete.py (Line 283:9 - Line 291:47)</p><button class="bg-gray-500 text-white px-1 py-0.5 text-xs rounded focus:outline-none ml-2" id="expandBtn51" onclick="toggleCodeBlock('cloneGroup51', 'expandBtn51', 'collapseBtn51')">Show code</button><button class="bg-gray-500 text-white px-1 py-0.5 text-xs rounded focus:outline-none ml-2 hidden" id="collapseBtn51" onclick="toggleCodeBlock('cloneGroup51', 'expandBtn51', 'collapseBtn51')">Hide code</button><pre class="bg-gray-100 border border-gray-200 p-4 rounded mt-2 hidden" id="cloneGroup51"><code class="language-python text-sm text-gray-800">mock_create_adapter.return_value = mock_adapter

        with patch.dict(os.environ, {'AURORA_MAX_TICKS': '1'}):
            with patch('skalp_bot.runner.run_live_aurora.AuroraGate') as mock_gate:
                mock_gate_instance = Mock()
                mock_gate_instance.check.return_value = {&quot;allow&quot;: True}
                mock_gate.return_value = mock_gate_instance

                with patch('skalp_bot.runner.run_live_aurora.time.sleep'</code></pre></div><div class="py-4"><p class="text-gray-600">tests\unit\test_run_live_aurora_complete.py (Line 352:13 - Line 358:46), tests\unit\test_run_live_aurora_complete.py (Line 205:9 - Line 211:46)</p><button class="bg-gray-500 text-white px-1 py-0.5 text-xs rounded focus:outline-none ml-2" id="expandBtn52" onclick="toggleCodeBlock('cloneGroup52', 'expandBtn52', 'collapseBtn52')">Show code</button><button class="bg-gray-500 text-white px-1 py-0.5 text-xs rounded focus:outline-none ml-2 hidden" id="collapseBtn52" onclick="toggleCodeBlock('cloneGroup52', 'expandBtn52', 'collapseBtn52')">Hide code</button><pre class="bg-gray-100 border border-gray-200 p-4 rounded mt-2 hidden" id="cloneGroup52"><code class="language-python text-sm text-gray-800">with patch.dict(os.environ, {'AURORA_MAX_TICKS': '1'}):
                with patch('skalp_bot.runner.run_live_aurora.create_adapter') as mock_create_adapter:
                    mock_adapter = Mock()
                    mock_adapter.fetch_top_of_book.return_value = (100.0, 0.01, [], [], [])
                    mock_create_adapter.return_value = mock_adapter

                    with patch('skalp_bot.runner.run_live_aurora.time.sleep'</code></pre></div><div class="py-4"><p class="text-gray-600">tests\unit\test_router_new.py (Line 180:5 - Line 200:29), tests\unit\test_router_new.py (Line 116:5 - Line 136:29)</p><button class="bg-gray-500 text-white px-1 py-0.5 text-xs rounded focus:outline-none ml-2" id="expandBtn53" onclick="toggleCodeBlock('cloneGroup53', 'expandBtn53', 'collapseBtn53')">Show code</button><button class="bg-gray-500 text-white px-1 py-0.5 text-xs rounded focus:outline-none ml-2 hidden" id="collapseBtn53" onclick="toggleCodeBlock('cloneGroup53', 'expandBtn53', 'collapseBtn53')">Hide code</button><pre class="bg-gray-100 border border-gray-200 p-4 rounded mt-2 hidden" id="cloneGroup53"><code class="language-python text-sm text-gray-800">def setup_method(self):
        &quot;&quot;&quot;Setup test fixtures.&quot;&quot;&quot;
        self.config = {
            &quot;execution&quot;: {
                &quot;edge_floor_bps&quot;: 1.0,
                &quot;router&quot;: {
                    &quot;horizon_ms&quot;: 1500,
                    &quot;p_min_fill&quot;: 0.25,
                    &quot;spread_deny_bps&quot;: 8.0,
                    &quot;maker_spread_ok_bps&quot;: 2.0,
                    &quot;switch_margin_bps&quot;: 0.0
                },
                &quot;sla&quot;: {
                    &quot;kappa_bps_per_ms&quot;: 0.01,
                    &quot;max_latency_ms&quot;: 250
                }
            }
        }
        self.router = Router(self.config)

    def test_decide_sla_latency_deny</code></pre></div><div class="py-4"><p class="text-gray-600">tests\unit\test_router_backup.py (Line 340:5 - Line 350:31), tests\unit\test_router_backup.py (Line 169:5 - Line 179:38)</p><button class="bg-gray-500 text-white px-1 py-0.5 text-xs rounded focus:outline-none ml-2" id="expandBtn54" onclick="toggleCodeBlock('cloneGroup54', 'expandBtn54', 'collapseBtn54')">Show code</button><button class="bg-gray-500 text-white px-1 py-0.5 text-xs rounded focus:outline-none ml-2 hidden" id="collapseBtn54" onclick="toggleCodeBlock('cloneGroup54', 'expandBtn54', 'collapseBtn54')">Hide code</button><pre class="bg-gray-100 border border-gray-200 p-4 rounded mt-2 hidden" id="cloneGroup54"><code class="language-python text-sm text-gray-800">def setup_method(self):
        &quot;&quot;&quot;Setup test fixtures.&quot;&quot;&quot;
        self.fees = Fees(maker_fee_bps=0.1, taker_fee_bps=0.5)
        self.sla = SLAGate(max_latency_ms=50.0, kappa_bps_per_ms=0.1, min_edge_after_bps=0.0)
        self.router = Router(
            slagate=self.sla,
            min_p_fill=0.5,
            fees=self.fees
        )

    def test_estimate_p_fill_no_hazard</code></pre></div><div class="py-4"><p class="text-gray-600">tests\unit\test_router_backup.py (Line 410:5 - Line 420:30), tests\unit\test_router_backup.py (Line 169:5 - Line 179:38)</p><button class="bg-gray-500 text-white px-1 py-0.5 text-xs rounded focus:outline-none ml-2" id="expandBtn55" onclick="toggleCodeBlock('cloneGroup55', 'expandBtn55', 'collapseBtn55')">Show code</button><button class="bg-gray-500 text-white px-1 py-0.5 text-xs rounded focus:outline-none ml-2 hidden" id="collapseBtn55" onclick="toggleCodeBlock('cloneGroup55', 'expandBtn55', 'collapseBtn55')">Hide code</button><pre class="bg-gray-100 border border-gray-200 p-4 rounded mt-2 hidden" id="cloneGroup55"><code class="language-python text-sm text-gray-800">def setup_method(self):
        &quot;&quot;&quot;Setup test fixtures.&quot;&quot;&quot;
        self.fees = Fees(maker_fee_bps=0.1, taker_fee_bps=0.5)
        self.sla = SLAGate(max_latency_ms=50.0, kappa_bps_per_ms=0.1, min_edge_after_bps=0.0)
        self.router = Router(
            slagate=self.sla,
            min_p_fill=0.5,
            fees=self.fees
        )

    def test_decide_creates_log_entry</code></pre></div><div class="py-4"><p class="text-gray-600">tests\unit\test_router_backup.py (Line 439:9 - Line 447:7), tests\unit\test_xai_decision_trail.py (Line 63:9 - Line 72:24)</p><button class="bg-gray-500 text-white px-1 py-0.5 text-xs rounded focus:outline-none ml-2" id="expandBtn56" onclick="toggleCodeBlock('cloneGroup56', 'expandBtn56', 'collapseBtn56')">Show code</button><button class="bg-gray-500 text-white px-1 py-0.5 text-xs rounded focus:outline-none ml-2 hidden" id="collapseBtn56" onclick="toggleCodeBlock('cloneGroup56', 'expandBtn56', 'collapseBtn56')">Hide code</button><pre class="bg-gray-100 border border-gray-200 p-4 rounded mt-2 hidden" id="cloneGroup56"><code class="language-python text-sm text-gray-800">assert hasattr(decision, 'e_maker_bps')
        assert hasattr(decision, 'e_taker_bps')
        assert hasattr(decision, 'p_fill')
        assert hasattr(decision, 'reason')
        assert hasattr(decision, 'maker_fee_bps')
        assert hasattr(decision, 'taker_fee_bps')
        assert hasattr(decision, 'net_e_maker_bps')
        assert hasattr(decision, 'net_e_taker_bps')
        assert</code></pre></div><div class="py-4"><p class="text-gray-600">tests\unit\test_router_backup.py (Line 453:5 - Line 463:32), tests\unit\test_router_backup.py (Line 169:5 - Line 179:38)</p><button class="bg-gray-500 text-white px-1 py-0.5 text-xs rounded focus:outline-none ml-2" id="expandBtn57" onclick="toggleCodeBlock('cloneGroup57', 'expandBtn57', 'collapseBtn57')">Show code</button><button class="bg-gray-500 text-white px-1 py-0.5 text-xs rounded focus:outline-none ml-2 hidden" id="collapseBtn57" onclick="toggleCodeBlock('cloneGroup57', 'expandBtn57', 'collapseBtn57')">Hide code</button><pre class="bg-gray-100 border border-gray-200 p-4 rounded mt-2 hidden" id="cloneGroup57"><code class="language-python text-sm text-gray-800">def setup_method(self):
        &quot;&quot;&quot;Setup test fixtures.&quot;&quot;&quot;
        self.fees = Fees(maker_fee_bps=0.1, taker_fee_bps=0.5)
        self.sla = SLAGate(max_latency_ms=50.0, kappa_bps_per_ms=0.1, min_edge_after_bps=0.0)
        self.router = Router(
            slagate=self.sla,
            min_p_fill=0.5,
            fees=self.fees
        )

    def test_decide_with_empty_features</code></pre></div><div class="py-4"><p class="text-gray-600">tests\unit\test_position_fsm_complete.py (Line 51:9 - Line 67:6), tests\unit\test_position_fsm_complete.py (Line 25:9 - Line 41:5)</p><button class="bg-gray-500 text-white px-1 py-0.5 text-xs rounded focus:outline-none ml-2" id="expandBtn58" onclick="toggleCodeBlock('cloneGroup58', 'expandBtn58', 'collapseBtn58')">Show code</button><button class="bg-gray-500 text-white px-1 py-0.5 text-xs rounded focus:outline-none ml-2 hidden" id="collapseBtn58" onclick="toggleCodeBlock('cloneGroup58', 'expandBtn58', 'collapseBtn58')">Hide code</button><pre class="bg-gray-100 border border-gray-200 p-4 rounded mt-2 hidden" id="cloneGroup58"><code class="language-python text-sm text-gray-800">position = PositionData(
            position_id=&quot;test_1&quot;,
            symbol=&quot;BTCUSDT&quot;,
            side=&quot;BUY&quot;,
            state=PositionState.FLAT,
            target_qty=0.001,
            current_qty=0.0,
            entry_price=None,

            exit_reason=None,
            created_ts=int(time.time()),
            last_update_ts=int(time.time()),
        )

        result = fsm.process_event(position, PositionEvent.EDGE_CHANGE)

        assert result.success is False</code></pre></div><div class="py-4"><p class="text-gray-600">tests\unit\test_position_fsm_complete.py (Line 72:9 - Line 87:30), tests\unit\test_position_fsm_complete.py (Line 24:9 - Line 39:7)</p><button class="bg-gray-500 text-white px-1 py-0.5 text-xs rounded focus:outline-none ml-2" id="expandBtn59" onclick="toggleCodeBlock('cloneGroup59', 'expandBtn59', 'collapseBtn59')">Show code</button><button class="bg-gray-500 text-white px-1 py-0.5 text-xs rounded focus:outline-none ml-2 hidden" id="collapseBtn59" onclick="toggleCodeBlock('cloneGroup59', 'expandBtn59', 'collapseBtn59')">Hide code</button><pre class="bg-gray-100 border border-gray-200 p-4 rounded mt-2 hidden" id="cloneGroup59"><code class="language-python text-sm text-gray-800">fsm = PositionFSM()
        position = PositionData(
            position_id=&quot;test_1&quot;,
            symbol=&quot;BTCUSDT&quot;,
            side=&quot;BUY&quot;,
            state=PositionState.FLAT,
            target_qty=0.001,
            current_qty=0.0,
            entry_price=None,

            exit_reason=None,
            created_ts=int(time.time()),
            last_update_ts=int(time.time()),
        )

        # Пробуємо неможливий перехід</code></pre></div><div class="py-4"><p class="text-gray-600">tests\unit\test_position_fsm_complete.py (Line 119:9 - Line 134:7), tests\unit\test_position_fsm_complete.py (Line 95:9 - Line 110:11)</p><button class="bg-gray-500 text-white px-1 py-0.5 text-xs rounded focus:outline-none ml-2" id="expandBtn60" onclick="toggleCodeBlock('cloneGroup60', 'expandBtn60', 'collapseBtn60')">Show code</button><button class="bg-gray-500 text-white px-1 py-0.5 text-xs rounded focus:outline-none ml-2 hidden" id="collapseBtn60" onclick="toggleCodeBlock('cloneGroup60', 'expandBtn60', 'collapseBtn60')">Hide code</button><pre class="bg-gray-100 border border-gray-200 p-4 rounded mt-2 hidden" id="cloneGroup60"><code class="language-python text-sm text-gray-800">fsm = PositionFSM()
        position = PositionData(
            position_id=&quot;test_1&quot;,
            symbol=&quot;BTCUSDT&quot;,
            side=&quot;BUY&quot;,
            state=PositionState.ENTRY_PENDING,
            target_qty=0.001,
            current_qty=0.0,
            entry_price=None,

            exit_reason=None,
            created_ts=int(time.time()),
            last_update_ts=int(time.time()),
        )

        result</code></pre></div><div class="py-4"><p class="text-gray-600">tests\unit\test_position_fsm_complete.py (Line 124:14 - Line 134:10), tests\unit\test_position_fsm_complete.py (Line 29:5 - Line 39:12)</p><button class="bg-gray-500 text-white px-1 py-0.5 text-xs rounded focus:outline-none ml-2" id="expandBtn61" onclick="toggleCodeBlock('cloneGroup61', 'expandBtn61', 'collapseBtn61')">Show code</button><button class="bg-gray-500 text-white px-1 py-0.5 text-xs rounded focus:outline-none ml-2 hidden" id="collapseBtn61" onclick="toggleCodeBlock('cloneGroup61', 'expandBtn61', 'collapseBtn61')">Hide code</button><pre class="bg-gray-100 border border-gray-200 p-4 rounded mt-2 hidden" id="cloneGroup61"><code class="language-python text-sm text-gray-800">,
            target_qty=0.001,
            current_qty=0.0,
            entry_price=None,

            exit_reason=None,
            created_ts=int(time.time()),
            last_update_ts=int(time.time()),
        )

        result = fsm.process_event(position, PositionEvent.RISK_DENY</code></pre></div><div class="py-4"><p class="text-gray-600">tests\unit\test_position_fsm_complete.py (Line 168:9 - Line 183:13), tests\unit\test_position_fsm_complete.py (Line 144:9 - Line 159:16)</p><button class="bg-gray-500 text-white px-1 py-0.5 text-xs rounded focus:outline-none ml-2" id="expandBtn62" onclick="toggleCodeBlock('cloneGroup62', 'expandBtn62', 'collapseBtn62')">Show code</button><button class="bg-gray-500 text-white px-1 py-0.5 text-xs rounded focus:outline-none ml-2 hidden" id="collapseBtn62" onclick="toggleCodeBlock('cloneGroup62', 'expandBtn62', 'collapseBtn62')">Hide code</button><pre class="bg-gray-100 border border-gray-200 p-4 rounded mt-2 hidden" id="cloneGroup62"><code class="language-python text-sm text-gray-800">fsm = PositionFSM()
        position = PositionData(
            position_id=&quot;test_1&quot;,
            symbol=&quot;BTCUSDT&quot;,
            side=&quot;BUY&quot;,
            state=PositionState.OPEN,
            target_qty=0.001,
            current_qty=0.001,
            entry_price=50000.0,

            exit_reason=None,
            created_ts=int(time.time()),
            last_update_ts=int(time.time()),
        )

        result = fsm.process_event(position, PositionEvent.SCALE_SIGNAL</code></pre></div><div class="py-4"><p class="text-gray-600">tests\unit\test_position_fsm_complete.py (Line 264:9 - Line 279:10), tests\unit\test_position_fsm_complete.py (Line 144:9 - Line 159:16)</p><button class="bg-gray-500 text-white px-1 py-0.5 text-xs rounded focus:outline-none ml-2" id="expandBtn63" onclick="toggleCodeBlock('cloneGroup63', 'expandBtn63', 'collapseBtn63')">Show code</button><button class="bg-gray-500 text-white px-1 py-0.5 text-xs rounded focus:outline-none ml-2 hidden" id="collapseBtn63" onclick="toggleCodeBlock('cloneGroup63', 'expandBtn63', 'collapseBtn63')">Hide code</button><pre class="bg-gray-100 border border-gray-200 p-4 rounded mt-2 hidden" id="cloneGroup63"><code class="language-python text-sm text-gray-800">fsm = PositionFSM()
        position = PositionData(
            position_id=&quot;test_1&quot;,
            symbol=&quot;BTCUSDT&quot;,
            side=&quot;BUY&quot;,
            state=PositionState.OPEN,
            target_qty=0.001,
            current_qty=0.001,
            entry_price=50000.0,

            exit_reason=None,
            created_ts=int(time.time()),
            last_update_ts=int(time.time()),
        )

        result = fsm.process_event(position, PositionEvent.TRAIL_HIT</code></pre></div><div class="py-4"><p class="text-gray-600">tests\unit\test_position_fsm_complete.py (Line 286:9 - Line 301:7), tests\unit\test_position_fsm_complete.py (Line 144:9 - Line 159:16)</p><button class="bg-gray-500 text-white px-1 py-0.5 text-xs rounded focus:outline-none ml-2" id="expandBtn64" onclick="toggleCodeBlock('cloneGroup64', 'expandBtn64', 'collapseBtn64')">Show code</button><button class="bg-gray-500 text-white px-1 py-0.5 text-xs rounded focus:outline-none ml-2 hidden" id="collapseBtn64" onclick="toggleCodeBlock('cloneGroup64', 'expandBtn64', 'collapseBtn64')">Hide code</button><pre class="bg-gray-100 border border-gray-200 p-4 rounded mt-2 hidden" id="cloneGroup64"><code class="language-python text-sm text-gray-800">fsm = PositionFSM()
        position = PositionData(
            position_id=&quot;test_1&quot;,
            symbol=&quot;BTCUSDT&quot;,
            side=&quot;BUY&quot;,
            state=PositionState.OPEN,
            target_qty=0.001,
            current_qty=0.001,
            entry_price=50000.0,

            exit_reason=None,
            created_ts=int(time.time()),
            last_update_ts=int(time.time()),
        )

        result = fsm.process_event(position, PositionEvent.TP_HIT</code></pre></div><div class="py-4"><p class="text-gray-600">tests\unit\test_position_fsm_complete.py (Line 308:9 - Line 323:12), tests\unit\test_position_fsm_complete.py (Line 95:9 - Line 39:12)</p><button class="bg-gray-500 text-white px-1 py-0.5 text-xs rounded focus:outline-none ml-2" id="expandBtn65" onclick="toggleCodeBlock('cloneGroup65', 'expandBtn65', 'collapseBtn65')">Show code</button><button class="bg-gray-500 text-white px-1 py-0.5 text-xs rounded focus:outline-none ml-2 hidden" id="collapseBtn65" onclick="toggleCodeBlock('cloneGroup65', 'expandBtn65', 'collapseBtn65')">Hide code</button><pre class="bg-gray-100 border border-gray-200 p-4 rounded mt-2 hidden" id="cloneGroup65"><code class="language-python text-sm text-gray-800">fsm = PositionFSM()
        position = PositionData(
            position_id=&quot;test_1&quot;,
            symbol=&quot;BTCUSDT&quot;,
            side=&quot;BUY&quot;,
            state=PositionState.ENTRY_PENDING,
            target_qty=0.001,
            current_qty=0.0,
            entry_price=None,

            exit_reason=None,
            created_ts=int(time.time()),
            last_update_ts=int(time.time()),
        )

        result = fsm.process_event(position, PositionEvent.TTL_EXPIRED</code></pre></div><div class="py-4"><p class="text-gray-600">tests\unit\test_position_fsm_complete.py (Line 330:9 - Line 345:16), tests\unit\test_position_fsm_complete.py (Line 95:9 - Line 39:12)</p><button class="bg-gray-500 text-white px-1 py-0.5 text-xs rounded focus:outline-none ml-2" id="expandBtn66" onclick="toggleCodeBlock('cloneGroup66', 'expandBtn66', 'collapseBtn66')">Show code</button><button class="bg-gray-500 text-white px-1 py-0.5 text-xs rounded focus:outline-none ml-2 hidden" id="collapseBtn66" onclick="toggleCodeBlock('cloneGroup66', 'expandBtn66', 'collapseBtn66')">Hide code</button><pre class="bg-gray-100 border border-gray-200 p-4 rounded mt-2 hidden" id="cloneGroup66"><code class="language-python text-sm text-gray-800">fsm = PositionFSM()
        position = PositionData(
            position_id=&quot;test_1&quot;,
            symbol=&quot;BTCUSDT&quot;,
            side=&quot;BUY&quot;,
            state=PositionState.ENTRY_PENDING,
            target_qty=0.001,
            current_qty=0.0,
            entry_price=None,

            exit_reason=None,
            created_ts=int(time.time()),
            last_update_ts=int(time.time()),
        )

        result = fsm.process_event(position, PositionEvent.EXCHANGE_REJECT</code></pre></div><div class="py-4"><p class="text-gray-600">tests\unit\test_position_fsm_complete.py (Line 352:9 - Line 366:11), tests\unit\test_position_fsm_complete.py (Line 24:9 - Line 39:7)</p><button class="bg-gray-500 text-white px-1 py-0.5 text-xs rounded focus:outline-none ml-2" id="expandBtn67" onclick="toggleCodeBlock('cloneGroup67', 'expandBtn67', 'collapseBtn67')">Show code</button><button class="bg-gray-500 text-white px-1 py-0.5 text-xs rounded focus:outline-none ml-2 hidden" id="collapseBtn67" onclick="toggleCodeBlock('cloneGroup67', 'expandBtn67', 'collapseBtn67')">Hide code</button><pre class="bg-gray-100 border border-gray-200 p-4 rounded mt-2 hidden" id="cloneGroup67"><code class="language-python text-sm text-gray-800">fsm = PositionFSM()
        position = PositionData(
            position_id=&quot;test_1&quot;,
            symbol=&quot;BTCUSDT&quot;,
            side=&quot;BUY&quot;,
            state=PositionState.FLAT,
            target_qty=0.001,
            current_qty=0.0,
            entry_price=None,
            exit_reason=None,
            created_ts=int(time.time()),
            last_update_ts=int(time.time()),
        )

        initial_ts</code></pre></div><div class="py-4"><p class="text-gray-600">tests\unit\test_position_fsm_complete.py (Line 403:9 - Line 418:46), tests\unit\test_position_fsm_complete.py (Line 95:9 - Line 110:11)</p><button class="bg-gray-500 text-white px-1 py-0.5 text-xs rounded focus:outline-none ml-2" id="expandBtn68" onclick="toggleCodeBlock('cloneGroup68', 'expandBtn68', 'collapseBtn68')">Show code</button><button class="bg-gray-500 text-white px-1 py-0.5 text-xs rounded focus:outline-none ml-2 hidden" id="collapseBtn68" onclick="toggleCodeBlock('cloneGroup68', 'expandBtn68', 'collapseBtn68')">Hide code</button><pre class="bg-gray-100 border border-gray-200 p-4 rounded mt-2 hidden" id="cloneGroup68"><code class="language-python text-sm text-gray-800">fsm = PositionFSM()
        position = PositionData(
            position_id=&quot;test_1&quot;,
            symbol=&quot;BTCUSDT&quot;,
            side=&quot;BUY&quot;,
            state=PositionState.ENTRY_PENDING,
            target_qty=0.001,
            current_qty=0.0,
            entry_price=None,

            exit_reason=None,
            created_ts=int(time.time()),
            last_update_ts=int(time.time()),
        )

        # Тест автоматичного встановлення exit_reason</code></pre></div><div class="py-4"><p class="text-gray-600">tests\unit\test_position_fsm_complete.py (Line 426:9 - Line 441:7), tests\unit\test_position_fsm_complete.py (Line 190:9 - Line 205:11)</p><button class="bg-gray-500 text-white px-1 py-0.5 text-xs rounded focus:outline-none ml-2" id="expandBtn69" onclick="toggleCodeBlock('cloneGroup69', 'expandBtn69', 'collapseBtn69')">Show code</button><button class="bg-gray-500 text-white px-1 py-0.5 text-xs rounded focus:outline-none ml-2 hidden" id="collapseBtn69" onclick="toggleCodeBlock('cloneGroup69', 'expandBtn69', 'collapseBtn69')">Hide code</button><pre class="bg-gray-100 border border-gray-200 p-4 rounded mt-2 hidden" id="cloneGroup69"><code class="language-python text-sm text-gray-800">fsm = PositionFSM()
        position = PositionData(
            position_id=&quot;test_1&quot;,
            symbol=&quot;BTCUSDT&quot;,
            side=&quot;BUY&quot;,
            state=PositionState.SCALE_IN_PENDING,
            target_qty=0.002,
            current_qty=0.001,
            entry_price=50000.0,

            exit_reason=None,
            created_ts=int(time.time()),
            last_update_ts=int(time.time()),
        )

        result</code></pre></div><div class="py-4"><p class="text-gray-600">tests\unit\test_position_fsm_complete.py (Line 434:8 - Line 444:5), tests\unit\test_position_fsm_complete.py (Line 127:5 - Line 137:5)</p><button class="bg-gray-500 text-white px-1 py-0.5 text-xs rounded focus:outline-none ml-2" id="expandBtn70" onclick="toggleCodeBlock('cloneGroup70', 'expandBtn70', 'collapseBtn70')">Show code</button><button class="bg-gray-500 text-white px-1 py-0.5 text-xs rounded focus:outline-none ml-2 hidden" id="collapseBtn70" onclick="toggleCodeBlock('cloneGroup70', 'expandBtn70', 'collapseBtn70')">Hide code</button><pre class="bg-gray-100 border border-gray-200 p-4 rounded mt-2 hidden" id="cloneGroup70"><code class="language-python text-sm text-gray-800">,

            exit_reason=None,
            created_ts=int(time.time()),
            last_update_ts=int(time.time()),
        )

        result = fsm.process_event(position, PositionEvent.RISK_DENY)

        assert result.success is True
        assert result.new_state == PositionState.OPEN</code></pre></div><div class="py-4"><p class="text-gray-600">tests\unit\test_pipeline.py (Line 89:13 - Line 101:5), tests\unit\test_pipeline.py (Line 65:13 - Line 77:6)</p><button class="bg-gray-500 text-white px-1 py-0.5 text-xs rounded focus:outline-none ml-2" id="expandBtn71" onclick="toggleCodeBlock('cloneGroup71', 'expandBtn71', 'collapseBtn71')">Show code</button><button class="bg-gray-500 text-white px-1 py-0.5 text-xs rounded focus:outline-none ml-2 hidden" id="collapseBtn71" onclick="toggleCodeBlock('cloneGroup71', 'expandBtn71', 'collapseBtn71')">Hide code</button><pre class="bg-gray-100 border border-gray-200 p-4 rounded mt-2 hidden" id="cloneGroup71"><code class="language-python text-sm text-gray-800">'score': 2.0,
            'a_bps': 1.0,
            'b_bps': 2.0,
            'slip_bps_est': 0.1,
            'spread_bps': 50.0
        }
        fees_bps = 0.1

        allow, reason, obs, risk_scale = pipeline.decide(
            account=account, order=order, market=market, fees_bps=fees_bps
        )

        assert allow is True</code></pre></div><div class="py-4"><p class="text-gray-600">tests\unit\test_pipeline.py (Line 113:13 - Line 128:4), tests\unit\test_pipeline.py (Line 65:13 - Line 103:7)</p><button class="bg-gray-500 text-white px-1 py-0.5 text-xs rounded focus:outline-none ml-2" id="expandBtn72" onclick="toggleCodeBlock('cloneGroup72', 'expandBtn72', 'collapseBtn72')">Show code</button><button class="bg-gray-500 text-white px-1 py-0.5 text-xs rounded focus:outline-none ml-2 hidden" id="collapseBtn72" onclick="toggleCodeBlock('cloneGroup72', 'expandBtn72', 'collapseBtn72')">Hide code</button><pre class="bg-gray-100 border border-gray-200 p-4 rounded mt-2 hidden" id="cloneGroup72"><code class="language-python text-sm text-gray-800">'score': 2.0,
            'a_bps': 1.0,
            'b_bps': 2.0,
            'slip_bps_est': 0.1,
            'spread_bps': 50.0
        }
        fees_bps = 0.1

        allow, reason, obs, risk_scale = pipeline.decide(
            account=account, order=order, market=market, fees_bps=fees_bps
        )

        assert allow is True
        assert reason == 'ok'

    def</code></pre></div><div class="py-4"><p class="text-gray-600">tests\unit\test_pipeline.py (Line 332:13 - Line 347:7), tests\unit\test_pipeline.py (Line 65:13 - Line 105:4)</p><button class="bg-gray-500 text-white px-1 py-0.5 text-xs rounded focus:outline-none ml-2" id="expandBtn73" onclick="toggleCodeBlock('cloneGroup73', 'expandBtn73', 'collapseBtn73')">Show code</button><button class="bg-gray-500 text-white px-1 py-0.5 text-xs rounded focus:outline-none ml-2 hidden" id="collapseBtn73" onclick="toggleCodeBlock('cloneGroup73', 'expandBtn73', 'collapseBtn73')">Hide code</button><pre class="bg-gray-100 border border-gray-200 p-4 rounded mt-2 hidden" id="cloneGroup73"><code class="language-python text-sm text-gray-800">'score': 2.0,
            'a_bps': 1.0,
            'b_bps': 2.0,
            'slip_bps_est': 0.1,
            'spread_bps': 50.0
        }
        fees_bps = 0.1

        allow, reason, obs, risk_scale = pipeline.decide(
            account=account, order=order, market=market, fees_bps=fees_bps
        )

        assert allow is True
        assert reason == 'ok'
        assert obs['gate_state'] == 'PASS'
        assert</code></pre></div><div class="py-4"><p class="text-gray-600">tests\unit\test_idempotency_store_basic.py (Line 29:1 - Line 56:2), tests\unit\test_idempotency_store_basic.py (Line 1:1 - Line 28:2)</p><button class="bg-gray-500 text-white px-1 py-0.5 text-xs rounded focus:outline-none ml-2" id="expandBtn74" onclick="toggleCodeBlock('cloneGroup74', 'expandBtn74', 'collapseBtn74')">Show code</button><button class="bg-gray-500 text-white px-1 py-0.5 text-xs rounded focus:outline-none ml-2 hidden" id="collapseBtn74" onclick="toggleCodeBlock('cloneGroup74', 'expandBtn74', 'collapseBtn74')">Hide code</button><pre class="bg-gray-100 border border-gray-200 p-4 rounded mt-2 hidden" id="cloneGroup74"><code class="language-python text-sm text-gray-800">from core.infra.idempotency_store import IdempotencyStore


def test_put_get_seen_and_sweep():
    # deterministic now_ns for testing
    now_ns = lambda: 1_000_000_000
    store = IdempotencyStore(ttl_sec=3600, now_ns_fn=now_ns)
    key = &quot;op-123&quot;
    assert not store.seen(key)
    store.put(key, {&quot;ok&quot;: True})
    assert store.seen(key)
    assert store.get(key) == {&quot;ok&quot;: True}
    # sweep should remove nothing for large ttl
    removed = store.sweep()
    assert removed == 0


def test_sweep_removes_expired():
    t = [1_000_000_000]
    now_ns = lambda: t[0]
    store = IdempotencyStore(ttl_sec=0.000001, now_ns_fn=now_ns)  # tiny ttl
    store.put(&quot;k&quot;, 1)
    assert store.seen(&quot;k&quot;)
    # advance time beyond ttl
    t[0] += int(1e9)
    removed = store.sweep()
    assert removed == 1
    assert not store.seen(&quot;k&quot;)</code></pre></div><div class="py-4"><p class="text-gray-600">tests\unit\test_env_config_guards.py (Line 183:9 - Line 201:11), tests\unit\test_env_config_guards.py (Line 160:9 - Line 178:6)</p><button class="bg-gray-500 text-white px-1 py-0.5 text-xs rounded focus:outline-none ml-2" id="expandBtn75" onclick="toggleCodeBlock('cloneGroup75', 'expandBtn75', 'collapseBtn75')">Show code</button><button class="bg-gray-500 text-white px-1 py-0.5 text-xs rounded focus:outline-none ml-2 hidden" id="collapseBtn75" onclick="toggleCodeBlock('cloneGroup75', 'expandBtn75', 'collapseBtn75')">Hide code</button><pre class="bg-gray-100 border border-gray-200 p-4 rounded mt-2 hidden" id="cloneGroup75"><code class="language-python text-sm text-gray-800"># Prevent dotenv from loading any external .env file
        mock_load_dotenv.return_value = None

        # Ensure no testnet variables are present
        testnet_vars = [
            'BINANCE_API_KEY_TESTNET', 'BINANCE_API_SECRET_TESTNET',
            'BINANCE_USDM_BASE_URL_TESTNET', 'BINANCE_USDM_WS_URL_TESTNET'
        ]
        for var in testnet_vars:
            if var in os.environ:
                del os.environ[var]

        with pytest.raises(RuntimeError, match=&quot;Missing live credentials&quot;):
            load_binance_cfg()

    @patch('core.env_config.load_dotenv')  # Mock dotenv loading
    @patch.dict(os.environ, {
        'BINANCE_ENV': 'live',
        'BINANCE_API_KEY_LIVE': 'live_key'</code></pre></div><div class="py-4"><p class="text-gray-600">tests\unit\test_circuit_breaker.py (Line 137:9 - Line 152:10), tests\unit\test_circuit_breaker.py (Line 103:9 - Line 118:11)</p><button class="bg-gray-500 text-white px-1 py-0.5 text-xs rounded focus:outline-none ml-2" id="expandBtn76" onclick="toggleCodeBlock('cloneGroup76', 'expandBtn76', 'collapseBtn76')">Show code</button><button class="bg-gray-500 text-white px-1 py-0.5 text-xs rounded focus:outline-none ml-2 hidden" id="collapseBtn76" onclick="toggleCodeBlock('cloneGroup76', 'expandBtn76', 'collapseBtn76')">Hide code</button><pre class="bg-gray-100 border border-gray-200 p-4 rounded mt-2 hidden" id="cloneGroup76"><code class="language-python text-sm text-gray-800">)
        breaker = ExchangeCircuitBreaker(config)

        # Set initial time
        mock_time.return_value = 1000.0

        # Trigger failures to open circuit
        for i in range(2):
            with pytest.raises(Exception):
                breaker.call(lambda: exec('raise Exception(&quot;test error&quot;)'))

        # Time passes beyond recovery timeout
        mock_time.return_value = 1002.0

        # Transition to HALF_OPEN
        breaker.call(lambda: &quot;success&quot;</code></pre></div><div class="py-4"><p class="text-gray-600">tests\unit\test_ccxt_binance_complete.py (Line 172:9 - Line 184:25), tests\unit\test_ccxt_binance_complete.py (Line 153:9 - Line 165:33)</p><button class="bg-gray-500 text-white px-1 py-0.5 text-xs rounded focus:outline-none ml-2" id="expandBtn77" onclick="toggleCodeBlock('cloneGroup77', 'expandBtn77', 'collapseBtn77')">Show code</button><button class="bg-gray-500 text-white px-1 py-0.5 text-xs rounded focus:outline-none ml-2 hidden" id="collapseBtn77" onclick="toggleCodeBlock('cloneGroup77', 'expandBtn77', 'collapseBtn77')">Hide code</button><pre class="bg-gray-100 border border-gray-200 p-4 rounded mt-2 hidden" id="cloneGroup77"><code class="language-python text-sm text-gray-800">cfg = {&quot;symbol&quot;: &quot;BTCUSDT&quot;}
        adapter = CCXTBinanceAdapter(cfg)

        mid, spread, bids, asks, trades = adapter.fetch_top_of_book()

        assert mid == 0.0
        assert spread == 0.0
        assert bids == []
        assert asks == []
        assert trades == []

    @patch('ccxt.binanceusdm')
    def test_place_order_dry_run</code></pre></div><div class="py-4"><p class="text-gray-600">tests\research\test_replay_adapter.py (Line 134:4 - Line 144:11), tests\research\test_replay_adapter.py (Line 82:9 - Line 92:7)</p><button class="bg-gray-500 text-white px-1 py-0.5 text-xs rounded focus:outline-none ml-2" id="expandBtn78" onclick="toggleCodeBlock('cloneGroup78', 'expandBtn78', 'collapseBtn78')">Show code</button><button class="bg-gray-500 text-white px-1 py-0.5 text-xs rounded focus:outline-none ml-2 hidden" id="collapseBtn78" onclick="toggleCodeBlock('cloneGroup78', 'expandBtn78', 'collapseBtn78')">Hide code</button><pre class="bg-gray-100 border border-gray-200 p-4 rounded mt-2 hidden" id="cloneGroup78"><code class="language-python text-sm text-gray-800">}

        with tempfile.TemporaryDirectory() as tmpdir:
            out_json = os.path.join(tmpdir, &quot;metrics.json&quot;)
            with open(out_json, 'w') as f:
                json.dump(mock_metrics, f)

            with patch('subprocess.run') as mock_subprocess:
                mock_subprocess.return_value = MagicMock()

                run_replay</code></pre></div><div class="py-4"><p class="text-gray-600">tests\research\test_replay_adapter.py (Line 161:4 - Line 172:2), tests\research\test_replay_adapter.py (Line 82:9 - Line 144:13)</p><button class="bg-gray-500 text-white px-1 py-0.5 text-xs rounded focus:outline-none ml-2" id="expandBtn79" onclick="toggleCodeBlock('cloneGroup79', 'expandBtn79', 'collapseBtn79')">Show code</button><button class="bg-gray-500 text-white px-1 py-0.5 text-xs rounded focus:outline-none ml-2 hidden" id="collapseBtn79" onclick="toggleCodeBlock('cloneGroup79', 'expandBtn79', 'collapseBtn79')">Hide code</button><pre class="bg-gray-100 border border-gray-200 p-4 rounded mt-2 hidden" id="cloneGroup79"><code class="language-python text-sm text-gray-800">}

        with tempfile.TemporaryDirectory() as tmpdir:
            out_json = os.path.join(tmpdir, &quot;metrics.json&quot;)
            with open(out_json, 'w') as f:
                json.dump(mock_metrics, f)

            with patch('subprocess.run') as mock_subprocess:
                mock_subprocess.return_value = MagicMock()

                run_replay(
                    {</code></pre></div><div class="py-4"><p class="text-gray-600">tests\integration\test_p3d_live_dashboard.py (Line 129:9 - Line 137:36), tests\integration\test_p3d_live_dashboard.py (Line 69:9 - Line 77:22)</p><button class="bg-gray-500 text-white px-1 py-0.5 text-xs rounded focus:outline-none ml-2" id="expandBtn80" onclick="toggleCodeBlock('cloneGroup80', 'expandBtn80', 'collapseBtn80')">Show code</button><button class="bg-gray-500 text-white px-1 py-0.5 text-xs rounded focus:outline-none ml-2 hidden" id="collapseBtn80" onclick="toggleCodeBlock('cloneGroup80', 'expandBtn80', 'collapseBtn80')">Hide code</button><pre class="bg-gray-100 border border-gray-200 p-4 rounded mt-2 hidden" id="cloneGroup80"><code class="language-python text-sm text-gray-800">import importlib.util

        # Import live_feed module
        live_feed_path = Path(__file__).parent.parent.parent / &quot;tools&quot; / &quot;live_feed.py&quot;
        spec = importlib.util.spec_from_file_location(&quot;live_feed&quot;, live_feed_path)
        live_feed = importlib.util.module_from_spec(spec)
        spec.loader.exec_module(live_feed)

        # Test Starlette availability check</code></pre></div><div class="py-4"><p class="text-gray-600">tests\integration\test_p3d_live_dashboard.py (Line 159:5 - Line 167:29), tests\integration\test_p3d_live_dashboard.py (Line 69:9 - Line 77:22)</p><button class="bg-gray-500 text-white px-1 py-0.5 text-xs rounded focus:outline-none ml-2" id="expandBtn81" onclick="toggleCodeBlock('cloneGroup81', 'expandBtn81', 'collapseBtn81')">Show code</button><button class="bg-gray-500 text-white px-1 py-0.5 text-xs rounded focus:outline-none ml-2 hidden" id="collapseBtn81" onclick="toggleCodeBlock('cloneGroup81', 'expandBtn81', 'collapseBtn81')">Hide code</button><pre class="bg-gray-100 border border-gray-200 p-4 rounded mt-2 hidden" id="cloneGroup81"><code class="language-python text-sm text-gray-800">import importlib.util

    # Import live_feed module
    live_feed_path = Path(__file__).parent.parent.parent / &quot;tools&quot; / &quot;live_feed.py&quot;
    spec = importlib.util.spec_from_file_location(&quot;live_feed&quot;, live_feed_path)
    live_feed = importlib.util.module_from_spec(spec)
    spec.loader.exec_module(live_feed)

    # Check main function exists</code></pre></div><div class="py-4"><p class="text-gray-600">tests\integration\test_p3d_hardening.py (Line 63:9 - Line 71:31), tests\integration\test_p3d_live_dashboard.py (Line 69:9 - Line 77:22)</p><button class="bg-gray-500 text-white px-1 py-0.5 text-xs rounded focus:outline-none ml-2" id="expandBtn82" onclick="toggleCodeBlock('cloneGroup82', 'expandBtn82', 'collapseBtn82')">Show code</button><button class="bg-gray-500 text-white px-1 py-0.5 text-xs rounded focus:outline-none ml-2 hidden" id="collapseBtn82" onclick="toggleCodeBlock('cloneGroup82', 'expandBtn82', 'collapseBtn82')">Hide code</button><pre class="bg-gray-100 border border-gray-200 p-4 rounded mt-2 hidden" id="cloneGroup82"><code class="language-python text-sm text-gray-800">import importlib.util

        # Import live_feed module
        live_feed_path = Path(__file__).parent.parent.parent / &quot;tools&quot; / &quot;live_feed.py&quot;
        spec = importlib.util.spec_from_file_location(&quot;live_feed&quot;, live_feed_path)
        live_feed = importlib.util.module_from_spec(spec)
        spec.loader.exec_module(live_feed)

        # Create aggregator and tailer</code></pre></div><div class="py-4"><p class="text-gray-600">tests\integration\test_p3d_hardening.py (Line 98:9 - Line 110:21), tests\integration\test_p3d_live_dashboard.py (Line 69:9 - Line 75:33)</p><button class="bg-gray-500 text-white px-1 py-0.5 text-xs rounded focus:outline-none ml-2" id="expandBtn83" onclick="toggleCodeBlock('cloneGroup83', 'expandBtn83', 'collapseBtn83')">Show code</button><button class="bg-gray-500 text-white px-1 py-0.5 text-xs rounded focus:outline-none ml-2 hidden" id="collapseBtn83" onclick="toggleCodeBlock('cloneGroup83', 'expandBtn83', 'collapseBtn83')">Hide code</button><pre class="bg-gray-100 border border-gray-200 p-4 rounded mt-2 hidden" id="cloneGroup83"><code class="language-python text-sm text-gray-800">import importlib.util

        # Import live_feed module
        live_feed_path = Path(__file__).parent.parent.parent / &quot;tools&quot; / &quot;live_feed.py&quot;
        spec = importlib.util.spec_from_file_location(&quot;live_feed&quot;, live_feed_path)
        live_feed = importlib.util.module_from_spec(spec)
        spec.loader.exec_module(live_feed)

        # Create aggregator and tailer
        aggregator = live_feed.LiveAggregator(300)
        tailer = live_feed.JSONLTailer(temp_session_with_logs, aggregator)

        # Add oversized line</code></pre></div><div class="py-4"><p class="text-gray-600">tests\integration\test_p3d_hardening.py (Line 134:9 - Line 143:15), tests\integration\test_p3d_live_dashboard.py (Line 69:9 - Line 72:4)</p><button class="bg-gray-500 text-white px-1 py-0.5 text-xs rounded focus:outline-none ml-2" id="expandBtn84" onclick="toggleCodeBlock('cloneGroup84', 'expandBtn84', 'collapseBtn84')">Show code</button><button class="bg-gray-500 text-white px-1 py-0.5 text-xs rounded focus:outline-none ml-2 hidden" id="collapseBtn84" onclick="toggleCodeBlock('cloneGroup84', 'expandBtn84', 'collapseBtn84')">Hide code</button><pre class="bg-gray-100 border border-gray-200 p-4 rounded mt-2 hidden" id="cloneGroup84"><code class="language-python text-sm text-gray-800">import importlib.util

        # Import live_feed module
        live_feed_path = Path(__file__).parent.parent.parent / &quot;tools&quot; / &quot;live_feed.py&quot;
        spec = importlib.util.spec_from_file_location(&quot;live_feed&quot;, live_feed_path)
        live_feed = importlib.util.module_from_spec(spec)
        spec.loader.exec_module(live_feed)

        # Create aggregator and tailer
        aggregator = live_feed.LiveAggregator(window_minutes</code></pre></div><div class="py-4"><p class="text-gray-600">tests\integration\test_p3d_hardening.py (Line 176:9 - Line 184:27), tests\integration\test_p3d_live_dashboard.py (Line 69:9 - Line 77:22)</p><button class="bg-gray-500 text-white px-1 py-0.5 text-xs rounded focus:outline-none ml-2" id="expandBtn85" onclick="toggleCodeBlock('cloneGroup85', 'expandBtn85', 'collapseBtn85')">Show code</button><button class="bg-gray-500 text-white px-1 py-0.5 text-xs rounded focus:outline-none ml-2 hidden" id="collapseBtn85" onclick="toggleCodeBlock('cloneGroup85', 'expandBtn85', 'collapseBtn85')">Hide code</button><pre class="bg-gray-100 border border-gray-200 p-4 rounded mt-2 hidden" id="cloneGroup85"><code class="language-python text-sm text-gray-800">import importlib.util

        # Import live_feed module
        live_feed_path = Path(__file__).parent.parent.parent / &quot;tools&quot; / &quot;live_feed.py&quot;
        spec = importlib.util.spec_from_file_location(&quot;live_feed&quot;, live_feed_path)
        live_feed = importlib.util.module_from_spec(spec)
        spec.loader.exec_module(live_feed)

        # Create server components</code></pre></div><div class="py-4"><p class="text-gray-600">tests\integration\test_governance_gate.py (Line 149:17 - Line 157:4), tests\integration\test_governance_gate.py (Line 109:9 - Line 117:35)</p><button class="bg-gray-500 text-white px-1 py-0.5 text-xs rounded focus:outline-none ml-2" id="expandBtn86" onclick="toggleCodeBlock('cloneGroup86', 'expandBtn86', 'collapseBtn86')">Show code</button><button class="bg-gray-500 text-white px-1 py-0.5 text-xs rounded focus:outline-none ml-2 hidden" id="collapseBtn86" onclick="toggleCodeBlock('cloneGroup86', 'expandBtn86', 'collapseBtn86')">Hide code</button><pre class="bg-gray-100 border border-gray-200 p-4 rounded mt-2 hidden" id="cloneGroup86"><code class="language-python text-sm text-gray-800">}):
                    with patch(&quot;skalp_bot.runner.run_live_aurora.create_adapter&quot;) as mock_adapter_factory:
                        mock_adapter = MockAdapter(MockMarketData())
                        mock_adapter_factory.return_value = mock_adapter

                        with patch(&quot;yaml.safe_load&quot;, return_value=self.test_config):
                            with patch(&quot;pathlib.Path.exists&quot;, return_value=True):
                                with patch(&quot;pathlib.Path.read_text&quot;, return_value=&quot;&quot;):
                                    try</code></pre></div><div class="py-4"><p class="text-gray-600">tests\integration\test_governance_gate.py (Line 176:17 - Line 195:35), tests\integration\test_governance_gate.py (Line 72:17 - Line 91:4)</p><button class="bg-gray-500 text-white px-1 py-0.5 text-xs rounded focus:outline-none ml-2" id="expandBtn87" onclick="toggleCodeBlock('cloneGroup87', 'expandBtn87', 'collapseBtn87')">Show code</button><button class="bg-gray-500 text-white px-1 py-0.5 text-xs rounded focus:outline-none ml-2 hidden" id="collapseBtn87" onclick="toggleCodeBlock('cloneGroup87', 'expandBtn87', 'collapseBtn87')">Hide code</button><pre class="bg-gray-100 border border-gray-200 p-4 rounded mt-2 hidden" id="cloneGroup87"><code class="language-python text-sm text-gray-800">&quot;policy&quot;: &quot;pocock&quot;,
                &quot;max_history_len&quot;: 100
            },
            &quot;execution&quot;: {
                &quot;sla&quot;: {&quot;max_latency_ms&quot;: 250}
            },
            &quot;order_sink&quot;: {
                &quot;mode&quot;: &quot;sim_local&quot;,
                &quot;sim_local&quot;: {
                    &quot;latency_ms&quot;: 10,
                    &quot;ttl_ms&quot;: 5000
                }
            },
            &quot;sizing&quot;: {
                &quot;kelly&quot;: {&quot;risk_aversion&quot;: 1.0},
                &quot;limits&quot;: {&quot;max_notional&quot;: 1000.0}
            }
        }

        # Mock SPRT that always rejects H0</code></pre></div><div class="py-4"><p class="text-gray-600">tests\integration\test_governance_gate.py (Line 207:13 - Line 215:4), tests\integration\test_governance_gate.py (Line 140:13 - Line 148:4)</p><button class="bg-gray-500 text-white px-1 py-0.5 text-xs rounded focus:outline-none ml-2" id="expandBtn88" onclick="toggleCodeBlock('cloneGroup88', 'expandBtn88', 'collapseBtn88')">Show code</button><button class="bg-gray-500 text-white px-1 py-0.5 text-xs rounded focus:outline-none ml-2 hidden" id="collapseBtn88" onclick="toggleCodeBlock('cloneGroup88', 'expandBtn88', 'collapseBtn88')">Hide code</button><pre class="bg-gray-100 border border-gray-200 p-4 rounded mt-2 hidden" id="cloneGroup88"><code class="language-python text-sm text-gray-800">events_logged = []

            def mock_log_events(code: str, details: dict):
                events_logged.append({&quot;code&quot;: code, &quot;details&quot;: details})

            with patch(&quot;skalp_bot.runner.run_live_aurora._log_events&quot;, side_effect=mock_log_events):
                with patch.dict(os.environ, {
                    &quot;DRY_RUN&quot;: &quot;true&quot;,
                                                        &quot;AURORA_MAX_TICKS&quot;: &quot;1&quot;</code></pre></div><div class="py-4"><p class="text-gray-600">tests\integration\test_governance_gate.py (Line 254:12 - Line 263:4), tests\integration\test_governance_gate.py (Line 206:10 - Line 148:4)</p><button class="bg-gray-500 text-white px-1 py-0.5 text-xs rounded focus:outline-none ml-2" id="expandBtn89" onclick="toggleCodeBlock('cloneGroup89', 'expandBtn89', 'collapseBtn89')">Show code</button><button class="bg-gray-500 text-white px-1 py-0.5 text-xs rounded focus:outline-none ml-2 hidden" id="collapseBtn89" onclick="toggleCodeBlock('cloneGroup89', 'expandBtn89', 'collapseBtn89')">Hide code</button><pre class="bg-gray-100 border border-gray-200 p-4 rounded mt-2 hidden" id="cloneGroup89"><code class="language-python text-sm text-gray-800">):
            events_logged = []

            def mock_log_events(code: str, details: dict):
                events_logged.append({&quot;code&quot;: code, &quot;details&quot;: details})

            with patch(&quot;skalp_bot.runner.run_live_aurora._log_events&quot;, side_effect=mock_log_events):
                with patch.dict(os.environ, {
                    &quot;DRY_RUN&quot;: &quot;true&quot;,
                    &quot;AURORA_MAX_TICKS&quot;: &quot;2&quot;</code></pre></div><div class="py-4"><p class="text-gray-600">tests\integration\test_governance_gate.py (Line 264:17 - Line 278:45), tests\integration\test_governance_gate.py (Line 109:9 - Line 163:45)</p><button class="bg-gray-500 text-white px-1 py-0.5 text-xs rounded focus:outline-none ml-2" id="expandBtn90" onclick="toggleCodeBlock('cloneGroup90', 'expandBtn90', 'collapseBtn90')">Show code</button><button class="bg-gray-500 text-white px-1 py-0.5 text-xs rounded focus:outline-none ml-2 hidden" id="collapseBtn90" onclick="toggleCodeBlock('cloneGroup90', 'expandBtn90', 'collapseBtn90')">Hide code</button><pre class="bg-gray-100 border border-gray-200 p-4 rounded mt-2 hidden" id="cloneGroup90"><code class="language-python text-sm text-gray-800">}):
                    with patch(&quot;skalp_bot.runner.run_live_aurora.create_adapter&quot;) as mock_adapter_factory:
                        mock_adapter = MockAdapter(MockMarketData())
                        mock_adapter_factory.return_value = mock_adapter

                        with patch(&quot;yaml.safe_load&quot;, return_value=self.test_config):
                            with patch(&quot;pathlib.Path.exists&quot;, return_value=True):
                                with patch(&quot;pathlib.Path.read_text&quot;, return_value=&quot;&quot;):
                                    try:
                                        from skalp_bot.runner.run_live_aurora import main
                                        main(config_path=&quot;test_config.yaml&quot;)
                                    except SystemExit:
                                        pass

        # Verify governance error events were logged</code></pre></div><div class="py-4"><p class="text-gray-600">tests\integration\test_governance_gate.py (Line 318:9 - Line 341:25), tests\integration\test_governance_gate.py (Line 140:13 - Line 163:45)</p><button class="bg-gray-500 text-white px-1 py-0.5 text-xs rounded focus:outline-none ml-2" id="expandBtn91" onclick="toggleCodeBlock('cloneGroup91', 'expandBtn91', 'collapseBtn91')">Show code</button><button class="bg-gray-500 text-white px-1 py-0.5 text-xs rounded focus:outline-none ml-2 hidden" id="collapseBtn91" onclick="toggleCodeBlock('cloneGroup91', 'expandBtn91', 'collapseBtn91')">Hide code</button><pre class="bg-gray-100 border border-gray-200 p-4 rounded mt-2 hidden" id="cloneGroup91"><code class="language-python text-sm text-gray-800">events_logged = []

        def mock_log_events(code: str, details: dict):
            events_logged.append({&quot;code&quot;: code, &quot;details&quot;: details})

        with patch(&quot;skalp_bot.runner.run_live_aurora._log_events&quot;, side_effect=mock_log_events):
            with patch.dict(os.environ, {
                &quot;DRY_RUN&quot;: &quot;true&quot;,
                &quot;AURORA_MAX_TICKS&quot;: &quot;2&quot;
            }):
                with patch(&quot;skalp_bot.runner.run_live_aurora.create_adapter&quot;) as mock_adapter_factory:
                    mock_adapter = MockAdapter(MockMarketData())
                    mock_adapter_factory.return_value = mock_adapter

                    with patch(&quot;yaml.safe_load&quot;, return_value=self.test_config):
                        with patch(&quot;pathlib.Path.exists&quot;, return_value=True):
                            with patch(&quot;pathlib.Path.read_text&quot;, return_value=&quot;&quot;):
                                try:
                                    from skalp_bot.runner.run_live_aurora import main
                                    main(config_path=&quot;test_config.yaml&quot;)
                                except SystemExit:
                                    pass

        # Find governance events</code></pre></div><div class="py-4"><p class="text-gray-600">tests\integration\test_governance_gate.py (Line 376:15 - Line 385:34), tests\integration\test_governance_gate.py (Line 304:7 - Line 313:37)</p><button class="bg-gray-500 text-white px-1 py-0.5 text-xs rounded focus:outline-none ml-2" id="expandBtn92" onclick="toggleCodeBlock('cloneGroup92', 'expandBtn92', 'collapseBtn92')">Show code</button><button class="bg-gray-500 text-white px-1 py-0.5 text-xs rounded focus:outline-none ml-2 hidden" id="collapseBtn92" onclick="toggleCodeBlock('cloneGroup92', 'expandBtn92', 'collapseBtn92')">Hide code</button><pre class="bg-gray-100 border border-gray-200 p-4 rounded mt-2 hidden" id="cloneGroup92"><code class="language-python text-sm text-gray-800">):
                    with patch(&quot;pathlib.Path.exists&quot;, return_value=True):
                        with patch(&quot;pathlib.Path.read_text&quot;, return_value=&quot;&quot;):
                            try:
                                from skalp_bot.runner.run_live_aurora import main
                                main(config_path=&quot;test_config.yaml&quot;)
                            except SystemExit:
                                pass  # Expected for test exit
                            except Exception as e:
                                pytest.fail(f&quot;Default config should work: {e}&quot;</code></pre></div><div class="py-4"><p class="text-gray-600">tests\integration\test_full_b2b7_pipeline.py (Line 46:9 - Line 64:8), tests\unit\test_xai_decision_trail.py (Line 29:9 - Line 47:4)</p><button class="bg-gray-500 text-white px-1 py-0.5 text-xs rounded focus:outline-none ml-2" id="expandBtn93" onclick="toggleCodeBlock('cloneGroup93', 'expandBtn93', 'collapseBtn93')">Show code</button><button class="bg-gray-500 text-white px-1 py-0.5 text-xs rounded focus:outline-none ml-2 hidden" id="collapseBtn93" onclick="toggleCodeBlock('cloneGroup93', 'expandBtn93', 'collapseBtn93')">Hide code</button><pre class="bg-gray-100 border border-gray-200 p-4 rounded mt-2 hidden" id="cloneGroup93"><code class="language-python text-sm text-gray-800"># CoxPH
        cox = CoxPH()
        cox._beta = {'obi': 0.1, 'spread_bps': -0.05}
        cox._feat = ['obi', 'spread_bps']

        # SLA
        sla = SLAGate(max_latency_ms=250, kappa_bps_per_ms=0.01, min_edge_after_bps=1.0)

        # Router
        router = Router(
            hazard_model=cox,
            slagate=sla,
            min_p_fill=0.25,
            exchange_name='test'
        )

        return router

    @pytest</code></pre></div><div class="py-4"><p class="text-gray-600">tests\integration\test_full_b2b7_pipeline.py (Line 291:9 - Line 303:34), tests\integration\test_full_b2b7_pipeline.py (Line 262:9 - Line 274:22)</p><button class="bg-gray-500 text-white px-1 py-0.5 text-xs rounded focus:outline-none ml-2" id="expandBtn94" onclick="toggleCodeBlock('cloneGroup94', 'expandBtn94', 'collapseBtn94')">Show code</button><button class="bg-gray-500 text-white px-1 py-0.5 text-xs rounded focus:outline-none ml-2 hidden" id="collapseBtn94" onclick="toggleCodeBlock('cloneGroup94', 'expandBtn94', 'collapseBtn94')">Hide code</button><pre class="bg-gray-100 border border-gray-200 p-4 rounded mt-2 hidden" id="cloneGroup94"><code class="language-python text-sm text-gray-800">mock_requests = MagicMock()
        mock_response = MagicMock()
        mock_response.ok = True
        mock_response.json.return_value = {
            &quot;allow&quot;: True,
            &quot;max_qty&quot;: 0.001,
            &quot;reason&quot;: &quot;Test allow&quot;,
            &quot;observability&quot;: {&quot;gate_state&quot;: &quot;ALLOW&quot;}
        }
        mock_requests.post.return_value = mock_response
        aurora_gate._requests = mock_requests

        # Simulate complete trading cycle</code></pre></div><div class="py-4"><p class="text-gray-600">tests\fixtures\mock_exchange_factory.py (Line 329:1 - Line 375:31), tests\fixtures\mock_exchange_factory.py (Line 34:1 - Line 80:44)</p><button class="bg-gray-500 text-white px-1 py-0.5 text-xs rounded focus:outline-none ml-2" id="expandBtn95" onclick="toggleCodeBlock('cloneGroup95', 'expandBtn95', 'collapseBtn95')">Show code</button><button class="bg-gray-500 text-white px-1 py-0.5 text-xs rounded focus:outline-none ml-2 hidden" id="collapseBtn95" onclick="toggleCodeBlock('cloneGroup95', 'expandBtn95', 'collapseBtn95')">Hide code</button><pre class="bg-gray-100 border border-gray-200 p-4 rounded mt-2 hidden" id="cloneGroup95"><code class="language-python text-sm text-gray-800">class MockExchange:
    &quot;&quot;&quot;Mock exchange implementation with configurable behavior.&quot;&quot;&quot;

    def __init__(self, config: Dict[str, Any]):
        self.config = config
        self.orders = {}  # order_id -&gt; order
        self.fills = {}   # order_id -&gt; list of fills
        self.reject_next = None
        self.price_sequence = config.get(&quot;price_sequence&quot;, [])
        self.price_index = 0

    def set_fill_profile(self, profile: Dict[str, Any]):
        &quot;&quot;&quot;Update fill profile dynamically.&quot;&quot;&quot;
        self.config.update(profile)

    def set_reject_next_order(self, reason: str):
        &quot;&quot;&quot;Set next order to be rejected.&quot;&quot;&quot;
        self.reject_next = reason

    def reset_reject_pattern(self):
        &quot;&quot;&quot;Reset rejection pattern.&quot;&quot;&quot;
        self.reject_next = None

    def trigger_partial_fill(self, order_id: str, quantity: Decimal, price: Decimal):
        &quot;&quot;&quot;Manually trigger a partial fill for testing.&quot;&quot;&quot;
        if order_id not in self.fills:
            self.fills[order_id] = []

        fill = Fill(
            price=float(price),
            qty=float(quantity),
            fee=float(quantity * price * Decimal(&quot;0.001&quot;)),  # 0.1% fee
            fee_asset=&quot;USDT&quot;,
            ts_ns=int(time.time() * 1_000_000_000)
        )

        self.fills[order_id].append(fill)

    async def submit_order(self, order: OrderRequest) -&gt; Dict[str, Any]:
        &quot;&quot;&quot;Submit order with configurable behavior.&quot;&quot;&quot;
        # Check for rejection
        if self.reject_next:
            reason = self.reject_next
            self.reject_next = None
            return {
                &quot;status&quot;: &quot;rejected&quot;,
                &quot;order_id&quot;: f&quot;mock_{order.client_order_id}&quot;</code></pre></div><div class="py-4"><p class="text-gray-600">tests\fixtures\mock_exchange_factory.py (Line 382:9 - Line 426:9), tests\fixtures\mock_exchange_factory.py (Line 87:9 - Line 131:4)</p><button class="bg-gray-500 text-white px-1 py-0.5 text-xs rounded focus:outline-none ml-2" id="expandBtn96" onclick="toggleCodeBlock('cloneGroup96', 'expandBtn96', 'collapseBtn96')">Show code</button><button class="bg-gray-500 text-white px-1 py-0.5 text-xs rounded focus:outline-none ml-2 hidden" id="collapseBtn96" onclick="toggleCodeBlock('cloneGroup96', 'expandBtn96', 'collapseBtn96')">Hide code</button><pre class="bg-gray-100 border border-gray-200 p-4 rounded mt-2 hidden" id="cloneGroup96"><code class="language-python text-sm text-gray-800">self.orders[order_id] = order

        # Simulate exchange processing delay
        latency = self.config.get(&quot;latency_ms&quot;, 10) / 1000
        await asyncio.sleep(latency)

        # Determine fill behavior
        if self.config.get(&quot;immediate&quot;, True):
            await self._process_fills(order_id, order)
        else:
            # Schedule fills asynchronously
            asyncio.create_task(self._delayed_fill(order_id, order))

        return {
            &quot;status&quot;: &quot;accepted&quot;,
            &quot;order_id&quot;: order_id,
            &quot;timestamp&quot;: time.time()
        }

    async def cancel_order(self, order_id: str) -&gt; Dict[str, Any]:
        &quot;&quot;&quot;Cancel order.&quot;&quot;&quot;
        if order_id not in self.orders:
            return {&quot;status&quot;: &quot;not_found&quot;, &quot;order_id&quot;: order_id}

        # Simulate cancellation delay
        latency = self.config.get(&quot;latency_ms&quot;, 10) / 1000
        await asyncio.sleep(latency)

        # Remove from active orders
        del self.orders[order_id]

        return {
            &quot;status&quot;: &quot;cancelled&quot;,
            &quot;order_id&quot;: order_id,
            &quot;timestamp&quot;: time.time()
        }

    async def get_order_status(self, order_id: str) -&gt; Dict[str, Any]:
        &quot;&quot;&quot;Get order status.&quot;&quot;&quot;
        if order_id not in self.orders:
            return {&quot;status&quot;: &quot;not_found&quot;, &quot;order_id&quot;: order_id}

        order = self.orders[order_id]
        fills = self.fills.get(order_id, [])
        filled_qty = sum(f.quantity</code></pre></div><div class="py-4"><p class="text-gray-600">tests\fixtures\mock_exchange_factory.py (Line 426:2 - Line 440:5), tests\fixtures\mock_exchange_factory.py (Line 131:2 - Line 145:9)</p><button class="bg-gray-500 text-white px-1 py-0.5 text-xs rounded focus:outline-none ml-2" id="expandBtn97" onclick="toggleCodeBlock('cloneGroup97', 'expandBtn97', 'collapseBtn97')">Show code</button><button class="bg-gray-500 text-white px-1 py-0.5 text-xs rounded focus:outline-none ml-2 hidden" id="collapseBtn97" onclick="toggleCodeBlock('cloneGroup97', 'expandBtn97', 'collapseBtn97')">Hide code</button><pre class="bg-gray-100 border border-gray-200 p-4 rounded mt-2 hidden" id="cloneGroup97"><code class="language-python text-sm text-gray-800">for f in fills)

        if filled_qty == 0:
            status = &quot;open&quot;
        elif filled_qty &lt; order.quantity:
            status = &quot;partial_fill&quot;
        else:
            status = &quot;filled&quot;

        return {
            &quot;order_id&quot;: order_id,
            &quot;status&quot;: status,
            &quot;filled_quantity&quot;: filled_qty,
            &quot;remaining_quantity&quot;: order.quantity - filled_qty,
            &quot;fills&quot;: [f.dict</code></pre></div><div class="py-4"><p class="text-gray-600">tests\fixtures\mock_exchange_factory.py (Line 440:2 - Line 460:8), tests\fixtures\mock_exchange_factory.py (Line 145:2 - Line 165:6)</p><button class="bg-gray-500 text-white px-1 py-0.5 text-xs rounded focus:outline-none ml-2" id="expandBtn98" onclick="toggleCodeBlock('cloneGroup98', 'expandBtn98', 'collapseBtn98')">Show code</button><button class="bg-gray-500 text-white px-1 py-0.5 text-xs rounded focus:outline-none ml-2 hidden" id="collapseBtn98" onclick="toggleCodeBlock('cloneGroup98', 'expandBtn98', 'collapseBtn98')">Hide code</button><pre class="bg-gray-100 border border-gray-200 p-4 rounded mt-2 hidden" id="cloneGroup98"><code class="language-python text-sm text-gray-800">for f in fills]
        }

    async def get_order_fills(self, order_id: str) -&gt; List[Fill]:
        &quot;&quot;&quot;Get fills for order.&quot;&quot;&quot;
        return self.fills.get(order_id, [])

    async def _process_fills(self, order_id: str, order: OrderRequest):
        &quot;&quot;&quot;Process fills based on configuration.&quot;&quot;&quot;
        partial_ratios = self.config.get(&quot;partial&quot;, [1.0])  # Default full fill

        if order_id not in self.fills:
            self.fills[order_id] = []

        remaining_qty = order.quantity

        for ratio in partial_ratios:
            if remaining_qty &lt;= 0:
                break

            fill_qty = remaining_qty * Decimal</code></pre></div><div class="py-4"><p class="text-gray-600">tests\fixtures\mock_exchange_factory.py (Line 477:2 - Line 568:31), tests\fixtures\mock_exchange_factory.py (Line 183:6 - Line 274:44)</p><button class="bg-gray-500 text-white px-1 py-0.5 text-xs rounded focus:outline-none ml-2" id="expandBtn99" onclick="toggleCodeBlock('cloneGroup99', 'expandBtn99', 'collapseBtn99')">Show code</button><button class="bg-gray-500 text-white px-1 py-0.5 text-xs rounded focus:outline-none ml-2 hidden" id="collapseBtn99" onclick="toggleCodeBlock('cloneGroup99', 'expandBtn99', 'collapseBtn99')">Hide code</button><pre class="bg-gray-100 border border-gray-200 p-4 rounded mt-2 hidden" id="cloneGroup99"><code class="language-python text-sm text-gray-800">,  # 0.1% fee
                fee_asset=&quot;USDT&quot;,
                ts_ns=int(time.time() * 1_000_000_000)
            )

            self.fills[order_id].append(fill)
            remaining_qty -= fill_qty

            # Simulate fill delay between partials
            if len(partial_ratios) &gt; 1:
                await asyncio.sleep(0.05)

    async def _delayed_fill(self, order_id: str, order: OrderRequest):
        &quot;&quot;&quot;Process delayed fills.&quot;&quot;&quot;
        # Wait for configured delay
        delay = self.config.get(&quot;delay_ms&quot;, 100) / 1000
        await asyncio.sleep(delay)

        # Process fills if order still active
        if order_id in self.orders:
            await self._process_fills(order_id, order)


class MockExchangeFactory:
    &quot;&quot;&quot;Factory for creating mock exchanges with different configurations.&quot;&quot;&quot;

    @staticmethod
    def create_deterministic_exchange(fill_profile: Optional[Dict[str, Any]] = None) -&gt; MockExchange:
        &quot;&quot;&quot;Create deterministic exchange for predictable testing.&quot;&quot;&quot;
        config = {
            &quot;immediate&quot;: True,
            &quot;latency_ms&quot;: 10,
            &quot;partial&quot;: [1.0],  # Full fill by default
            &quot;price_sequence&quot;: [],
            **(fill_profile or {})
        }
        return MockExchange(config)

    @staticmethod
    def create_stochastic_exchange(fill_profile: Optional[Dict[str, Any]] = None) -&gt; MockExchange:
        &quot;&quot;&quot;Create stochastic exchange with random behavior.&quot;&quot;&quot;
        config = {
            &quot;immediate&quot;: True,
            &quot;latency_ms&quot;: random.randint(5, 50),
            &quot;partial&quot;: MockExchangeFactory._generate_random_partial_ratios(),
            &quot;price_variation&quot;: 0.02,  # 2% price variation
            **(fill_profile or {})
        }
        return MockExchange(config)

    @staticmethod
    def create_slow_exchange(fill_profile: Optional[Dict[str, Any]] = None) -&gt; MockExchange:
        &quot;&quot;&quot;Create slow exchange for testing timeouts.&quot;&quot;&quot;
        config = {
            &quot;immediate&quot;: False,
            &quot;latency_ms&quot;: 200,
            &quot;delay_ms&quot;: 500,
            &quot;partial&quot;: [1.0],
            **(fill_profile or {})
        }
        return MockExchange(config)

    @staticmethod
    def create_partial_fill_exchange(fill_profile: Optional[Dict[str, Any]] = None) -&gt; MockExchange:
        &quot;&quot;&quot;Create exchange that does partial fills.&quot;&quot;&quot;
        config = {
            &quot;immediate&quot;: True,
            &quot;latency_ms&quot;: 20,
            &quot;partial&quot;: [0.3, 0.4, 0.3],  # Multiple partial fills
            **(fill_profile or {})
        }
        return MockExchange(config)

    @staticmethod
    def create_rejecting_exchange(reject_rate: float = 0.1, fill_profile: Optional[Dict[str, Any]] = None) -&gt; MockExchange:
        &quot;&quot;&quot;Create exchange that randomly rejects orders.&quot;&quot;&quot;
        config = {
            &quot;immediate&quot;: True,
            &quot;latency_ms&quot;: 15,
            &quot;reject_rate&quot;: reject_rate,
            &quot;partial&quot;: [1.0],
            **(fill_profile or {})
        }
        exchange = MockExchange(config)

        # Override submit_order to add rejection logic
        original_submit = exchange.submit_order
        async def rejecting_submit(order: OrderRequest) -&gt; Dict[str, Any]:
            if random.random() &lt; reject_rate:
                return {
                    &quot;status&quot;: &quot;rejected&quot;,
                    &quot;order_id&quot;: f&quot;mock_{order.client_order_id}&quot;</code></pre></div><div class="py-4"><p class="text-gray-600">tests\fixtures\mock_exchange_factory.py (Line 568:31 - Line 616:4), tests\fixtures\mock_exchange_factory.py (Line 274:44 - Line 322:4)</p><button class="bg-gray-500 text-white px-1 py-0.5 text-xs rounded focus:outline-none ml-2" id="expandBtn100" onclick="toggleCodeBlock('cloneGroup100', 'expandBtn100', 'collapseBtn100')">Show code</button><button class="bg-gray-500 text-white px-1 py-0.5 text-xs rounded focus:outline-none ml-2 hidden" id="collapseBtn100" onclick="toggleCodeBlock('cloneGroup100', 'expandBtn100', 'collapseBtn100')">Hide code</button><pre class="bg-gray-100 border border-gray-200 p-4 rounded mt-2 hidden" id="cloneGroup100"><code class="language-python text-sm text-gray-800">,
                    &quot;reason&quot;: &quot;RANDOM_REJECT&quot;,
                    &quot;timestamp&quot;: time.time()
                }
            return await original_submit(order)

        exchange.submit_order = rejecting_submit
        return exchange

    @staticmethod
    def create_high_latency_exchange(fill_profile: Optional[Dict[str, Any]] = None) -&gt; MockExchange:
        &quot;&quot;&quot;Create exchange with high latency for performance testing.&quot;&quot;&quot;
        config = {
            &quot;immediate&quot;: True,
            &quot;latency_ms&quot;: 500,  # 500ms latency
            &quot;jitter_ms&quot;: 100,   # ±100ms jitter
            &quot;partial&quot;: [1.0],
            **(fill_profile or {})
        }
        exchange = MockExchange(config)

        # Override to add jitter
        original_submit = exchange.submit_order
        async def jittery_submit(order: OrderRequest) -&gt; Dict[str, Any]:
            result = await original_submit(order)
            # Add random jitter
            jitter = random.uniform(-config[&quot;jitter_ms&quot;], config[&quot;jitter_ms&quot;]) / 1000
            await asyncio.sleep(max(0, jitter))
            return result

        exchange.submit_order = jittery_submit
        return exchange

    @staticmethod
    def _generate_random_partial_ratios() -&gt; List[float]:
        &quot;&quot;&quot;Generate random partial fill ratios that sum to 1.0.&quot;&quot;&quot;
        num_fills = random.randint(1, 4)
        ratios = [random.random() for _ in range(num_fills)]
        total = sum(ratios)
        return [r / total for r in ratios]

    @staticmethod
    def create_exchange_with_price_sequence(price_sequence: List[float],
                                          fill_profile: Optional[Dict[str, Any]] = None) -&gt; MockExchange:
        &quot;&quot;&quot;Create exchange with specific price sequence for testing.&quot;&quot;&quot;
        config = {
            &quot;immediate&quot;: True,
            &quot;latency_ms&quot;: 10,
            &quot;partial&quot;: [1.0</code></pre></div><div class="py-4"><p class="text-gray-600">tests\execution\test_sizing_orchestrator_effect.py (Line 26:5 - Line 32:2), tests\risk\test_lambda_orchestrator.py (Line 5:5 - Line 10:2)</p><button class="bg-gray-500 text-white px-1 py-0.5 text-xs rounded focus:outline-none ml-2" id="expandBtn101" onclick="toggleCodeBlock('cloneGroup101', 'expandBtn101', 'collapseBtn101')">Show code</button><button class="bg-gray-500 text-white px-1 py-0.5 text-xs rounded focus:outline-none ml-2 hidden" id="collapseBtn101" onclick="toggleCodeBlock('cloneGroup101', 'expandBtn101', 'collapseBtn101')">Hide code</button><pre class="bg-gray-100 border border-gray-200 p-4 rounded mt-2 hidden" id="cloneGroup101"><code class="language-python text-sm text-gray-800">,'ece_bad':0.08},
                'reg':{'trend':1.0,'grind':0.8,'chaos':0.6},
                'liq':{'spread_bps_breaks':[5,10],'lambdas':[1.0,0.8,0.6]},
                'dd': {'dd_warn':0.05,'dd_bad':0.10,'lambdas':[1.0,0.7,0.4]},
                'lat':{'p95_ms_breaks':[200,500],'lambdas':[1.0,0.8,0.6]},
            }
        },</code></pre></div><div class="py-4"><p class="text-gray-600">tests\execution\test_sizing_orchestrator_effect.py (Line 37:1 - Line 47:5), tests\obs\test_metrics_exposition.py (Line 9:1 - Line 19:5)</p><button class="bg-gray-500 text-white px-1 py-0.5 text-xs rounded focus:outline-none ml-2" id="expandBtn102" onclick="toggleCodeBlock('cloneGroup102', 'expandBtn102', 'collapseBtn102')">Show code</button><button class="bg-gray-500 text-white px-1 py-0.5 text-xs rounded focus:outline-none ml-2 hidden" id="collapseBtn102" onclick="toggleCodeBlock('cloneGroup102', 'expandBtn102', 'collapseBtn102')">Hide code</button><pre class="bg-gray-100 border border-gray-200 p-4 rounded mt-2 hidden" id="cloneGroup102"><code class="language-python text-sm text-gray-800">def mk_market():
    return MarketSpec(
        tick_size=Decimal('0.01'), lot_size=Decimal('0.1'), min_notional=Decimal('10'),
        maker_fee_bps=1, taker_fee_bps=5, best_bid=Decimal('100'), best_ask=Decimal('100.1'),
        spread_bps=1.0, mid=Decimal('100.05')
    )


def mk_intent(stop_bps=100, qty_hint=None, equity=Decimal('10000')):
    return OrderIntent(
        intent_id='t1'</code></pre></div><div class="py-4"><p class="text-gray-600">tests\execution\test_post_only_sim.py (Line 16:7 - Line 21:3), tests\execution\test_post_only_sim.py (Line 7:6 - Line 12:3)</p><button class="bg-gray-500 text-white px-1 py-0.5 text-xs rounded focus:outline-none ml-2" id="expandBtn103" onclick="toggleCodeBlock('cloneGroup103', 'expandBtn103', 'collapseBtn103')">Show code</button><button class="bg-gray-500 text-white px-1 py-0.5 text-xs rounded focus:outline-none ml-2 hidden" id="collapseBtn103" onclick="toggleCodeBlock('cloneGroup103', 'expandBtn103', 'collapseBtn103')">Hide code</button><pre class="bg-gray-100 border border-gray-200 p-4 rounded mt-2 hidden" id="cloneGroup103"><code class="language-python text-sm text-gray-800">, expected_return_bps=40, post_only=True)
    mspec = market_spec_factory(tick_size='0.10', best_bid='30000', best_ask='30000.6')
    monkeypatch.setattr(RouterV2, '_p_fill', lambda self, f, s: Decimal('0.8'))
    res = svc.place(intent=intent, market=mspec, features={}, measured_latency_ms=20)
    if not isinstance(res, DenyDecision) and res.mode == 'maker' and res.price:
        assert Decimal(str(res.price)) &gt;=</code></pre></div><div class="py-4"><p class="text-gray-600">tests\execution\test_portfolio_correlation_effect.py (Line 33:4 - Line 48:7), tests\execution\test_sizing_orchestrator_effect.py (Line 30:4 - Line 17:9)</p><button class="bg-gray-500 text-white px-1 py-0.5 text-xs rounded focus:outline-none ml-2" id="expandBtn104" onclick="toggleCodeBlock('cloneGroup104', 'expandBtn104', 'collapseBtn104')">Show code</button><button class="bg-gray-500 text-white px-1 py-0.5 text-xs rounded focus:outline-none ml-2 hidden" id="collapseBtn104" onclick="toggleCodeBlock('cloneGroup104', 'expandBtn104', 'collapseBtn104')">Hide code</button><pre class="bg-gray-100 border border-gray-200 p-4 rounded mt-2 hidden" id="cloneGroup104"><code class="language-python text-sm text-gray-800">]},
            }
        },
        'execution':{'sla':{'p95_ms':200}}
    }


def mk_market():
    return MarketSpec(
        tick_size=Decimal('0.01'), lot_size=Decimal('0.1'), min_notional=Decimal('10'),
        maker_fee_bps=1, taker_fee_bps=5, best_bid=Decimal('100'), best_ask=Decimal('100.1'),
        spread_bps=1.0, mid=Decimal('100.05')
    )


def mk_intent(equity</code></pre></div><div class="py-4"><p class="text-gray-600">tests\execution\test_low_pfill_deny.py (Line 14:9 - Line 19:8), tests\execution\test_post_only_unavailable.py (Line 18:8 - Line 24:31)</p><button class="bg-gray-500 text-white px-1 py-0.5 text-xs rounded focus:outline-none ml-2" id="expandBtn105" onclick="toggleCodeBlock('cloneGroup105', 'expandBtn105', 'collapseBtn105')">Show code</button><button class="bg-gray-500 text-white px-1 py-0.5 text-xs rounded focus:outline-none ml-2 hidden" id="collapseBtn105" onclick="toggleCodeBlock('cloneGroup105', 'expandBtn105', 'collapseBtn105')">Hide code</button><pre class="bg-gray-100 border border-gray-200 p-4 rounded mt-2 hidden" id="cloneGroup105"><code class="language-python text-sm text-gray-800">)
    spread_bps=float((best_ask-best_bid)/((best_ask+best_bid)/2)*10000)
    return MarketSpec(tick_size=Decimal('0.01'), lot_size=Decimal('0.001'), min_notional=Decimal('5'),
                      maker_fee_bps=0, taker_fee_bps=5, best_bid=best_bid, best_ask=best_ask, spread_bps=spread_bps, mid=mid)

def _router</code></pre></div><div class="py-4"><p class="text-gray-600">tests\execution\test_cvar_gate_evt.py (Line 6:1 - Line 14:42), tests\obs\test_metrics_exposition.py (Line 9:1 - Line 17:10)</p><button class="bg-gray-500 text-white px-1 py-0.5 text-xs rounded focus:outline-none ml-2" id="expandBtn106" onclick="toggleCodeBlock('cloneGroup106', 'expandBtn106', 'collapseBtn106')">Show code</button><button class="bg-gray-500 text-white px-1 py-0.5 text-xs rounded focus:outline-none ml-2 hidden" id="collapseBtn106" onclick="toggleCodeBlock('cloneGroup106', 'expandBtn106', 'collapseBtn106')">Hide code</button><pre class="bg-gray-100 border border-gray-200 p-4 rounded mt-2 hidden" id="cloneGroup106"><code class="language-python text-sm text-gray-800">def mk_market():
    return MarketSpec(
        tick_size=Decimal('0.01'), lot_size=Decimal('0.1'), min_notional=Decimal('10'),
        maker_fee_bps=1, taker_fee_bps=5, best_bid=Decimal('100'), best_ask=Decimal('100.1'),
        spread_bps=1.0, mid=Decimal('100.05')
    )


def test_cvar_gate_zeroes_qty_and_emits_shift</code></pre></div><div class="py-4"><p class="text-gray-600">tests\execution\test_cvar_feedback_stub.py (Line 1:1 - Line 12:2), tests\execution\test_sizing_kelly_min_notional.py (Line 1:1 - Line 12:2)</p><button class="bg-gray-500 text-white px-1 py-0.5 text-xs rounded focus:outline-none ml-2" id="expandBtn107" onclick="toggleCodeBlock('cloneGroup107', 'expandBtn107', 'collapseBtn107')">Show code</button><button class="bg-gray-500 text-white px-1 py-0.5 text-xs rounded focus:outline-none ml-2 hidden" id="collapseBtn107" onclick="toggleCodeBlock('cloneGroup107', 'expandBtn107', 'collapseBtn107')">Hide code</button><pre class="bg-gray-100 border border-gray-200 p-4 rounded mt-2 hidden" id="cloneGroup107"><code class="language-python text-sm text-gray-800">from decimal import Decimal
from core.risk.sizing_orchestrator import SizingOrchestrator
from core.execution.router_v2 import MarketSpec, OrderIntent
from core.aurora_event_logger import AuroraEventLogger


def _market():
    return MarketSpec(tick_size=Decimal('0.01'), lot_size=Decimal('0.001'), min_notional=Decimal('5'),
                      maker_fee_bps=0, taker_fee_bps=5, best_bid=Decimal('99.99'), best_ask=Decimal('100.01'), spread_bps=2.0, mid=Decimal('100'))


def _intent(equity_usd:str,</code></pre></div><div class="py-4"><p class="text-gray-600">tests\e2e\test_trade_flow_simulator.py (Line 13:1 - Line 22:5), tests\integration\oms\test_order_lifecycle.py (Line 9:1 - Line 17:2)</p><button class="bg-gray-500 text-white px-1 py-0.5 text-xs rounded focus:outline-none ml-2" id="expandBtn108" onclick="toggleCodeBlock('cloneGroup108', 'expandBtn108', 'collapseBtn108')">Show code</button><button class="bg-gray-500 text-white px-1 py-0.5 text-xs rounded focus:outline-none ml-2 hidden" id="collapseBtn108" onclick="toggleCodeBlock('cloneGroup108', 'expandBtn108', 'collapseBtn108')">Hide code</button><pre class="bg-gray-100 border border-gray-200 p-4 rounded mt-2 hidden" id="cloneGroup108"><code class="language-python text-sm text-gray-800">import pytest
import asyncio
import time
from decimal import Decimal
from unittest.mock import Mock, AsyncMock, patch
from typing import Dict, Any, List

from tests.fixtures.mock_exchange_factory import MockExchangeFactory
from core.execution.exchange.common import OrderRequest, Fill, Side, OrderType
from</code></pre></div><div class="py-4"><p class="text-gray-600">tests\api\test_basic_endpoints.py (Line 8:1 - Line 45:37), tests\api\test_basic_endpoints_new.py (Line 9:1 - Line 46:40)</p><button class="bg-gray-500 text-white px-1 py-0.5 text-xs rounded focus:outline-none ml-2" id="expandBtn109" onclick="toggleCodeBlock('cloneGroup109', 'expandBtn109', 'collapseBtn109')">Show code</button><button class="bg-gray-500 text-white px-1 py-0.5 text-xs rounded focus:outline-none ml-2 hidden" id="collapseBtn109" onclick="toggleCodeBlock('cloneGroup109', 'expandBtn109', 'collapseBtn109')">Hide code</button><pre class="bg-gray-100 border border-gray-200 p-4 rounded mt-2 hidden" id="cloneGroup109"><code class="language-python text-sm text-gray-800">def make_client(tmp_path) -&gt; TestClient:
    &quot;&quot;&quot;Create test client with isolated environment&quot;&quot;&quot;
    os.environ['AURORA_API_TOKEN'] = 'test_token_12345678901234567890'
    os.environ['AURORA_IP_ALLOWLIST'] = '127.0.0.1'
    os.chdir(tmp_path)

    import api.service as svc
    importlib.reload(svc)
    return TestClient(svc.app)


def setup_app_state(client):
    &quot;&quot;&quot;Setup minimal app state for testing&quot;&quot;&quot;
    app = client.app

    # Initialize basic state attributes
    if not hasattr(app.state, 'cfg'):
        app.state.cfg = {'test': 'config'}
    if not hasattr(app.state, 'trading_system'):
        app.state.trading_system = None
    if not hasattr(app.state, 'governance'):
        from aurora.governance import Governance
        app.state.governance = Governance()
    if not hasattr(app.state, 'events_emitter'):
        app.state.events_emitter = MagicMock()
    if not hasattr(app.state, 'last_event_ts'):
        app.state.last_event_ts = None
    if not hasattr(app.state, 'session_dir'):
        from pathlib import Path
        app.state.session_dir = Path('logs')

    return app


class TestBasicEndpoints:
    &quot;&quot;&quot;Test basic API endpoints that don't require complex setup&quot;&quot;&quot;

    def test_root_endpoint_redirects_to_docs</code></pre></div><div class="py-4"><p class="text-gray-600">tests\api\test_basic_endpoints.py (Line 57:7 - Line 80:4), tests\api\test_basic_endpoints_new.py (Line 56:9 - Line 78:7)</p><button class="bg-gray-500 text-white px-1 py-0.5 text-xs rounded focus:outline-none ml-2" id="expandBtn110" onclick="toggleCodeBlock('cloneGroup110', 'expandBtn110', 'collapseBtn110')">Show code</button><button class="bg-gray-500 text-white px-1 py-0.5 text-xs rounded focus:outline-none ml-2 hidden" id="collapseBtn110" onclick="toggleCodeBlock('cloneGroup110', 'expandBtn110', 'collapseBtn110')">Hide code</button><pre class="bg-gray-100 border border-gray-200 p-4 rounded mt-2 hidden" id="cloneGroup110"><code class="language-python text-sm text-gray-800">)
        response = client.get('/version')
        assert response.status_code == 200
        data = response.json()
        assert 'version' in data
        assert isinstance(data['version'], str)

    def test_health_endpoint_with_models_loaded(self, tmp_path):
        &quot;&quot;&quot;Test health endpoint when models are loaded&quot;&quot;&quot;
        client = make_client(tmp_path)
        setup_app_state(client)

        # Mock trading system as loaded
        with patch.object(client.app.state, 'trading_system') as mock_ts:
            mock_ts.student = MagicMock()
            mock_ts.router = MagicMock()

            response = client.get('/health')
            assert response.status_code == 200
            data = response.json()
            assert data['status'] == 'healthy'
            assert data['models_loaded'] is True

    def</code></pre></div><div class="py-4"><p class="text-gray-600">tests\api\test_basic_endpoints.py (Line 80:5 - Line 90:46), tests\api\test_basic_endpoints_new.py (Line 80:5 - Line 91:7)</p><button class="bg-gray-500 text-white px-1 py-0.5 text-xs rounded focus:outline-none ml-2" id="expandBtn111" onclick="toggleCodeBlock('cloneGroup111', 'expandBtn111', 'collapseBtn111')">Show code</button><button class="bg-gray-500 text-white px-1 py-0.5 text-xs rounded focus:outline-none ml-2 hidden" id="collapseBtn111" onclick="toggleCodeBlock('cloneGroup111', 'expandBtn111', 'collapseBtn111')">Hide code</button><pre class="bg-gray-100 border border-gray-200 p-4 rounded mt-2 hidden" id="cloneGroup111"><code class="language-python text-sm text-gray-800">def test_health_endpoint_with_models_not_loaded(self, tmp_path):
        &quot;&quot;&quot;Test health endpoint when models are not loaded&quot;&quot;&quot;
        client = make_client(tmp_path)
        setup_app_state(client)

        # Mock trading system as not loaded
        with patch.object(client.app.state, 'trading_system', None):
            response = client.get('/health')
            assert response.status_code == 200
            data = response.json()
            assert data['status'] == 'starting'  # Status is 'starting' when models not loaded</code></pre></div><div class="py-4"><p class="text-gray-600">skalp_bot\runner\run_live_aurora.py (Line 553:2 - Line 564:8), skalp_bot\runner\run_live_aurora.py (Line 505:10 - Line 516:13)</p><button class="bg-gray-500 text-white px-1 py-0.5 text-xs rounded focus:outline-none ml-2" id="expandBtn112" onclick="toggleCodeBlock('cloneGroup112', 'expandBtn112', 'collapseBtn112')">Show code</button><button class="bg-gray-500 text-white px-1 py-0.5 text-xs rounded focus:outline-none ml-2 hidden" id="collapseBtn112" onclick="toggleCodeBlock('cloneGroup112', 'expandBtn112', 'collapseBtn112')">Hide code</button><pre class="bg-gray-100 border border-gray-200 p-4 rounded mt-2 hidden" id="cloneGroup112"><code class="language-python text-sm text-gray-800">)
            except Exception as e:
                error_msg = str(e)
                why_code = &quot;WHY_EX_REJECT&quot;
                if &quot;rate limit&quot; in error_msg.lower():
                    why_code = &quot;WHY_RATE_LIMIT&quot;
                elif &quot;timeout&quot; in error_msg.lower() or &quot;connection&quot; in error_msg.lower():
                    why_code = &quot;WHY_CONN_ERR&quot;

                _log_events(&quot;ORDER.REJECT&quot;, {
                    &quot;details&quot;: {
                        &quot;close&quot;</code></pre></div><div class="py-4"><p class="text-gray-600">core\universe\ranking.py (Line 63:1 - Line 75:6), core\xai\alerts.py (Line 65:1 - Line 77:49)</p><button class="bg-gray-500 text-white px-1 py-0.5 text-xs rounded focus:outline-none ml-2" id="expandBtn113" onclick="toggleCodeBlock('cloneGroup113', 'expandBtn113', 'collapseBtn113')">Show code</button><button class="bg-gray-500 text-white px-1 py-0.5 text-xs rounded focus:outline-none ml-2 hidden" id="collapseBtn113" onclick="toggleCodeBlock('cloneGroup113', 'expandBtn113', 'collapseBtn113')">Hide code</button><pre class="bg-gray-100 border border-gray-200 p-4 rounded mt-2 hidden" id="cloneGroup113"><code class="language-python text-sm text-gray-800">def _quantile(xs: List[float], q: float) -&gt; float:
    if not xs:
        return 0.0
    q = 0.0 if q &lt; 0.0 else 1.0 if q &gt; 1.0 else q
    xs2 = sorted(xs)
    pos = q * (len(xs2) - 1)
    lo = int(pos)
    hi = min(lo + 1, len(xs2) - 1)
    frac = pos - lo
    return xs2[lo] * (1 - frac) + xs2[hi] * frac


class</code></pre></div><div class="py-4"><p class="text-gray-600">core\tca\tca_analyzer.py (Line 427:4 - Line 445:2), core\tca\tca_analyzer.py (Line 140:11 - Line 159:2)</p><button class="bg-gray-500 text-white px-1 py-0.5 text-xs rounded focus:outline-none ml-2" id="expandBtn114" onclick="toggleCodeBlock('cloneGroup114', 'expandBtn114', 'collapseBtn114')">Show code</button><button class="bg-gray-500 text-white px-1 py-0.5 text-xs rounded focus:outline-none ml-2 hidden" id="collapseBtn114" onclick="toggleCodeBlock('cloneGroup114', 'expandBtn114', 'collapseBtn114')">Hide code</button><pre class="bg-gray-100 border border-gray-200 p-4 rounded mt-2 hidden" id="cloneGroup114"><code class="language-python text-sm text-gray-800">,
            time_to_first_fill_ms=0.0,
            total_execution_time_ms=0.0,
            fill_ratio=0.0,
            maker_fill_ratio=0.0,
            taker_fill_ratio=0.0,
            avg_queue_position=None,
            raw_edge_bps=0.0,
            fees_bps=0.0,
            slippage_in_bps=0.0,
            slippage_out_bps=0.0,
            adverse_bps=0.0,
            latency_bps=0.0,
            impact_bps=0.0,
            rebate_bps=0.0,
            implementation_shortfall_bps=0.0,
            realized_spread_bps=0.0,
            effective_spread_bps=0.0,
            analysis_ts_ns=int(time.time_ns()),</code></pre></div><div class="py-4"><p class="text-gray-600">core\risk\cvar.py (Line 18:1 - Line 33:23), core\risk\evt_pot.py (Line 25:1 - Line 40:12)</p><button class="bg-gray-500 text-white px-1 py-0.5 text-xs rounded focus:outline-none ml-2" id="expandBtn115" onclick="toggleCodeBlock('cloneGroup115', 'expandBtn115', 'collapseBtn115')">Show code</button><button class="bg-gray-500 text-white px-1 py-0.5 text-xs rounded focus:outline-none ml-2 hidden" id="collapseBtn115" onclick="toggleCodeBlock('cloneGroup115', 'expandBtn115', 'collapseBtn115')">Hide code</button><pre class="bg-gray-100 border border-gray-200 p-4 rounded mt-2 hidden" id="cloneGroup115"><code class="language-python text-sm text-gray-800">from __future__ import annotations

from dataclasses import dataclass
from typing import Deque, Dict, Iterable, List, Optional, Sequence, Tuple
import bisect
import math
import random
from collections import deque

try:
    import numpy as np  # type: ignore
except Exception:  # pragma: no cover
    np = None  # type: ignore

# =============================
# Empirical VaR / CVaR</code></pre></div><div class="py-4"><p class="text-gray-600">core\regime\manager.py (Line 40:1 - Line 52:11), core\xai\alerts.py (Line 65:1 - Line 77:49)</p><button class="bg-gray-500 text-white px-1 py-0.5 text-xs rounded focus:outline-none ml-2" id="expandBtn116" onclick="toggleCodeBlock('cloneGroup116', 'expandBtn116', 'collapseBtn116')">Show code</button><button class="bg-gray-500 text-white px-1 py-0.5 text-xs rounded focus:outline-none ml-2 hidden" id="collapseBtn116" onclick="toggleCodeBlock('cloneGroup116', 'expandBtn116', 'collapseBtn116')">Hide code</button><pre class="bg-gray-100 border border-gray-200 p-4 rounded mt-2 hidden" id="cloneGroup116"><code class="language-python text-sm text-gray-800">def _quantile(xs: List[float], q: float) -&gt; float:
    if not xs:
        return 0.0
    q = 0.0 if q &lt; 0.0 else 1.0 if q &gt; 1.0 else q
    xs2 = sorted(xs)
    pos = q * (len(xs2) - 1)
    lo = int(pos)
    hi = min(lo + 1, len(xs2) - 1)
    frac = pos - lo
    return xs2[lo] * (1 - frac) + xs2[hi] * frac


@dataclass</code></pre></div><div class="py-4"><p class="text-gray-600">core\market\websocket_client.py (Line 145:9 - Line 156:40), core\market\websocket_client.py (Line 107:9 - Line 118:54)</p><button class="bg-gray-500 text-white px-1 py-0.5 text-xs rounded focus:outline-none ml-2" id="expandBtn117" onclick="toggleCodeBlock('cloneGroup117', 'expandBtn117', 'collapseBtn117')">Show code</button><button class="bg-gray-500 text-white px-1 py-0.5 text-xs rounded focus:outline-none ml-2 hidden" id="collapseBtn117" onclick="toggleCodeBlock('cloneGroup117', 'expandBtn117', 'collapseBtn117')">Hide code</button><pre class="bg-gray-100 border border-gray-200 p-4 rounded mt-2 hidden" id="cloneGroup117"><code class="language-python text-sm text-gray-800">ssl_context = ssl.create_default_context()

        try:
            async with websockets.connect(url, ssl=ssl_context) as websocket:
                self._log_event(&quot;WS.CONNECT&quot;, {&quot;url&quot;: url, &quot;symbol&quot;: symbol}, symbol.upper())

                while self._running:
                    try:
                        message = await asyncio.wait_for(websocket.recv(), timeout=30)
                        data = json.loads(message)

                        # Binance sends event type in 'e' field</code></pre></div><div class="py-4"><p class="text-gray-600">core\ingestion\sync_clock.py (Line 136:5 - Line 149:4), core\ingestion\sync_clock.py (Line 86:5 - Line 99:71)</p><button class="bg-gray-500 text-white px-1 py-0.5 text-xs rounded focus:outline-none ml-2" id="expandBtn118" onclick="toggleCodeBlock('cloneGroup118', 'expandBtn118', 'collapseBtn118')">Show code</button><button class="bg-gray-500 text-white px-1 py-0.5 text-xs rounded focus:outline-none ml-2 hidden" id="collapseBtn118" onclick="toggleCodeBlock('cloneGroup118', 'expandBtn118', 'collapseBtn118')">Hide code</button><pre class="bg-gray-100 border border-gray-200 p-4 rounded mt-2 hidden" id="cloneGroup118"><code class="language-python text-sm text-gray-800">def now_ns(self) -&gt; int:
        return time.perf_counter_ns()

    def sleep_until_wall_ns(self, target_wall_ns: int) -&gt; None:
        remaining = target_wall_ns - self.now_ns()
        if remaining &gt; 0:
            # Apply max_sleep_ns clamp if configured
            if self.max_sleep_ns is not None and remaining &gt; self.max_sleep_ns:
                actual_target = self.now_ns() + self.max_sleep_ns
                time.sleep(_ns_to_seconds(self.max_sleep_ns))
            else:
                time.sleep(_ns_to_seconds(remaining))

    def</code></pre></div><div class="py-4"><p class="text-gray-600">core\governance\sprt_glr.py (Line 262:16 - Line 267:19), core\governance\sprt_glr.py (Line 257:19 - Line 262:16)</p><button class="bg-gray-500 text-white px-1 py-0.5 text-xs rounded focus:outline-none ml-2" id="expandBtn119" onclick="toggleCodeBlock('cloneGroup119', 'expandBtn119', 'collapseBtn119')">Show code</button><button class="bg-gray-500 text-white px-1 py-0.5 text-xs rounded focus:outline-none ml-2 hidden" id="collapseBtn119" onclick="toggleCodeBlock('cloneGroup119', 'expandBtn119', 'collapseBtn119')">Hide code</button><pre class="bg-gray-100 border border-gray-200 p-4 rounded mt-2 hidden" id="cloneGroup119"><code class="language-python text-sm text-gray-800">(alpha: float = 0.05, mu0: float = 0.0, mu1: float = 0.1, beta: float = 0.2, min_samples: int = 5, max_samples: Optional[int] = None) -&gt; &quot;CompositeSPRT&quot;:
    cfg = SPRTConfig(mu0=mu0, mu1=mu1, alpha=alpha, beta=beta, min_samples=min_samples, max_samples=max_samples)
    return CompositeSPRT(cfg)


def create_sprt_bh_fdr</code></pre></div><div class="py-4"><p class="text-gray-600">core\governance\sprt_glr.py (Line 267:19 - Line 272:8), core\governance\sprt_glr.py (Line 257:19 - Line 262:4)</p><button class="bg-gray-500 text-white px-1 py-0.5 text-xs rounded focus:outline-none ml-2" id="expandBtn120" onclick="toggleCodeBlock('cloneGroup120', 'expandBtn120', 'collapseBtn120')">Show code</button><button class="bg-gray-500 text-white px-1 py-0.5 text-xs rounded focus:outline-none ml-2 hidden" id="collapseBtn120" onclick="toggleCodeBlock('cloneGroup120', 'expandBtn120', 'collapseBtn120')">Hide code</button><pre class="bg-gray-100 border border-gray-200 p-4 rounded mt-2 hidden" id="cloneGroup120"><code class="language-python text-sm text-gray-800">(alpha: float = 0.05, mu0: float = 0.0, mu1: float = 0.1, beta: float = 0.2, min_samples: int = 5, max_samples: Optional[int] = None) -&gt; &quot;CompositeSPRT&quot;:
    cfg = SPRTConfig(mu0=mu0, mu1=mu1, alpha=alpha, beta=beta, min_samples=min_samples, max_samples=max_samples)
    return CompositeSPRT(cfg)


__all__</code></pre></div><div class="py-4"><p class="text-gray-600">core\governance\alpha_ledger.py (Line 305:2 - Line 315:4), core\governance\alpha_ledger.py (Line 283:2 - Line 295:4)</p><button class="bg-gray-500 text-white px-1 py-0.5 text-xs rounded focus:outline-none ml-2" id="expandBtn121" onclick="toggleCodeBlock('cloneGroup121', 'expandBtn121', 'collapseBtn121')">Show code</button><button class="bg-gray-500 text-white px-1 py-0.5 text-xs rounded focus:outline-none ml-2 hidden" id="collapseBtn121" onclick="toggleCodeBlock('cloneGroup121', 'expandBtn121', 'collapseBtn121')">Hide code</button><pre class="bg-gray-100 border border-gray-200 p-4 rounded mt-2 hidden" id="cloneGroup121"><code class="language-python text-sm text-gray-800">AlphaTxn(
                ts_ns_mono=txn.ts_ns_mono,
                ts_ns_wall=txn.ts_ns_wall,
                test_id=txn.test_id,
                alpha0=txn.alpha0,
                spent=txn.spent,
                outcome=txn.outcome,
                token=txn.token,
                history=list(txn.history),
                closed_ts_ns=txn.closed_ts_ns,
            ) for</code></pre></div><div class="py-4"><p class="text-gray-600">core\features\tfi.py (Line 217:2 - Line 224:26), core\features\tfi.py (Line 203:4 - Line 210:22)</p><button class="bg-gray-500 text-white px-1 py-0.5 text-xs rounded focus:outline-none ml-2" id="expandBtn122" onclick="toggleCodeBlock('cloneGroup122', 'expandBtn122', 'collapseBtn122')">Show code</button><button class="bg-gray-500 text-white px-1 py-0.5 text-xs rounded focus:outline-none ml-2 hidden" id="collapseBtn122" onclick="toggleCodeBlock('cloneGroup122', 'expandBtn122', 'collapseBtn122')">Hide code</button><pre class="bg-gray-100 border border-gray-200 p-4 rounded mt-2 hidden" id="cloneGroup122"><code class="language-python text-sm text-gray-800">)
        size = max(0.1, 10.0 + random.gauss(0.0, 3.0))
        ts += max(0.0, random.expovariate(20.0))
        out.append(Trade(timestamp=ts, price=100.0, size=size, side=Side.BUY if is_buy else Side.SELL))
    return out


def _test_event_time_tfi_vpin</code></pre></div><div class="py-4"><p class="text-gray-600">core\features\microstructure.py (Line 39:5 - Line 59:2), core\signal\leadlag_hy.py (Line 42:5 - Line 62:84)</p><button class="bg-gray-500 text-white px-1 py-0.5 text-xs rounded focus:outline-none ml-2" id="expandBtn123" onclick="toggleCodeBlock('cloneGroup123', 'expandBtn123', 'collapseBtn123')">Show code</button><button class="bg-gray-500 text-white px-1 py-0.5 text-xs rounded focus:outline-none ml-2 hidden" id="collapseBtn123" onclick="toggleCodeBlock('cloneGroup123', 'expandBtn123', 'collapseBtn123')">Hide code</button><pre class="bg-gray-100 border border-gray-200 p-4 rounded mt-2 hidden" id="cloneGroup123"><code class="language-python text-sm text-gray-800">@dataclass
    class Trade:
        timestamp: float
        price: float
        size: float
        side: Side

    @dataclass
    class MarketSnapshot:
        timestamp: float
        bid_price: float
        ask_price: float
        bid_volumes_l: Sequence[float]
        ask_volumes_l: Sequence[float]
        trades: Sequence[Trade]

        @property
        def mid(self) -&gt; float:
            return 0.5 * (self.bid_price + self.ask_price)

        @</code></pre></div><div class="py-4"><p class="text-gray-600">core\features\absorption.py (Line 369:11 - Line 378:8), core\features\absorption.py (Line 269:6 - Line 277:7)</p><button class="bg-gray-500 text-white px-1 py-0.5 text-xs rounded focus:outline-none ml-2" id="expandBtn124" onclick="toggleCodeBlock('cloneGroup124', 'expandBtn124', 'collapseBtn124')">Show code</button><button class="bg-gray-500 text-white px-1 py-0.5 text-xs rounded focus:outline-none ml-2 hidden" id="collapseBtn124" onclick="toggleCodeBlock('cloneGroup124', 'expandBtn124', 'collapseBtn124')">Hide code</button><pre class="bg-gray-100 border border-gray-200 p-4 rounded mt-2 hidden" id="cloneGroup124"><code class="language-python text-sm text-gray-800">.append(MarketSnapshot(
            timestamp=ts,
            bid_price=bid,
            ask_price=ask,
            bid_volumes_l=[qb, 400, 300, 200, 100],
            ask_volumes_l=[qa, 380, 280, 180, 80],
            trades=tuple(tr for tr in trades if ts - tr.timestamp &lt;= 5.0),
        ))

    ab_high</code></pre></div><div class="py-4"><p class="text-gray-600">core\execution\sim_local_sink.py (Line 167:21 - Line 180:5), core\execution\sim_local_sink.py (Line 143:21 - Line 156:5)</p><button class="bg-gray-500 text-white px-1 py-0.5 text-xs rounded focus:outline-none ml-2" id="expandBtn125" onclick="toggleCodeBlock('cloneGroup125', 'expandBtn125', 'collapseBtn125')">Show code</button><button class="bg-gray-500 text-white px-1 py-0.5 text-xs rounded focus:outline-none ml-2 hidden" id="collapseBtn125" onclick="toggleCodeBlock('cloneGroup125', 'expandBtn125', 'collapseBtn125')">Hide code</button><pre class="bg-gray-100 border border-gray-200 p-4 rounded mt-2 hidden" id="cloneGroup125"><code class="language-python text-sm text-gray-800">evt = {
                        'order_id': oid,
                        'ts': time.strftime('%Y-%m-%dT%H:%M:%S') + 'Z',
                        'side': o.get('side'),
                        'px': None,
                        'qty': o['orig_qty'],
                        'status': status,
                        'reason': reason,
                        'latency_ms_action': latency_action,
                        'latency_ms_fill': None,
                        'maker_queue_pos': None,
                        'fill_qty_step': 0.0,
                        'fill_ratio': 0.0,
                        'slip_bps': None</code></pre></div><div class="py-4"><p class="text-gray-600">core\execution\sim_local_sink.py (Line 331:2 - Line 342:9), core\execution\sim_local_sink.py (Line 111:15 - Line 122:7)</p><button class="bg-gray-500 text-white px-1 py-0.5 text-xs rounded focus:outline-none ml-2" id="expandBtn126" onclick="toggleCodeBlock('cloneGroup126', 'expandBtn126', 'collapseBtn126')">Show code</button><button class="bg-gray-500 text-white px-1 py-0.5 text-xs rounded focus:outline-none ml-2 hidden" id="collapseBtn126" onclick="toggleCodeBlock('cloneGroup126', 'expandBtn126', 'collapseBtn126')">Hide code</button><pre class="bg-gray-100 border border-gray-200 p-4 rounded mt-2 hidden" id="cloneGroup126"><code class="language-python text-sm text-gray-800">,
                        'latency_ms_fill': None,
                        'maker_queue_pos': None,
                        'fill_qty_step': 0.0,
                        'fill_ratio': 0.0,
                        'slip_bps': None,
                        'ttl_ms': self.ttl_ms,
                    }
                    self._emit_seed_if_needed(evt)
                    self._ev.emit('ORDER_STATUS(sim)', evt)
                    del self._orders[oid]
                continue</code></pre></div><div class="py-4"><p class="text-gray-600">core\execution\router_backup.py (Line 247:13 - Line 273:8), core\execution\router_backup.py (Line 215:13 - Line 241:8)</p><button class="bg-gray-500 text-white px-1 py-0.5 text-xs rounded focus:outline-none ml-2" id="expandBtn127" onclick="toggleCodeBlock('cloneGroup127', 'expandBtn127', 'collapseBtn127')">Show code</button><button class="bg-gray-500 text-white px-1 py-0.5 text-xs rounded focus:outline-none ml-2 hidden" id="collapseBtn127" onclick="toggleCodeBlock('cloneGroup127', 'expandBtn127', 'collapseBtn127')">Hide code</button><pre class="bg-gray-100 border border-gray-200 p-4 rounded mt-2 hidden" id="cloneGroup127"><code class="language-python text-sm text-gray-800">if e_maker &gt; 0.0 and p_fill &gt;= self._min_p:
                return RouteDecision(
                    route=&quot;maker&quot;,
                    e_maker_bps=e_maker,
                    e_taker_bps=e_taker,
                    p_fill=p_fill,
                    reason=f&quot;SLA denied taker, fallback to maker (E_maker={e_maker:.2f}bps, Pfill={p_fill:.2f})&quot;,
                    maker_fee_bps=self._fees.maker_fee_bps,
                    taker_fee_bps=self._fees.taker_fee_bps,
                    net_e_maker_bps=e_maker,
                    net_e_taker_bps=e_taker,
                    scores={&quot;expected_maker_bps&quot;: e_maker, &quot;taker_bps&quot;: e_taker, &quot;p_fill&quot;: p_fill}
                )

            # Special-case: if P(fill) is very low (below taker threshold) but taker
            # edge is positive, prefer taker despite SLA edge floor. Tests rely on
            # this behaviour for low-P scenarios.
            if p_fill &lt; p_taker_threshold and e_taker &gt; 0.0:
                return RouteDecision(
                    route=&quot;taker&quot;,
                    e_maker_bps=e_maker,
                    e_taker_bps=e_taker,
                    p_fill=p_fill,
                    reason=f&quot;Low Pfill {p_fill:.2f} &lt; {p_taker_threshold:.2f}; override SLA and prefer taker (E_taker={e_taker:.2f})&quot;,
                    maker_fee_bps=self._fees.maker_fee_bps,
                    taker_fee_bps=self._fees.taker_fee_bps,
                    net_e_maker_bps=e_taker</code></pre></div><div class="py-4"><p class="text-gray-600">core\execution\router_backup.py (Line 361:123 - Line 397:64), core\execution\router_backup.py (Line 309:91 - Line 345:84)</p><button class="bg-gray-500 text-white px-1 py-0.5 text-xs rounded focus:outline-none ml-2" id="expandBtn128" onclick="toggleCodeBlock('cloneGroup128', 'expandBtn128', 'collapseBtn128')">Show code</button><button class="bg-gray-500 text-white px-1 py-0.5 text-xs rounded focus:outline-none ml-2 hidden" id="collapseBtn128" onclick="toggleCodeBlock('cloneGroup128', 'expandBtn128', 'collapseBtn128')">Hide code</button><pre class="bg-gray-100 border border-gray-200 p-4 rounded mt-2 hidden" id="cloneGroup128"><code class="language-python text-sm text-gray-800">,
                maker_fee_bps=self._fees.maker_fee_bps,
                taker_fee_bps=self._fees.taker_fee_bps,
                net_e_maker_bps=maker_net,
                net_e_taker_bps=taker_net,
                scores={&quot;expected_maker_bps&quot;: exp_maker, &quot;taker_bps&quot;: taker_net, &quot;p_fill&quot;: p_fill},
            )

        # Standard decision logic: choose route with higher expected edge
        if taker_net &gt;= exp_maker and taker_net &gt; 0.0:
            return RouteDecision(
                route=&quot;taker&quot;,
                e_maker_bps=e_maker,
                e_taker_bps=e_taker,
                p_fill=p_fill,
                reason=f&quot;E_taker {taker_net:.2f} ≥ E_maker {exp_maker:.2f}; SLA OK&quot;,
                maker_fee_bps=self._fees.maker_fee_bps,
                taker_fee_bps=self._fees.taker_fee_bps,
                net_e_maker_bps=maker_net,
                net_e_taker_bps=taker_net,
                scores={&quot;expected_maker_bps&quot;: exp_maker, &quot;taker_bps&quot;: taker_net, &quot;p_fill&quot;: p_fill}
            )
        if exp_maker &gt; taker_net and exp_maker &gt; 0.0 and p_fill &gt;= self._min_p:
            return RouteDecision(
                route=&quot;maker&quot;,
                e_maker_bps=e_maker,
                e_taker_bps=e_taker,
                p_fill=p_fill,
                reason=f&quot;E_maker {exp_maker:.2f} &gt; E_taker {taker_net:.2f}; Pfill {p_fill:.2f} ≥ {self._min_p:.2f}&quot;,
                maker_fee_bps=self._fees.maker_fee_bps,
                taker_fee_bps=self._fees.taker_fee_bps,
                net_e_maker_bps=maker_net,
                net_e_taker_bps=taker_net,
                scores={&quot;expected_maker_bps&quot;: exp_maker, &quot;taker_bps&quot;: taker_net, &quot;p_fill&quot;: p_fill}
            )

        # None attractive - use correct net edges in the denial message</code></pre></div><div class="py-4"><p class="text-gray-600">core\execution\router.py (Line 66:1 - Line 82:10), core\execution\router_new.py (Line 14:1 - Line 30:7)</p><button class="bg-gray-500 text-white px-1 py-0.5 text-xs rounded focus:outline-none ml-2" id="expandBtn129" onclick="toggleCodeBlock('cloneGroup129', 'expandBtn129', 'collapseBtn129')">Show code</button><button class="bg-gray-500 text-white px-1 py-0.5 text-xs rounded focus:outline-none ml-2 hidden" id="collapseBtn129" onclick="toggleCodeBlock('cloneGroup129', 'expandBtn129', 'collapseBtn129')">Hide code</button><pre class="bg-gray-100 border border-gray-200 p-4 rounded mt-2 hidden" id="cloneGroup129"><code class="language-python text-sm text-gray-800">def _clip01(x: float) -&gt; float:
    return 0.0 if x &lt; 0.0 else (1.0 if x &gt; 1.0 else x)


def _estimate_p_fill(fill_features: Dict[str, Any]) -&gt; float:
    &quot;&quot;&quot;
    Простий, детермінований естіматор P(fill) із ознак:
    - OBI in [-1,1] збільшує P
    - spread_bps зменшує P (5 bps ~ -0.25 до P)
    &quot;&quot;&quot;
    obi = float(fill_features.get(&quot;obi&quot;, 0.0))
    spread_bps = float(fill_features.get(&quot;spread_bps&quot;, 0.0))
    p = 0.5 + 0.5 * obi - 0.05 * spread_bps
    return _clip01(p)


class XaiLogger</code></pre></div><div class="py-4"><p class="text-gray-600">core\execution\router.py (Line 131:3 - Line 144:19), core\execution\router_new.py (Line 49:2 - Line 62:7)</p><button class="bg-gray-500 text-white px-1 py-0.5 text-xs rounded focus:outline-none ml-2" id="expandBtn130" onclick="toggleCodeBlock('cloneGroup130', 'expandBtn130', 'collapseBtn130')">Show code</button><button class="bg-gray-500 text-white px-1 py-0.5 text-xs rounded focus:outline-none ml-2 hidden" id="collapseBtn130" onclick="toggleCodeBlock('cloneGroup130', 'expandBtn130', 'collapseBtn130')">Hide code</button><pre class="bg-gray-100 border border-gray-200 p-4 rounded mt-2 hidden" id="cloneGroup130"><code class="language-python text-sm text-gray-800">.get(&quot;sla&quot;, {})

        self.edge_floor_bps: float = float(ex.get(&quot;edge_floor_bps&quot;, 0.0))
        self.p_min_fill: float = float(r.get(&quot;p_min_fill&quot;, 0.25))
        self.horizon_ms: int = int(r.get(&quot;horizon_ms&quot;, 1500))
        self.kappa_bps_per_ms: float = float(sla.get(&quot;kappa_bps_per_ms&quot;, 0.0))
        self.max_latency_ms: float = float(sla.get(&quot;max_latency_ms&quot;, float(&quot;inf&quot;)))

        # додаткові пороги
        self.spread_deny_bps: float = float(r.get(&quot;spread_deny_bps&quot;, 8.0))
        self.maker_spread_ok_bps: float = float(r.get(&quot;maker_spread_ok_bps&quot;, 2.0))
        self.switch_margin_bps: float = float(r.get(&quot;switch_margin_bps&quot;, 0.0))

    def _init_from_modules</code></pre></div><div class="py-4"><p class="text-gray-600">core\execution\enhanced_router.py (Line 21:1 - Line 34:11), core\execution\router_backup.py (Line 41:1 - Line 55:2)</p><button class="bg-gray-500 text-white px-1 py-0.5 text-xs rounded focus:outline-none ml-2" id="expandBtn131" onclick="toggleCodeBlock('cloneGroup131', 'expandBtn131', 'collapseBtn131')">Show code</button><button class="bg-gray-500 text-white px-1 py-0.5 text-xs rounded focus:outline-none ml-2 hidden" id="collapseBtn131" onclick="toggleCodeBlock('cloneGroup131', 'expandBtn131', 'collapseBtn131')">Hide code</button><pre class="bg-gray-100 border border-gray-200 p-4 rounded mt-2 hidden" id="cloneGroup131"><code class="language-python text-sm text-gray-800">from core.config.loader import get_config, ConfigError
from core.execution.exchange.common import Fees
from core.tca.hazard_cox import CoxPH
from core.tca.latency import SLAGate


@dataclass
class QuoteSnapshot:
    bid_px: float
    ask_px: float
    bid_sz: float = 0.0
    ask_sz: float = 0.0
    ts_ns: int = 0
    spread_bps</code></pre></div><div class="py-4"><p class="text-gray-600">core\execution\enhanced_router.py (Line 82:5 - Line 91:18), core\execution\router_backup.py (Line 82:5 - Line 91:10)</p><button class="bg-gray-500 text-white px-1 py-0.5 text-xs rounded focus:outline-none ml-2" id="expandBtn132" onclick="toggleCodeBlock('cloneGroup132', 'expandBtn132', 'collapseBtn132')">Show code</button><button class="bg-gray-500 text-white px-1 py-0.5 text-xs rounded focus:outline-none ml-2 hidden" id="collapseBtn132" onclick="toggleCodeBlock('cloneGroup132', 'expandBtn132', 'collapseBtn132')">Hide code</button><pre class="bg-gray-100 border border-gray-200 p-4 rounded mt-2 hidden" id="cloneGroup132"><code class="language-python text-sm text-gray-800">def __init__(
        self,
        *,
        hazard_model: Optional[CoxPH] = None,
        slagate: Optional[SLAGate] = None,
        min_p_fill: Optional[float] = None,
        fees: Optional[Fees] = None,
        exchange_name: str = &quot;default&quot;,
    ) -&gt; None:
        # Core components</code></pre></div><div class="py-4"><p class="text-gray-600">core\config\hotreload.py (Line 35:1 - Line 46:11), core\config\loader.py (Line 87:1 - Line 97:11)</p><button class="bg-gray-500 text-white px-1 py-0.5 text-xs rounded focus:outline-none ml-2" id="expandBtn133" onclick="toggleCodeBlock('cloneGroup133', 'expandBtn133', 'collapseBtn133')">Show code</button><button class="bg-gray-500 text-white px-1 py-0.5 text-xs rounded focus:outline-none ml-2 hidden" id="collapseBtn133" onclick="toggleCodeBlock('cloneGroup133', 'expandBtn133', 'collapseBtn133')">Hide code</button><pre class="bg-gray-100 border border-gray-200 p-4 rounded mt-2 hidden" id="cloneGroup133"><code class="language-python text-sm text-gray-800">def _flatten(d: Mapping[str, Any], prefix: str = &quot;&quot;) -&gt; Dict[str, Any]:
    out: Dict[str, Any] = {}
    for k, v in d.items():
        key = f&quot;{prefix}.{k}&quot; if prefix else k
        if isinstance(v, Mapping):
            out.update(_flatten(v, key))
        else:
            out[key] = v
    return out


def diff_dicts</code></pre></div><div class="py-4"><p class="text-gray-600">core\config\hotreload.py (Line 48:5 - Line 57:51), core\config\loader.py (Line 98:5 - Line 107:66)</p><button class="bg-gray-500 text-white px-1 py-0.5 text-xs rounded focus:outline-none ml-2" id="expandBtn134" onclick="toggleCodeBlock('cloneGroup134', 'expandBtn134', 'collapseBtn134')">Show code</button><button class="bg-gray-500 text-white px-1 py-0.5 text-xs rounded focus:outline-none ml-2 hidden" id="collapseBtn134" onclick="toggleCodeBlock('cloneGroup134', 'expandBtn134', 'collapseBtn134')">Hide code</button><pre class="bg-gray-100 border border-gray-200 p-4 rounded mt-2 hidden" id="cloneGroup134"><code class="language-python text-sm text-gray-800">a = _flatten(old)
    b = _flatten(new)
    changed: Set[str] = set()
    keys = set(a.keys()).union(b.keys())
    for k in keys:
        if a.get(k) != b.get(k):
            changed.add(k)
    return changed

# -------------------- Policy --------------------</code></pre></div><div class="py-4"><p class="text-gray-600">core\canary\canary_system.py (Line 353:2 - Line 361:26), core\canary\canary_system.py (Line 274:2 - Line 282:22)</p><button class="bg-gray-500 text-white px-1 py-0.5 text-xs rounded focus:outline-none ml-2" id="expandBtn135" onclick="toggleCodeBlock('cloneGroup135', 'expandBtn135', 'collapseBtn135')">Show code</button><button class="bg-gray-500 text-white px-1 py-0.5 text-xs rounded focus:outline-none ml-2 hidden" id="collapseBtn135" onclick="toggleCodeBlock('cloneGroup135', 'expandBtn135', 'collapseBtn135')">Hide code</button><pre class="bg-gray-100 border border-gray-200 p-4 rounded mt-2 hidden" id="cloneGroup135"><code class="language-python text-sm text-gray-800">{
                &quot;orders_placed&quot;: self.metrics.orders_placed,
                &quot;orders_filled&quot;: self.metrics.orders_filled,
                &quot;orders_cancelled&quot;: self.metrics.orders_cancelled,
                &quot;total_volume_usd&quot;: self.metrics.total_volume_usd,
                &quot;total_pnl_usd&quot;: self.metrics.total_pnl_usd,
                &quot;cancel_ratio&quot;: self.metrics.cancel_ratio,
                &quot;maker_fill_ratio&quot;: self.metrics.maker_fill_ratio,
                &quot;kill_switches_triggered&quot;</code></pre></div><div class="py-4"><p class="text-gray-600">tools\simple_mutator.py (Line 21:5 - Line 29:17), tools\ultra_simple_mutator.py (Line 21:5 - Line 29:24)</p><button class="bg-gray-500 text-white px-1 py-0.5 text-xs rounded focus:outline-none ml-2" id="expandBtn136" onclick="toggleCodeBlock('cloneGroup136', 'expandBtn136', 'collapseBtn136')">Show code</button><button class="bg-gray-500 text-white px-1 py-0.5 text-xs rounded focus:outline-none ml-2 hidden" id="collapseBtn136" onclick="toggleCodeBlock('cloneGroup136', 'expandBtn136', 'collapseBtn136')">Hide code</button><pre class="bg-gray-100 border border-gray-200 p-4 rounded mt-2 hidden" id="cloneGroup136"><code class="language-python text-sm text-gray-800">def __init__(self, source_dir: str, test_command: str, timeout: int = 30):
        self.source_dir = Path(source_dir)
        self.test_command = test_command
        self.timeout = timeout
        self.mutants_created = 0
        self.mutants_killed = 0
        self.mutants_survived = 0

    def get_python_files</code></pre></div><div class="py-4"><p class="text-gray-600">tools\simple_mutator.py (Line 209:9 - Line 231:62), tools\ultra_simple_mutator.py (Line 317:9 - Line 339:68)</p><button class="bg-gray-500 text-white px-1 py-0.5 text-xs rounded focus:outline-none ml-2" id="expandBtn137" onclick="toggleCodeBlock('cloneGroup137', 'expandBtn137', 'collapseBtn137')">Show code</button><button class="bg-gray-500 text-white px-1 py-0.5 text-xs rounded focus:outline-none ml-2 hidden" id="collapseBtn137" onclick="toggleCodeBlock('cloneGroup137', 'expandBtn137', 'collapseBtn137')">Hide code</button><pre class="bg-gray-100 border border-gray-200 p-4 rounded mt-2 hidden" id="cloneGroup137"><code class="language-python text-sm text-gray-800"># Calculate results
        mutation_score = (self.mutants_killed / self.mutants_created * 100) if self.mutants_created &gt; 0 else 0

        results = {
            &quot;total_files&quot;: len(python_files),
            &quot;total_mutants&quot;: self.mutants_created,
            &quot;killed_mutants&quot;: self.mutants_killed,
            &quot;survived_mutants&quot;: self.mutants_survived,
            &quot;mutation_score&quot;: round(mutation_score, 2),
            &quot;timestamp&quot;: time.time()
        }

        print(&quot;\n📊 Mutation Testing Results:&quot;)
        print(f&quot;   Total mutants: {results['total_mutants']}&quot;)
        print(f&quot;   Killed: {results['killed_mutants']}&quot;)
        print(f&quot;   Survived: {results['survived_mutants']}&quot;)
        print(f&quot;   Mutation score: {results['mutation_score']}%&quot;)

        return results

def main():
    if len(sys.argv) &lt; 3:
        print(&quot;Usage: python simple_mutator.py &lt;source_dir&gt; &lt;test_command&gt;&quot;</code></pre></div><div class="py-4"><p class="text-gray-600">tools\run_canary.py (Line 13:1 - Line 26:4), tools\run_live_testnet.py (Line 17:1 - Line 29:5)</p><button class="bg-gray-500 text-white px-1 py-0.5 text-xs rounded focus:outline-none ml-2" id="expandBtn138" onclick="toggleCodeBlock('cloneGroup138', 'expandBtn138', 'collapseBtn138')">Show code</button><button class="bg-gray-500 text-white px-1 py-0.5 text-xs rounded focus:outline-none ml-2 hidden" id="collapseBtn138" onclick="toggleCodeBlock('cloneGroup138', 'expandBtn138', 'collapseBtn138')">Hide code</button><pre class="bg-gray-100 border border-gray-200 p-4 rounded mt-2 hidden" id="cloneGroup138"><code class="language-python text-sm text-gray-800">import argparse
import os
import subprocess
import sys
import time
from pathlib import Path

# Add project root to path
ROOT = Path(__file__).resolve().parent.parent
if str(ROOT) not in sys.path:
    sys.path.insert(0, str(ROOT))


def</code></pre></div><div class="py-4"><p class="text-gray-600">tools\live_feed.py (Line 226:9 - Line 242:6), tools\live_feed.py (Line 195:13 - Line 210:5)</p><button class="bg-gray-500 text-white px-1 py-0.5 text-xs rounded focus:outline-none ml-2" id="expandBtn139" onclick="toggleCodeBlock('cloneGroup139', 'expandBtn139', 'collapseBtn139')">Show code</button><button class="bg-gray-500 text-white px-1 py-0.5 text-xs rounded focus:outline-none ml-2 hidden" id="collapseBtn139" onclick="toggleCodeBlock('cloneGroup139', 'expandBtn139', 'collapseBtn139')">Hide code</button><pre class="bg-gray-100 border border-gray-200 p-4 rounded mt-2 hidden" id="cloneGroup139"><code class="language-python text-sm text-gray-800">import os

        filepath = self.session_dir / filename

        if not filepath.exists():
            return

        # Get current file size
        current_size = os.path.getsize(filepath)
        last_pos = self.file_positions.get(filename, 0)

        # Check for file rotation (file became smaller)
        if current_size &lt; last_pos:
            last_pos = 0  # Reset position

        try:
            async</code></pre></div><div class="py-4"><p class="text-gray-600">tools\auroractl.py (Line 169:13 - Line 180:7), tools\auroractl.py (Line 57:9 - Line 68:7)</p><button class="bg-gray-500 text-white px-1 py-0.5 text-xs rounded focus:outline-none ml-2" id="expandBtn140" onclick="toggleCodeBlock('cloneGroup140', 'expandBtn140', 'collapseBtn140')">Show code</button><button class="bg-gray-500 text-white px-1 py-0.5 text-xs rounded focus:outline-none ml-2 hidden" id="collapseBtn140" onclick="toggleCodeBlock('cloneGroup140', 'expandBtn140', 'collapseBtn140')">Hide code</button><pre class="bg-gray-100 border border-gray-200 p-4 rounded mt-2 hidden" id="cloneGroup140"><code class="language-python text-sm text-gray-800">try:
                out = subprocess.check_output([&quot;netstat&quot;, &quot;-ano&quot;], creationflags=0x08000000).decode(errors='ignore')
                pids = []
                for line in out.splitlines():
                    if f&quot;:{port} &quot; in line and &quot;LISTENING&quot; in line.upper():
                        parts = line.split()
                        if parts:
                            pids.append(parts[-1])
                for pid in set(pids):
                    try:
                        subprocess.call([&quot;taskkill&quot;, &quot;/PID&quot;, pid, &quot;/F&quot;, &quot;/T&quot;], creationflags=0x08000000)
                        killed</code></pre></div><div class="py-4"><p class="text-gray-600">tests\test_sizing_live_integration.py (Line 66:9 - Line 77:50), tests\test_sizing_live_integration.py (Line 28:9 - Line 39:13)</p><button class="bg-gray-500 text-white px-1 py-0.5 text-xs rounded focus:outline-none ml-2" id="expandBtn141" onclick="toggleCodeBlock('cloneGroup141', 'expandBtn141', 'collapseBtn141')">Show code</button><button class="bg-gray-500 text-white px-1 py-0.5 text-xs rounded focus:outline-none ml-2 hidden" id="collapseBtn141" onclick="toggleCodeBlock('cloneGroup141', 'expandBtn141', 'collapseBtn141')">Hide code</button><pre class="bg-gray-100 border border-gray-200 p-4 rounded mt-2 hidden" id="cloneGroup141"><code class="language-python text-sm text-gray-800">f_raw = kelly_binary(p_cal, rr, risk_aversion=1.0, clip=(0.0, 0.2))
        notional_target = f_raw * equity

        # Mock exchange filters
        px = 50000.0
        lot_step = 0.00001
        min_notional = 10.0
        max_notional = 5000.0

        qty = fraction_to_qty(notional_target, px, lot_step, min_notional, max_notional)

        # Should return the correctly calculated quantity</code></pre></div><div class="py-4"><p class="text-gray-600">tests\test_sizing_kelly.py (Line 896:9 - Line 907:39), tests\test_sizing_kelly.py (Line 852:9 - Line 863:39)</p><button class="bg-gray-500 text-white px-1 py-0.5 text-xs rounded focus:outline-none ml-2" id="expandBtn142" onclick="toggleCodeBlock('cloneGroup142', 'expandBtn142', 'collapseBtn142')">Show code</button><button class="bg-gray-500 text-white px-1 py-0.5 text-xs rounded focus:outline-none ml-2 hidden" id="collapseBtn142" onclick="toggleCodeBlock('cloneGroup142', 'expandBtn142', 'collapseBtn142')">Hide code</button><pre class="bg-gray-100 border border-gray-200 p-4 rounded mt-2 hidden" id="cloneGroup142"><code class="language-python text-sm text-gray-800">import time
        stabilizer = SizingStabilizer(min_resize_interval_sec=1.0)

        # Set last resize time to past
        stabilizer.last_resize_time = time.monotonic() - 2.0

        # Call stabilize_fraction with different target and current to trigger line 540
        result, metadata = stabilizer.stabilize_fraction(0.2, 0.1, apply_time_guard=True)
        assert result == 0.2  # Should accept the change
        assert metadata[&quot;final_fraction&quot;] == 0.2

    def test_kelly_binary_safety_check_line_79</code></pre></div><div class="py-4"><p class="text-gray-600">tests\test_sizing_kelly.py (Line 951:5 - Line 966:38), tests\test_sizing_kelly.py (Line 800:5 - Line 815:38)</p><button class="bg-gray-500 text-white px-1 py-0.5 text-xs rounded focus:outline-none ml-2" id="expandBtn143" onclick="toggleCodeBlock('cloneGroup143', 'expandBtn143', 'collapseBtn143')">Show code</button><button class="bg-gray-500 text-white px-1 py-0.5 text-xs rounded focus:outline-none ml-2 hidden" id="collapseBtn143" onclick="toggleCodeBlock('cloneGroup143', 'expandBtn143', 'collapseBtn143')">Hide code</button><pre class="bg-gray-100 border border-gray-200 p-4 rounded mt-2 hidden" id="cloneGroup143"><code class="language-python text-sm text-gray-800">def test_portfolio_kelly_numpy_solve_exception_lines_434_442(self):
        &quot;&quot;&quot;Test portfolio_kelly numpy solve exception handling (lines 434-442).&quot;&quot;&quot;
        from unittest.mock import patch
        import core.sizing.kelly as kelly_mod

        # Mock numpy.linalg.solve to raise an exception
        with patch('numpy.linalg.solve', side_effect=Exception(&quot;Solve failed&quot;)), \
             patch('numpy.linalg.pinv') as mock_pinv:
            mock_pinv.return_value.dot.return_value = [0.5, 0.5]  # Mock pinv result

            mu = [0.02, 0.03]
            Sigma = [[0.04, 0.01], [0.01, 0.09]]

            w = kelly_mod.portfolio_kelly(mu, Sigma)
            assert len(w) == 2
            # Should use pinv fallback (line 436)</code></pre></div><div class="py-4"><p class="text-gray-600">tests\test_sim_local_sink.py (Line 133:9 - Line 146:11), tests\test_sim_local_sink.py (Line 94:9 - Line 107:11)</p><button class="bg-gray-500 text-white px-1 py-0.5 text-xs rounded focus:outline-none ml-2" id="expandBtn144" onclick="toggleCodeBlock('cloneGroup144', 'expandBtn144', 'collapseBtn144')">Show code</button><button class="bg-gray-500 text-white px-1 py-0.5 text-xs rounded focus:outline-none ml-2 hidden" id="collapseBtn144" onclick="toggleCodeBlock('cloneGroup144', 'expandBtn144', 'collapseBtn144')">Hide code</button><pre class="bg-gray-100 border border-gray-200 p-4 rounded mt-2 hidden" id="cloneGroup144"><code class="language-python text-sm text-gray-800">sink = SimLocalSink(
            cfg=self.base_config,
            ev=self.mock_event_logger,
            time_func=self.mock_time_func
        )

        market = {
            'best_bid': 100.0,
            'best_ask': 101.0,
            'liquidity': {'bid': 10.0, 'ask': 10.0}
        }

        order = {
            'order_id': 'test-124'</code></pre></div><div class="py-4"><p class="text-gray-600">tests\test_sim_local_sink.py (Line 172:9 - Line 185:11), tests\test_sim_local_sink.py (Line 94:9 - Line 107:11)</p><button class="bg-gray-500 text-white px-1 py-0.5 text-xs rounded focus:outline-none ml-2" id="expandBtn145" onclick="toggleCodeBlock('cloneGroup145', 'expandBtn145', 'collapseBtn145')">Show code</button><button class="bg-gray-500 text-white px-1 py-0.5 text-xs rounded focus:outline-none ml-2 hidden" id="collapseBtn145" onclick="toggleCodeBlock('cloneGroup145', 'expandBtn145', 'collapseBtn145')">Hide code</button><pre class="bg-gray-100 border border-gray-200 p-4 rounded mt-2 hidden" id="cloneGroup145"><code class="language-python text-sm text-gray-800">sink = SimLocalSink(
            cfg=self.base_config,
            ev=self.mock_event_logger,
            time_func=self.mock_time_func
        )

        market = {
            'best_bid': 100.0,
            'best_ask': 101.0,
            'liquidity': {'bid': 10.0, 'ask': 10.0}
        }

        order = {
            'order_id': 'test-125'</code></pre></div><div class="py-4"><p class="text-gray-600">tests\test_sim_local_sink.py (Line 209:9 - Line 222:11), tests\test_sim_local_sink.py (Line 94:9 - Line 107:11)</p><button class="bg-gray-500 text-white px-1 py-0.5 text-xs rounded focus:outline-none ml-2" id="expandBtn146" onclick="toggleCodeBlock('cloneGroup146', 'expandBtn146', 'collapseBtn146')">Show code</button><button class="bg-gray-500 text-white px-1 py-0.5 text-xs rounded focus:outline-none ml-2 hidden" id="collapseBtn146" onclick="toggleCodeBlock('cloneGroup146', 'expandBtn146', 'collapseBtn146')">Hide code</button><pre class="bg-gray-100 border border-gray-200 p-4 rounded mt-2 hidden" id="cloneGroup146"><code class="language-python text-sm text-gray-800">sink = SimLocalSink(
            cfg=self.base_config,
            ev=self.mock_event_logger,
            time_func=self.mock_time_func
        )

        market = {
            'best_bid': 100.0,
            'best_ask': 101.0,
            'liquidity': {'bid': 10.0, 'ask': 10.0}
        }

        order = {
            'order_id': 'test-126'</code></pre></div><div class="py-4"><p class="text-gray-600">tests\test_sim_local_sink.py (Line 591:9 - Line 604:23), tests\test_sim_local_sink.py (Line 94:9 - Line 107:11)</p><button class="bg-gray-500 text-white px-1 py-0.5 text-xs rounded focus:outline-none ml-2" id="expandBtn147" onclick="toggleCodeBlock('cloneGroup147', 'expandBtn147', 'collapseBtn147')">Show code</button><button class="bg-gray-500 text-white px-1 py-0.5 text-xs rounded focus:outline-none ml-2 hidden" id="collapseBtn147" onclick="toggleCodeBlock('cloneGroup147', 'expandBtn147', 'collapseBtn147')">Hide code</button><pre class="bg-gray-100 border border-gray-200 p-4 rounded mt-2 hidden" id="cloneGroup147"><code class="language-python text-sm text-gray-800">sink = SimLocalSink(
            cfg=self.base_config,
            ev=self.mock_event_logger,
            time_func=self.mock_time_func
        )

        market = {
            'best_bid': 100.0,
            'best_ask': 101.0,
            'liquidity': {'bid': 10.0, 'ask': 10.0}
        }

        order = {
            'order_id': 'test-sell-fill-price'</code></pre></div><div class="py-4"><p class="text-gray-600">tests\test_signal.py (Line 20:5 - Line 27:5), tools\mutation_test_standalone.py (Line 17:2 - Line 25:2)</p><button class="bg-gray-500 text-white px-1 py-0.5 text-xs rounded focus:outline-none ml-2" id="expandBtn148" onclick="toggleCodeBlock('cloneGroup148', 'expandBtn148', 'collapseBtn148')">Show code</button><button class="bg-gray-500 text-white px-1 py-0.5 text-xs rounded focus:outline-none ml-2 hidden" id="collapseBtn148" onclick="toggleCodeBlock('cloneGroup148', 'expandBtn148', 'collapseBtn148')">Hide code</button><pre class="bg-gray-100 border border-gray-200 p-4 rounded mt-2 hidden" id="cloneGroup148"><code class="language-python text-sm text-gray-800">):
        &quot;&quot;&quot;Test score calculation with features&quot;&quot;&quot;
        model = ScoreModel(weights={&quot;feature1&quot;: 0.5, &quot;feature2&quot;: 0.3}, intercept=-0.1)
        features = {&quot;feature1&quot;: 1.0, &quot;feature2&quot;: 2.0}
        score = model.score_only(features)
        assert isinstance(score, float)

    def test_sigmoid_function(self</code></pre></div><div class="py-4"><p class="text-gray-600">tests\test_signal.py (Line 50:5 - Line 60:6), tools\mutation_test_standalone.py (Line 47:2 - Line 57:4)</p><button class="bg-gray-500 text-white px-1 py-0.5 text-xs rounded focus:outline-none ml-2" id="expandBtn149" onclick="toggleCodeBlock('cloneGroup149', 'expandBtn149', 'collapseBtn149')">Show code</button><button class="bg-gray-500 text-white px-1 py-0.5 text-xs rounded focus:outline-none ml-2 hidden" id="collapseBtn149" onclick="toggleCodeBlock('cloneGroup149', 'expandBtn149', 'collapseBtn149')">Hide code</button><pre class="bg-gray-100 border border-gray-200 p-4 rounded mt-2 hidden" id="cloneGroup149"><code class="language-python text-sm text-gray-800">):
        &quot;&quot;&quot;Test reject function&quot;&quot;&quot;
        p_values = [0.01, 0.02, 0.03, 0.04, 0.05]
        rejected_mask, num_rejected = reject(p_values, alpha=0.05)
        assert isinstance(rejected_mask, list)
        assert isinstance(num_rejected, int)
        assert len(rejected_mask) == len(p_values)
        assert all(isinstance(r, bool) for r in rejected_mask)


class</code></pre></div><div class="py-4"><p class="text-gray-600">tests\test_signal.py (Line 68:5 - Line 99:5), tools\mutation_test_standalone.py (Line 63:2 - Line 94:5)</p><button class="bg-gray-500 text-white px-1 py-0.5 text-xs rounded focus:outline-none ml-2" id="expandBtn150" onclick="toggleCodeBlock('cloneGroup150', 'expandBtn150', 'collapseBtn150')">Show code</button><button class="bg-gray-500 text-white px-1 py-0.5 text-xs rounded focus:outline-none ml-2 hidden" id="collapseBtn150" onclick="toggleCodeBlock('cloneGroup150', 'expandBtn150', 'collapseBtn150')">Hide code</button><pre class="bg-gray-100 border border-gray-200 p-4 rounded mt-2 hidden" id="cloneGroup150"><code class="language-python text-sm text-gray-800">):
        &quot;&quot;&quot;Test adding tick data&quot;&quot;&quot;
        calculator = CrossAssetHY()
        calculator.add_tick(&quot;SOL&quot;, 1000.0, 50.0)
        # Should not raise exception
        assert True


# Simple comparison tests for mutation testing
def test_simple_comparisons():
    &quot;&quot;&quot;Simple tests that mutation testing can work with&quot;&quot;&quot;
    x = 5
    y = 10

    # These comparisons will be mutated by our simple mutator
    assert x &lt; y
    assert x != y
    assert y &gt; x
    assert x &lt;= 5
    assert y &gt;= 10


def test_boolean_logic():
    &quot;&quot;&quot;Boolean logic tests for mutation testing&quot;&quot;&quot;
    a = True
    b = False

    # These will be mutated (and/or operations)
    assert a and not b
    assert a or b
    assert not (a and b)
    assert (a or b) and True</code></pre></div><div class="py-4"><p class="text-gray-600">tests\test_risk_guards_live.py (Line 81:9 - Line 87:30), tests\test_risk_guards_live.py (Line 69:9 - Line 75:30)</p><button class="bg-gray-500 text-white px-1 py-0.5 text-xs rounded focus:outline-none ml-2" id="expandBtn151" onclick="toggleCodeBlock('cloneGroup151', 'expandBtn151', 'collapseBtn151')">Show code</button><button class="bg-gray-500 text-white px-1 py-0.5 text-xs rounded focus:outline-none ml-2 hidden" id="collapseBtn151" onclick="toggleCodeBlock('cloneGroup151', 'expandBtn151', 'collapseBtn151')">Hide code</button><pre class="bg-gray-100 border border-gray-200 p-4 rounded mt-2 hidden" id="cloneGroup151"><code class="language-python text-sm text-gray-800">snapshot = {&quot;mid_price&quot;: 50000.0, &quot;spread_bps&quot;: 2.0, &quot;latency_ms&quot;: 10.0}
        account_state = {&quot;equity_usd&quot;: 10000.0, &quot;positions&quot;: {}}

        result = risk_guards.pre_trade_check(intent, snapshot, account_state)

        assert result.allow == False
        assert result.why_code == &quot;WHY_RISK_GUARD_MAX_NOTIONAL&quot;</code></pre></div><div class="py-4"><p class="text-gray-600">tests\test_risk_guards_live.py (Line 98:9 - Line 104:22), tests\test_risk_guards_live.py (Line 69:9 - Line 75:30)</p><button class="bg-gray-500 text-white px-1 py-0.5 text-xs rounded focus:outline-none ml-2" id="expandBtn152" onclick="toggleCodeBlock('cloneGroup152', 'expandBtn152', 'collapseBtn152')">Show code</button><button class="bg-gray-500 text-white px-1 py-0.5 text-xs rounded focus:outline-none ml-2 hidden" id="collapseBtn152" onclick="toggleCodeBlock('cloneGroup152', 'expandBtn152', 'collapseBtn152')">Hide code</button><pre class="bg-gray-100 border border-gray-200 p-4 rounded mt-2 hidden" id="cloneGroup152"><code class="language-python text-sm text-gray-800">snapshot = {&quot;mid_price&quot;: 50000.0, &quot;spread_bps&quot;: 2.0, &quot;latency_ms&quot;: 10.0}
        account_state = {&quot;equity_usd&quot;: 10000.0, &quot;positions&quot;: {}}

        result = risk_guards.pre_trade_check(intent, snapshot, account_state)

        assert result.allow == False
        assert result.why_code == &quot;WHY_RISK_GUARD_CVAR&quot;</code></pre></div><div class="py-4"><p class="text-gray-600">tests\test_risk_guards_live.py (Line 115:9 - Line 122:21), tests\test_risk_guards_live.py (Line 97:9 - Line 75:30)</p><button class="bg-gray-500 text-white px-1 py-0.5 text-xs rounded focus:outline-none ml-2" id="expandBtn153" onclick="toggleCodeBlock('cloneGroup153', 'expandBtn153', 'collapseBtn153')">Show code</button><button class="bg-gray-500 text-white px-1 py-0.5 text-xs rounded focus:outline-none ml-2 hidden" id="collapseBtn153" onclick="toggleCodeBlock('cloneGroup153', 'expandBtn153', 'collapseBtn153')">Hide code</button><pre class="bg-gray-100 border border-gray-200 p-4 rounded mt-2 hidden" id="cloneGroup153"><code class="language-python text-sm text-gray-800">intent = {&quot;symbol&quot;: &quot;BTCUSDT&quot;, &quot;side&quot;: &quot;buy&quot;, &quot;qty&quot;: 0.001, &quot;price&quot;: 50000.0}
        snapshot = {&quot;mid_price&quot;: 50000.0, &quot;spread_bps&quot;: 2.0, &quot;latency_ms&quot;: 10.0}
        account_state = {&quot;equity_usd&quot;: 10000.0, &quot;positions&quot;: {}}

        result = risk_guards.pre_trade_check(intent, snapshot, account_state)

        assert result.allow == False
        assert result.why_code == &quot;WHY_RISK_GUARD_EVT&quot;</code></pre></div><div class="py-4"><p class="text-gray-600">tests\test_pretrade_models.py (Line 25:37 - Line 33:7), tests\test_pretrade_models.py (Line 7:37 - Line 15:4)</p><button class="bg-gray-500 text-white px-1 py-0.5 text-xs rounded focus:outline-none ml-2" id="expandBtn154" onclick="toggleCodeBlock('cloneGroup154', 'expandBtn154', 'collapseBtn154')">Show code</button><button class="bg-gray-500 text-white px-1 py-0.5 text-xs rounded focus:outline-none ml-2 hidden" id="collapseBtn154" onclick="toggleCodeBlock('cloneGroup154', 'expandBtn154', 'collapseBtn154')">Hide code</button><pre class="bg-gray-100 border border-gray-200 p-4 rounded mt-2 hidden" id="cloneGroup154"><code class="language-python text-sm text-gray-800">():
    svc = importlib.import_module(&quot;api.service&quot;)
    app = svc.app
    client = TestClient(app)

    body = {
        &quot;account&quot;: {&quot;mode&quot;: &quot;shadow&quot;},
        &quot;order&quot;: {&quot;symbol&quot;: &quot;BTCUSDT&quot;, &quot;side&quot;: &quot;LONG&quot;, &quot;qty&quot;: 0.01, &quot;price&quot;: 100.0},
        &quot;market&quot;: {&quot;latency_ms&quot;: 1.0, &quot;score&quot;: 0.0, &quot;a_bps&quot;: 10.0, &quot;b_bps&quot;: 10.0, &quot;spread_bps&quot;: 1000.0</code></pre></div><div class="py-4"><p class="text-gray-600">tests\test_metrics_summary_details.py (Line 8:1 - Line 15:30), tests\metrics\test_metrics_summary.py (Line 10:1 - Line 17:39)</p><button class="bg-gray-500 text-white px-1 py-0.5 text-xs rounded focus:outline-none ml-2" id="expandBtn155" onclick="toggleCodeBlock('cloneGroup155', 'expandBtn155', 'collapseBtn155')">Show code</button><button class="bg-gray-500 text-white px-1 py-0.5 text-xs rounded focus:outline-none ml-2 hidden" id="collapseBtn155" onclick="toggleCodeBlock('cloneGroup155', 'expandBtn155', 'collapseBtn155')">Hide code</button><pre class="bg-gray-100 border border-gray-200 p-4 rounded mt-2 hidden" id="cloneGroup155"><code class="language-python text-sm text-gray-800">def write_jsonl(p: Path, rows):
    p.parent.mkdir(parents=True, exist_ok=True)
    with p.open('w', encoding='utf-8') as f:
        for r in rows:
            f.write(json.dumps(r) + &quot;\n&quot;)


def test_metrics_summary_enriched</code></pre></div><div class="py-4"><p class="text-gray-600">tests\test_ingestion_replay.py (Line 118:5 - Line 132:34), tests\test_ingestion_replay.py (Line 72:5 - Line 86:4)</p><button class="bg-gray-500 text-white px-1 py-0.5 text-xs rounded focus:outline-none ml-2" id="expandBtn156" onclick="toggleCodeBlock('cloneGroup156', 'expandBtn156', 'collapseBtn156')">Show code</button><button class="bg-gray-500 text-white px-1 py-0.5 text-xs rounded focus:outline-none ml-2 hidden" id="collapseBtn156" onclick="toggleCodeBlock('cloneGroup156', 'expandBtn156', 'collapseBtn156')">Hide code</button><pre class="bg-gray-100 border border-gray-200 p-4 rounded mt-2 hidden" id="cloneGroup156"><code class="language-python text-sm text-gray-800">raw = [
        {&quot;ts&quot;: 100, &quot;type&quot;: &quot;trade&quot;, &quot;symbol&quot;: &quot;BTCUSDT&quot;, &quot;price&quot;: 100.0, &quot;qty&quot;: 0.5},
        {&quot;ts&quot;: 150, &quot;type&quot;: &quot;trade&quot;, &quot;symbol&quot;: &quot;BTCUSDT&quot;, &quot;price&quot;: 101.0},  # invalid (missing size)
        {&quot;ts&quot;: 200, &quot;type&quot;: &quot;trade&quot;, &quot;symbol&quot;: &quot;BTCUSDT&quot;, &quot;price&quot;: 102.0, &quot;qty&quot;: 0.1, &quot;tag&quot;: &quot;boom&quot;},
    ]

    def transform(evt):
        if evt.get(&quot;tag&quot;) == &quot;boom&quot;:
            raise RuntimeError(&quot;transform failure&quot;)
        return evt

    clk = ManualClock(start_wall_ns=0)
    r = Replay(source=raw, normalizer=Normalizer(strict=False), clock=clk, strict=False, pace=True)

    # Should not raise any exceptions</code></pre></div><div class="py-4"><p class="text-gray-600">tests\test_execution_router.py (Line 292:9 - Line 301:4), tests\unit\test_xai_decision_trail.py (Line 63:9 - Line 72:24)</p><button class="bg-gray-500 text-white px-1 py-0.5 text-xs rounded focus:outline-none ml-2" id="expandBtn157" onclick="toggleCodeBlock('cloneGroup157', 'expandBtn157', 'collapseBtn157')">Show code</button><button class="bg-gray-500 text-white px-1 py-0.5 text-xs rounded focus:outline-none ml-2 hidden" id="collapseBtn157" onclick="toggleCodeBlock('cloneGroup157', 'expandBtn157', 'collapseBtn157')">Hide code</button><pre class="bg-gray-100 border border-gray-200 p-4 rounded mt-2 hidden" id="cloneGroup157"><code class="language-python text-sm text-gray-800">assert hasattr(decision, 'e_maker_bps')
        assert hasattr(decision, 'e_taker_bps')
        assert hasattr(decision, 'p_fill')
        assert hasattr(decision, 'reason')
        assert hasattr(decision, 'maker_fee_bps')
        assert hasattr(decision, 'taker_fee_bps')
        assert hasattr(decision, 'net_e_maker_bps')
        assert hasattr(decision, 'net_e_taker_bps')

    def</code></pre></div><div class="py-4"><p class="text-gray-600">tests\test_exchange_adapters.py (Line 28:5 - Line 41:4), tests\test_unified_exchange_adapter.py (Line 58:5 - Line 71:23)</p><button class="bg-gray-500 text-white px-1 py-0.5 text-xs rounded focus:outline-none ml-2" id="expandBtn158" onclick="toggleCodeBlock('cloneGroup158', 'expandBtn158', 'collapseBtn158')">Show code</button><button class="bg-gray-500 text-white px-1 py-0.5 text-xs rounded focus:outline-none ml-2 hidden" id="collapseBtn158" onclick="toggleCodeBlock('cloneGroup158', 'expandBtn158', 'collapseBtn158')">Hide code</button><pre class="bg-gray-100 border border-gray-200 p-4 rounded mt-2 hidden" id="cloneGroup158"><code class="language-python text-sm text-gray-800">def __init__(self, responses=None):
        self.responses = responses or {}
        self.requests = []

    def request(self, method, url, *, params=None, headers=None, json=None):
        self.requests.append((method, url, params, headers, json))
        # Return mock response based on URL pattern
        for pattern, response in self.responses.items():
            if pattern in url:
                return response
        return {}


def</code></pre></div><div class="py-4"><p class="text-gray-600">tests\test_calibration_icp.py (Line 226:9 - Line 234:36), tests\test_calibration_icp.py (Line 211:9 - Line 219:41)</p><button class="bg-gray-500 text-white px-1 py-0.5 text-xs rounded focus:outline-none ml-2" id="expandBtn159" onclick="toggleCodeBlock('cloneGroup159', 'expandBtn159', 'collapseBtn159')">Show code</button><button class="bg-gray-500 text-white px-1 py-0.5 text-xs rounded focus:outline-none ml-2 hidden" id="collapseBtn159" onclick="toggleCodeBlock('cloneGroup159', 'expandBtn159', 'collapseBtn159')">Hide code</button><pre class="bg-gray-100 border border-gray-200 p-4 rounded mt-2 hidden" id="cloneGroup159"><code class="language-python text-sm text-gray-800">mc = MondrianConformalBinary(alpha=0.1)

        p_hat = [0.8, 0.2, 0.9, 0.1]
        y = [1, 0, 1, 0]
        groups = [&quot;A&quot;, &quot;A&quot;, &quot;B&quot;, &quot;B&quot;]

        mc.fit(p_hat, y, groups)

        # No group should use global scores</code></pre></div><div class="py-4"><p class="text-gray-600">tests\test_calibration_icp.py (Line 241:9 - Line 249:40), tests\test_calibration_icp.py (Line 211:9 - Line 219:41)</p><button class="bg-gray-500 text-white px-1 py-0.5 text-xs rounded focus:outline-none ml-2" id="expandBtn160" onclick="toggleCodeBlock('cloneGroup160', 'expandBtn160', 'collapseBtn160')">Show code</button><button class="bg-gray-500 text-white px-1 py-0.5 text-xs rounded focus:outline-none ml-2 hidden" id="collapseBtn160" onclick="toggleCodeBlock('cloneGroup160', 'expandBtn160', 'collapseBtn160')">Hide code</button><pre class="bg-gray-100 border border-gray-200 p-4 rounded mt-2 hidden" id="cloneGroup160"><code class="language-python text-sm text-gray-800">mc = MondrianConformalBinary(alpha=0.1)

        p_hat = [0.8, 0.2, 0.9, 0.1]
        y = [1, 0, 1, 0]
        groups = [&quot;A&quot;, &quot;A&quot;, &quot;B&quot;, &quot;B&quot;]

        mc.fit(p_hat, y, groups)

        # Test confident prediction for group A</code></pre></div><div class="py-4"><p class="text-gray-600">tests\test_api_integration.py (Line 15:1 - Line 22:36), tests\test_api_validation.py (Line 12:1 - Line 19:24)</p><button class="bg-gray-500 text-white px-1 py-0.5 text-xs rounded focus:outline-none ml-2" id="expandBtn161" onclick="toggleCodeBlock('cloneGroup161', 'expandBtn161', 'collapseBtn161')">Show code</button><button class="bg-gray-500 text-white px-1 py-0.5 text-xs rounded focus:outline-none ml-2 hidden" id="collapseBtn161" onclick="toggleCodeBlock('cloneGroup161', 'expandBtn161', 'collapseBtn161')">Hide code</button><pre class="bg-gray-100 border border-gray-200 p-4 rounded mt-2 hidden" id="cloneGroup161"><code class="language-python text-sm text-gray-800"># Add project root to sys.path
PROJECT_ROOT = os.path.abspath(os.path.join(os.path.dirname(__file__), '..'))
if PROJECT_ROOT not in sys.path:
    sys.path.insert(0, PROJECT_ROOT)


def find_free_port():
    &quot;&quot;&quot;Find a free port for testing.&quot;&quot;&quot;</code></pre></div><div class="py-4"><p class="text-gray-600">scripts\run_live.py (Line 55:11 - Line 63:2), core\execution\exchange\common.py (Line 233:9 - Line 129:2)</p><button class="bg-gray-500 text-white px-1 py-0.5 text-xs rounded focus:outline-none ml-2" id="expandBtn162" onclick="toggleCodeBlock('cloneGroup162', 'expandBtn162', 'collapseBtn162')">Show code</button><button class="bg-gray-500 text-white px-1 py-0.5 text-xs rounded focus:outline-none ml-2 hidden" id="collapseBtn162" onclick="toggleCodeBlock('cloneGroup162', 'expandBtn162', 'collapseBtn162')">Hide code</button><pre class="bg-gray-100 border border-gray-200 p-4 rounded mt-2 hidden" id="cloneGroup162"><code class="language-python text-sm text-gray-800">):
    def request(
        self,
        method: str,
        url: str,
        *,
        params: Optional[Mapping[str, object]] = None,
        headers: Optional[Mapping[str, str]] = None,
        json: Optional[object] = None,</code></pre></div><div class="py-4"><p class="text-gray-600">scripts\run_live.py (Line 123:9 - Line 132:6), scripts\run_live.py (Line 101:9 - Line 110:3)</p><button class="bg-gray-500 text-white px-1 py-0.5 text-xs rounded focus:outline-none ml-2" id="expandBtn163" onclick="toggleCodeBlock('cloneGroup163', 'expandBtn163', 'collapseBtn163')">Show code</button><button class="bg-gray-500 text-white px-1 py-0.5 text-xs rounded focus:outline-none ml-2 hidden" id="collapseBtn163" onclick="toggleCodeBlock('cloneGroup163', 'expandBtn163', 'collapseBtn163')">Hide code</button><pre class="bg-gray-100 border border-gray-200 p-4 rounded mt-2 hidden" id="cloneGroup163"><code class="language-python text-sm text-gray-800">try:
            bid = float(str(bid_val)) if bid_val is not None else 0.0
        except (ValueError, TypeError):
            bid = 0.0
        try:
            ask = float(str(ask_val)) if ask_val is not None else 0.0
        except (ValueError, TypeError):
            ask = 0.0
        return Book(bid=bid, ask=ask)
    raise</code></pre></div><div class="py-4"><p class="text-gray-600">scripts\run_live.py (Line 161:9 - Line 178:6), scripts\run_replay.py (Line 203:5 - Line 222:48)</p><button class="bg-gray-500 text-white px-1 py-0.5 text-xs rounded focus:outline-none ml-2" id="expandBtn164" onclick="toggleCodeBlock('cloneGroup164', 'expandBtn164', 'collapseBtn164')">Show code</button><button class="bg-gray-500 text-white px-1 py-0.5 text-xs rounded focus:outline-none ml-2 hidden" id="collapseBtn164" onclick="toggleCodeBlock('cloneGroup164', 'expandBtn164', 'collapseBtn164')">Hide code</button><pre class="bg-gray-100 border border-gray-200 p-4 rounded mt-2 hidden" id="cloneGroup164"><code class="language-python text-sm text-gray-800">def _get_nested(d: dict, parts: list):
            cur = d
            for p in parts:
                if not isinstance(cur, dict) or p not in cur:
                    return None
                cur = cur[p]
            return cur

        def _set_nested(d: dict, parts: list, value):
            cur = d
            for p in parts[:-1]:
                if p not in cur or not isinstance(cur[p], dict):
                    cur[p] = {}
                cur = cur[p]
            cur[parts[-1]] = value

        def _find_best_split_and_set(base: dict, key: str, value):
            parts</code></pre></div><div class="py-4"><p class="text-gray-600">scripts\run_live.py (Line 221:8 - Line 234:5), scripts\run_replay.py (Line 287:8 - Line 300:9)</p><button class="bg-gray-500 text-white px-1 py-0.5 text-xs rounded focus:outline-none ml-2" id="expandBtn165" onclick="toggleCodeBlock('cloneGroup165', 'expandBtn165', 'collapseBtn165')">Show code</button><button class="bg-gray-500 text-white px-1 py-0.5 text-xs rounded focus:outline-none ml-2 hidden" id="collapseBtn165" onclick="toggleCodeBlock('cloneGroup165', 'expandBtn165', 'collapseBtn165')">Hide code</button><pre class="bg-gray-100 border border-gray-200 p-4 rounded mt-2 hidden" id="cloneGroup165"><code class="language-python text-sm text-gray-800">) as fh:
            fh.write(f&quot;APPLIED PROFILE: {args.profile}\n&quot;)
            fh.write(&quot;CHANGED KEYS:\n&quot;)
            for p in changed:
                old = before
                for part in p.split('.'):
                    old = old.get(part, None) if isinstance(old, dict) else None
                new = cfg
                for part in p.split('.'):
                    new = new.get(part, None) if isinstance(new, dict) else None
                fh.write(f&quot;- {p}: {old!r} -&gt; {new!r}\n&quot;)
        print(f&quot;PROFILE: applied {args.profile} -&gt; {out_path}&quot;)

    http</code></pre></div><div class="py-4"><p class="text-gray-600">core\types.py (Line 182:9 - Line 187:11), core\calibration\calibrator.py (Line 40:13 - Line 43:13)</p><button class="bg-gray-500 text-white px-1 py-0.5 text-xs rounded focus:outline-none ml-2" id="expandBtn166" onclick="toggleCodeBlock('cloneGroup166', 'expandBtn166', 'collapseBtn166')">Show code</button><button class="bg-gray-500 text-white px-1 py-0.5 text-xs rounded focus:outline-none ml-2 hidden" id="collapseBtn166" onclick="toggleCodeBlock('cloneGroup166', 'expandBtn166', 'collapseBtn166')">Hide code</button><pre class="bg-gray-100 border border-gray-200 p-4 rounded mt-2 hidden" id="cloneGroup166"><code class="language-python text-sm text-gray-800">ece = 0.0 if self.ece is None else float(self.ece)
        logloss = 0.0 if self.logloss is None else float(self.logloss)
        return math.exp(-eta * ece) * math.exp(-zeta * logloss)


@dataclass</code></pre></div><div class="py-4"><p class="text-gray-600">core\types.py (Line 292:5 - Line 302:8), core\tca\edge_budget.py (Line 28:5 - Line 36:66)</p><button class="bg-gray-500 text-white px-1 py-0.5 text-xs rounded focus:outline-none ml-2" id="expandBtn167" onclick="toggleCodeBlock('cloneGroup167', 'expandBtn167', 'collapseBtn167')">Show code</button><button class="bg-gray-500 text-white px-1 py-0.5 text-xs rounded focus:outline-none ml-2 hidden" id="collapseBtn167" onclick="toggleCodeBlock('cloneGroup167', 'expandBtn167', 'collapseBtn167')">Hide code</button><pre class="bg-gray-100 border border-gray-200 p-4 rounded mt-2 hidden" id="cloneGroup167"><code class="language-python text-sm text-gray-800">if not (0.0 &lt;= p &lt;= 1.0):
        raise ValueError(&quot;p must be in [0,1]&quot;)
    if G &lt; 0 or L &lt; 0:
        raise ValueError(&quot;G and L must be non-negative&quot;)
    return p * G - (1.0 - p) * L - c


def p_star_threshold(r: float, c_prime: float, delta: float = 0.0) -&gt; float:
    &quot;&quot;&quot;Minimal calibrated probability to enter, given payoff ratio r=G/L and c' = c/L.
    p* = (1 + c') / (1 + r). A practical buffer δ≥0 can be added: p &gt; p* + δ.
    &quot;&quot;&quot;</code></pre></div><div class="py-4"><p class="text-gray-600">core\types.py (Line 303:5 - Line 311:20), core\tca\edge_budget.py (Line 37:5 - Line 45:22)</p><button class="bg-gray-500 text-white px-1 py-0.5 text-xs rounded focus:outline-none ml-2" id="expandBtn168" onclick="toggleCodeBlock('cloneGroup168', 'expandBtn168', 'collapseBtn168')">Show code</button><button class="bg-gray-500 text-white px-1 py-0.5 text-xs rounded focus:outline-none ml-2 hidden" id="collapseBtn168" onclick="toggleCodeBlock('cloneGroup168', 'expandBtn168', 'collapseBtn168')">Hide code</button><pre class="bg-gray-100 border border-gray-200 p-4 rounded mt-2 hidden" id="cloneGroup168"><code class="language-python text-sm text-gray-800">if r &lt;= 0:
        raise ValueError(&quot;r must be &gt; 0&quot;)
    if c_prime &lt; 0:
        raise ValueError(&quot;c' must be ≥ 0&quot;)
    base = (1.0 + c_prime) / (1.0 + r)
    return min(1.0, max(0.0, base + max(0.0, delta)))


def latency_degradation</code></pre></div><div class="py-4"><p class="text-gray-600">core\order_logger.py (Line 332:15 - Line 339:10), core\order_logger.py (Line 311:9 - Line 318:11)</p><button class="bg-gray-500 text-white px-1 py-0.5 text-xs rounded focus:outline-none ml-2" id="expandBtn169" onclick="toggleCodeBlock('cloneGroup169', 'expandBtn169', 'collapseBtn169')">Show code</button><button class="bg-gray-500 text-white px-1 py-0.5 text-xs rounded focus:outline-none ml-2 hidden" id="collapseBtn169" onclick="toggleCodeBlock('cloneGroup169', 'expandBtn169', 'collapseBtn169')">Hide code</button><pre class="bg-gray-100 border border-gray-200 p-4 rounded mt-2 hidden" id="cloneGroup169"><code class="language-python text-sm text-gray-800">) or &quot;&quot;).upper()
        oid = str(kwargs.get(&quot;order_id&quot;) or kwargs.get(&quot;orderId&quot;) or &quot;&quot;)
        if status in TERMINAL_STATES and oid:
            key = (&quot;TERM&quot;, oid, status)
            if self._seen_cid_ts.contains(key):
                return
            self._seen_cid_ts.add(key)
        self._write(self._w_failed</code></pre></div><div class="py-4"><p class="text-gray-600">core\order_lifecycle.py (Line 28:9 - Line 34:10), core\order_logger.py (Line 377:9 - Line 383:10)</p><button class="bg-gray-500 text-white px-1 py-0.5 text-xs rounded focus:outline-none ml-2" id="expandBtn170" onclick="toggleCodeBlock('cloneGroup170', 'expandBtn170', 'collapseBtn170')">Show code</button><button class="bg-gray-500 text-white px-1 py-0.5 text-xs rounded focus:outline-none ml-2 hidden" id="collapseBtn170" onclick="toggleCodeBlock('cloneGroup170', 'expandBtn170', 'collapseBtn170')">Hide code</button><pre class="bg-gray-100 border border-gray-200 p-4 rounded mt-2 hidden" id="cloneGroup170"><code class="language-python text-sm text-gray-800">s = str(ev.get(&quot;status&quot;) or ev.get(&quot;state&quot;) or ev.get(&quot;lifecycle&quot;) or &quot;&quot;).upper()
        if s:
            seen.add(s)
    for s in priority:
        if s in seen:
            return s
    return &quot;UNKNOWN&quot;</code></pre></div><div class="py-4"><p class="text-gray-600">core\converters.py (Line 108:12 - Line 115:11), core\converters.py (Line 84:13 - Line 91:10)</p><button class="bg-gray-500 text-white px-1 py-0.5 text-xs rounded focus:outline-none ml-2" id="expandBtn171" onclick="toggleCodeBlock('cloneGroup171', 'expandBtn171', 'collapseBtn171')">Show code</button><button class="bg-gray-500 text-white px-1 py-0.5 text-xs rounded focus:outline-none ml-2 hidden" id="collapseBtn171" onclick="toggleCodeBlock('cloneGroup171', 'expandBtn171', 'collapseBtn171')">Hide code</button><pre class="bg-gray-100 border border-gray-200 p-4 rounded mt-2 hidden" id="cloneGroup171"><code class="language-python text-sm text-gray-800">(
        ts_iso=_get_ts_iso(snapshot),
        decision_id=decision_id or '',
        order_id=str(d.get('order_id') or d.get('id') or ''),
        symbol=str(d.get('symbol') or ''),
        side=str(d.get('side') or ''),
        qty=float(d.get('qty') or d.get('amount') or 0.0),
        error_code</code></pre></div><!-- Add more clone groups for .txt format as needed         // Add more clone groups for .txt format as needed--></div></section><!-- Add more sections for other formats and clone groups as needed--></main><footer class="bg-white shadow mt-8 py-4"><div class="container mx-auto px-4 text-center"><p class="text-sm text-gray-600">This report is generated by jscpd, an open-source copy/paste detector.</p><p class="text-sm text-gray-600">jscpd is licensed under the MIT License.</p><a class="text-blue-500 text-sm" href="https://github.com/kucherenko/jscpd" target="_blank" rel="noopener noreferrer">View jscpd on GitHub</a></div></footer><script src="js/prism.js"></script><script>function toggleCodeBlock(codeBlockId, expandBtnId, collapseBtnId) {
  const codeBlock = document.getElementById(codeBlockId);
  const expandBtn = document.getElementById(expandBtnId);
  const collapseBtn = document.getElementById(collapseBtnId);

  codeBlock.classList.toggle('hidden');
  expandBtn.classList.toggle('hidden');
  collapseBtn.classList.toggle('hidden');
}</script></body></html>
