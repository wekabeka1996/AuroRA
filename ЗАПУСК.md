# Запуск Aurora + Scalper (тестнет)

Этот файл — краткий, пошаговый runbook для запуска/остановки Aurora API и скальпер‑бота, а также для базового мониторинга. Команды приводятся для bash (Git Bash/WSL на Windows). Все пути относительны корню репозитория.

> Примечание
> - Раннер автоматически загружает `.env` (если присутствует). Храните ключи в `.env`, не в коде.
> - API по умолчанию слушает http://127.0.0.1:8000. Метрики на `/metrics`, здоровье на `/health`.
> - Для ops‑эндпоинтов используйте заголовок `X-OPS-TOKEN` (переменная окружения `AURORA_OPS_TOKEN`/`OPS_TOKEN`).

---

## 0) Предварительные требования

- Python 3.11+ и зависимости (по проектной инструкции):
```bash
python -m pip install -r requirements.txt -r requirements-dev.txt
```
- Файл `.env` с минимальными переменными (пример):
```bash
# режимы
AURORA_MODE=prod
EXCHANGE_TESTNET=true
DRY_RUN=false

# бинанс тестнет ключи (не указывать реальные прод ключи)
BINANCE_API_KEY=... 
BINANCE_API_SECRET=...

# опционально: токен для ops-эндпоинтов API
AURORA_OPS_TOKEN=...  # либо используйте OPS_TOKEN
```

---

## 1) Быстрый запуск (one‑click) — опционально
Объединённый CLI умеет запускать API, ждать готовности и стартовать бота.
```bash
python tools/auroractl.py one-click --mode testnet --minutes 15 --preflight
```
- `--mode testnet` — тестовая биржа
- `--minutes 15` — пример окна работы
- `--preflight` — быстрые проверки окружения

Остановить: Ctrl+C в запущенном терминале.

---

## 2) Ручной запуск API
Вариант A (предпочтительный):
```bash
python tools/auroractl.py start-api
```
Вариант B (напрямую):
```bash
python api/service.py
```
Проверка готовности API:
```bash
# public
curl -s http://127.0.0.1:8000/health | jq .
# ops (нужен токен)
curl -s -H "X-OPS-TOKEN: ${AURORA_OPS_TOKEN:-$OPS_TOKEN}" http://127.0.0.1:8000/liveness | jq .
```
Остановка API:
- Если запущено в текущем окне: Ctrl+C.
- Если в отдельном окне — закройте процесс. (Опционально) если использовали Docker, см. раздел 6.

---

## 3) Ручной запуск скальпер‑бота (тестнет)
Открыть новое окно терминала (оставьте API работать) и выполнить:
```bash
# при необходимости (единоразово в текущем окне)
export PYTHONPATH=$PWD

# запуск бота (читает .env автоматически)
python -m skalp_bot.runner.run_live_aurora

# посмотреть справку по CLI
python -m skalp_bot.runner.run_live_aurora --help

# запуск с явным путём до конфига (по умолчанию ищется default.aurora.yaml или default.yaml в skalp_bot/configs)
python -m skalp_bot.runner.run_live_aurora --config skalp_bot/configs/default.aurora.yaml
```
В процессе вы увидите строки вида `[DBG]`, `[GATE]`, `[ENTRY]`, `[TRADE]` и т.д.

Сессии логов:
- Каждый процесс (API и раннер) при старте создаёт собственную папку `logs/YYYYMMDD-HHMMSS` и печатает строку `[SESSION] logs dir = ...`.
- Все артефакты пишутся внутрь этой папки: `aurora_events.jsonl`, `orders_{success,failed,denied}.jsonl`, а также сводный `orders.jsonl`.
- Чтобы API и бот писали в одну и ту же папку, заранее установите переменную окружения и запускайте оба процесса в этой же среде:
  
  ```bash
  export AURORA_SESSION_DIR="$(pwd)/logs/$(date -u +%Y%m%d-%H%M%S)"
  python tools/auroractl.py start-api &
  python -m skalp_bot.runner.run_live_aurora
  ```
  
  В этом случае оба процесса будут использовать одну сессионную директорию.

Остановка бота: Ctrl+C в его терминале.

Полезные env‑твики для старта (по необходимости):
```bash
# включить демонстрационный CANCEL stub каждые N тиков
export AURORA_CANCEL_STUB=true
export AURORA_CANCEL_STUB_EVERY_TICKS=120

# управлять лимитом спреда (в б.п.) поверх конфига
export AURORA_SPREAD_MAX_BPS=8

# доля спреда, закладываемая как слиппедж (по умолчанию тестнет 0.25)
export AURORA_SLIP_FRACTION=0.25
```

Тейкер/мейкер режим:
- По умолчанию используется лимитный (maker) режим из конфига. Для быстрых наполнений можно переключиться на рыночный (taker) режим в конфиге исполнения, либо через соответствующую настройку, если она прокинута в env.

---

## 4) Мониторинг и проверка
Быстрые проверки API:
```bash
# здоровье
curl -s http://127.0.0.1:8000/health | jq .
# метрики Prometheus
curl -s http://127.0.0.1:8000/metrics | head -n 40
```
Сводка метрик через утилиту:
```bash
python tools/auroractl.py metrics --window-sec 600
```
Хвост событий и ордеров (в сессионной папке):
```bash
SESS_DIR="${AURORA_SESSION_DIR:-logs}"
# последние 50 событий
tail -n 50 "$SESS_DIR/aurora_events.jsonl"

# успешные ордера (последние 10)
[ -f "$SESS_DIR/orders_success.jsonl" ] && tail -n 10 "$SESS_DIR/orders_success.jsonl" || true
# отклонённые (гейт/риск)
[ -f "$SESS_DIR/orders_denied.jsonl" ] && tail -n 10 "$SESS_DIR/orders_denied.jsonl" || true
# ошибки
[ -f "$SESS_DIR/orders_failed.jsonl" ] && tail -n 10 "$SESS_DIR/orders_failed.jsonl" || true
```
Фильтр по ожидаемой доходности (пример):
```bash
grep -E "EXPECTED_RETURN|expected_return_gate" -n logs/aurora_events.jsonl | tail -n 20
```

---

## 5) Типичные сценарии остановки
- Бот (foreground): Ctrl+C в окне бота.
- API (foreground): Ctrl+C в окне API.
- Если использовались фоновые/докерные варианты — см. ниже.

---

## 6) Вариант через Docker Compose (опционально)
Запуск API/мониторинга стеком:
```bash
docker compose up --build -d
```
Проверка:
```bash
curl -s http://127.0.0.1:8000/health | jq .
```
Остановка и очистка:
```bash
docker compose down
```

---

## 7) Быстрый троблшутинг
- Нет ответов от API: проверьте порт 8000 и `curl /health`. Если использовали `tools/auroractl.py start-api`, убедитесь, что процесс не завершился ошибкой.
- Мало исполнений на тестнете: временно используйте рыночный режим (taker), уменьшите спред‑гард, либо включите cancel stub для проверки событийного тракта.
- Ожидаемая доходность часто блокирует: пороги настроек ER‑гейта регулируются на стороне Aurora, а также зависят от входных параметров (`a_bps`, `b_bps`, `slip_bps_est`). Для тестов можно временно ослабить риск‑пороги.

---

## 8) Где смотреть артефакты
- События (канонично): `logs/aurora_events.jsonl`
- Ордеры: `logs/orders_success.jsonl`, `logs/orders_failed.jsonl`, `logs/orders_denied.jsonl`
- Метрики Prometheus: `GET /metrics`

---

## 9) Полезные сниппеты (опционально)
Проверка готовности обоих компонентов:
```bash
# API здоровье (должно вернуть ok=true)
curl -s http://127.0.0.1:8000/health | jq .
# ops-линесс (при наличии токена)
curl -s -H "X-OPS-TOKEN: ${AURORA_OPS_TOKEN:-$OPS_TOKEN}" http://127.0.0.1:8000/liveness | jq .
# проверка активности бота — быстрый хвост
for f in logs/aurora_events.jsonl logs/orders_success.jsonl; do 
  [ -f "$f" ] && echo "=== $f ===" && tail -n 5 "$f"; 
done
```

---

Советы, если «нет открытых сделок» на тестнете:
- Включите тейкер (рыночный) режим в конфиге исполнения или временно уменьшите фильтры — так исполняемость выше на тестнете.
- Ослабьте спред‑гард: `export AURORA_SPREAD_MAX_BPS=50` (или больше) на время проверки энд‑ту‑энд.
- Проверьте ATR: в логе могут быть строки `[GUARD] ATR unavailable, skip open` — значит не удалось получить OHLCV. Перезапустите бот/проверьте сеть.
- На консоли ищите `[GATE] BLOCKED: reason=...` и `[SKIP] reason=...` — это точные причины, почему ордер не ставится.

Готово. Если требуется добавить раздел «автозапуск как сервис» или отдельные профили (paper/shadow), дайте знать — дополним.