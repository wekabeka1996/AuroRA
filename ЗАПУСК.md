# Запуск Aurora: от тестнета до продакшна

Ниже — супер‑понятная инструкция «как запустить бота и API, как в тесте, так и в проде». Шаги простые, всё делаем по пунктам и не спешим. Команды для bash (Git Bash/WSL на Windows). Пути — от корня репозитория.

Важно:
- Ключи/токены храните в `.env`, а не в коде.
- API доступен по http://127.0.0.1:8000 (метрики `/metrics`, здоровье `/health`).
- Для защищённых OPS эндпоинтов обязательно заголовок `X-OPS-TOKEN`.

---

## 0) Что нужно заранее

- Python 3.11+ и зависимости (по проектной инструкции):
```bash
python -m pip install -r requirements.txt -r requirements-dev.txt
```
- Файл `.env`. Возьмите `./.env.example`, переименуйте в `.env`, затем вставьте значения:
  - для тестнета — тестовые API‑ключи;
  - для продакшна — боевые ключи и сильный `OPS_TOKEN` (минимум 32 символа).

Пример для тестнета (безопасно):
```bash
AURORA_MODE=prod          # prod включает раннер
EXCHANGE_TESTNET=true     # но биржа тестовая
DRY_RUN=false
BINANCE_API_KEY=your_test_key
BINANCE_API_SECRET=your_test_secret
OPS_TOKEN=please-change-me-XXXXXXXXXXXXXXXXXXXXXXXX
# опционально: упростить старт
AURORA_CONFIG_NAME=aurora/testnet
```

Пример для продакшна (ОСТОРОЖНО! настоящие сделки):
```bash
AURORA_MODE=prod
EXCHANGE_TESTNET=false    # настоящая биржа
DRY_RUN=false             # реальные ордера
BINANCE_API_KEY=your_live_key
BINANCE_API_SECRET=your_live_secret
OPS_TOKEN=strong-super-long-token-XXXXXXXXXXXXXXXXXXXX
# выберем профиль
AURORA_CONFIG_NAME=aurora/prod
```

---

## 1) Запуск в один клик (рекомендуется)
Объединённый CLI сам: проверит кошелёк → запустит API → подождёт здоровье → запустит трафик/раннер → соберёт метрики → остановит API.
```bash
python tools/auroractl.py one-click --mode testnet --minutes 15 --preflight
```
- `--mode testnet` — тестовая биржа
- `--minutes 15` — пример окна работы
- `--preflight` — быстрые проверки окружения

Чтобы прямо в тестнете включить реальный раннер (ордеры на тестовой бирже), добавьте:
```bash
python tools/auroractl.py one-click --mode testnet --minutes 15 --preflight --runner-in-testnet --runner-config test_param
```

Продакшн «в один клик» (ОСТОРОЖНО: реальные сделки):
```bash
python tools/auroractl.py one-click --mode live --minutes 30 --preflight --runner-config test_param
```

Остановить: Ctrl+C в запущенном терминале.

---

## 2) Ручной запуск API (если надо по шагам)
Вариант A (предпочтительный):
```bash
python tools/auroractl.py start-api
```
Вариант B (напрямую):
```bash
python api/service.py
```
Проверка готовности API:
```bash
# public
curl -s http://127.0.0.1:8000/health | jq .
# ops (нужен токен)
curl -s -H "X-OPS-TOKEN: ${AURORA_OPS_TOKEN:-$OPS_TOKEN}" http://127.0.0.1:8000/liveness | jq .
```
Остановка API:
- Если запущено в текущем окне: Ctrl+C.
- Если в отдельном окне — закройте процесс. (Опционально) если использовали Docker, см. раздел 6.

---

## 2.1) Конфиги: как выбрать и как переопределять

Загрузка конфигурации унифицирована. Приоритет:

1) `AURORA_CONFIG` (абсолютный/относительный путь или имя без .yaml)
2) `AURORA_CONFIG_NAME` (имя без .yaml)
3) Первый существующий из цепочки по умолчанию (стандартизированная структура → legacy):
  - `configs/aurora/base.yaml`
  - `configs/aurora/prod.yaml`
  - `configs/aurora/testnet.yaml`
  - `configs/master_config_v2.yaml`
  - `configs/master_config_v1.yaml`
  - `configs/aurora_config.template.yaml`
  - `skalp_bot/configs/default.yaml`

Быстрые команды для выбора/проверки конфига:
```bash
# записать выбранное имя в .env (укажется AURORA_CONFIG_NAME)
python tools/auroractl.py config-use --name master_config_v2

# проверить и вывести нормализованный конфиг (по .env или с явным именем)
python tools/auroractl.py config-validate
python tools/auroractl.py config-validate --name master_config_v2
```

Стандартизированная раскладка:

- `configs/aurora/*.yaml` — конфиги сервиса Aurora (API/гейты/наблюдаемость). Есть шаблон `base.yaml` и пример `testnet.example.yaml`.
- `configs/runner/*.yaml` — конфиги раннера/скальпера. Пока можно использовать и старые `skalp_bot/configs/*.yaml` — резолвер учитывает оба места.

Примечание: для обратной совместимости поддерживаются legacy файлы из корня `configs/` и `skalp_bot/configs/`.

Env‑overrides (переменные поверх YAML) — самые частые:
- `AURORA_SPREAD_BPS_LIMIT`, `AURORA_LATENCY_MS_LIMIT`, `AURORA_PI_MIN_BPS`
- `AURORA_MAX_CONCURRENT`, `AURORA_SIZE_SCALE`
- `AURORA_TRAP_WINDOW_S`, `AURORA_TRAP_LEVELS`, `AURORA_TRAP_Z_THRESHOLD`
- `AURORA_API_HOST`, `AURORA_API_PORT`, `OPS_TOKEN`

Пример: хотим временно ослабить лимит спреда и повысить размер:
```bash
export AURORA_SPREAD_BPS_LIMIT=120
export AURORA_SIZE_SCALE=0.25
```

---

## 3) Ручной запуск скальпер‑бота
Открыть новое окно терминала (оставьте API работать) и выполнить:
```bash
# при необходимости (единоразово в текущем окне)
export PYTHONPATH=$PWD

# запуск бота (читает .env автоматически)
python -m skalp_bot.runner.run_live_aurora

# посмотреть справку по CLI
python -m skalp_bot.runner.run_live_aurora --help

# запуск с явным конфигом (резолвер поддерживает bare‑имя и оба места: configs/runner и skalp_bot/configs)
python -m skalp_bot.runner.run_live_aurora --config configs/runner/test_param.yaml
```
В процессе вы увидите строки вида `[DBG]`, `[GATE]`, `[ENTRY]`, `[TRADE]` и т.д.

Сессии логов:
- Каждый процесс (API и раннер) при старте создаёт собственную папку `logs/YYYYMMDD-HHMMSS` и печатает строку `[SESSION] logs dir = ...`.
- Все артефакты пишутся внутрь этой папки: `aurora_events.jsonl`, `orders_{success,failed,denied}.jsonl`, а также сводный `orders.jsonl`.
- Чтобы API и бот писали в одну и ту же папку, заранее установите переменную окружения и запускайте оба процесса в этой же среде:
  
  ```bash
  export AURORA_SESSION_DIR="$(pwd)/logs/$(date -u +%Y%m%d-%H%M%S)"
  python tools/auroractl.py start-api &
  python -m skalp_bot.runner.run_live_aurora
  ```
  
  В этом случае оба процесса будут использовать одну сессионную директорию.

Остановка бота: Ctrl+C в его терминале.

Полезные env‑твики для старта (по необходимости):
```bash
# включить демонстрационный CANCEL stub каждые N тиков
export AURORA_CANCEL_STUB=true
export AURORA_CANCEL_STUB_EVERY_TICKS=120

# управлять лимитом спреда (в б.п.) поверх конфига
export AURORA_SPREAD_MAX_BPS=8

# доля спреда, закладываемая как слиппедж (по умолчанию тестнет 0.25)
export AURORA_SLIP_ETA=0.25
```

Тейкер/мейкер режим:
- По умолчанию используется лимитный (maker) режим из конфига. Для быстрых наполнений можно переключиться на рыночный (taker) режим в конфиге исполнения, либо через соответствующую настройку, если она прокинута в env.

---

## 4) Мониторинг и проверка
Быстрые проверки API:
```bash
# здоровье
curl -s http://127.0.0.1:8000/health | jq .
# метрики Prometheus
curl -s http://127.0.0.1:8000/metrics | head -n 40
```
Сводка метрик через утилиту:
```bash
python tools/auroractl.py metrics --window-sec 600
```
Хвост событий и ордеров (в сессионной папке):
```bash
SESS_DIR="${AURORA_SESSION_DIR:-logs}"
# последние 50 событий
tail -n 50 "$SESS_DIR/aurora_events.jsonl"

# успешные ордера (последние 10)
[ -f "$SESS_DIR/orders_success.jsonl" ] && tail -n 10 "$SESS_DIR/orders_success.jsonl" || true
# отклонённые (гейт/риск)
[ -f "$SESS_DIR/orders_denied.jsonl" ] && tail -n 10 "$SESS_DIR/orders_denied.jsonl" || true
# ошибки
[ -f "$SESS_DIR/orders_failed.jsonl" ] && tail -n 10 "$SESS_DIR/orders_failed.jsonl" || true
```
Фильтр по ожидаемой доходности (пример):
```bash
grep -E "EXPECTED_RETURN|expected_return_gate" -n logs/aurora_events.jsonl | tail -n 20
```

Диагностика: некоторые советы (например, «service_unhealthy» когда модель не прогрета) теперь пишутся в `observability.diagnostics` внутри полезной нагрузки событий решения. Основные причины блокировки остаются в `reasons`.

---

## 5) Как остановить
- Бот (foreground): Ctrl+C в окне бота.
- API (foreground): Ctrl+C в окне API.
- Если использовались фоновые/докерные варианты — см. ниже.

---

## 6) Docker Compose (опционально)
Запуск API/мониторинга стеком:
```bash
docker compose up --build -d
```
Проверка:
```bash
curl -s http://127.0.0.1:8000/health | jq .
```
Остановка и очистка:
```bash
docker compose down
```

---

## 7) Если что-то пошло не так
- Нет ответов от API: проверьте порт 8000 и `curl /health`. Если использовали `tools/auroractl.py start-api`, убедитесь, что процесс не завершился ошибкой.
- Мало исполнений на тестнете: временно используйте рыночный режим (taker), уменьшите спред‑гард, либо включите cancel stub для проверки событийного тракта.
- Ожидаемая доходность часто блокирует: пороги настроек ER‑гейта регулируются на стороне Aurora, а также зависят от входных параметров (`a_bps`, `b_bps`, `slip_bps_est`). Для тестов можно временно ослабить риск‑пороги.

---

## 8) Где смотреть артефакты
- События (канонично): `logs/aurora_events.jsonl`
- Ордеры: `logs/orders_success.jsonl`, `logs/orders_failed.jsonl`, `logs/orders_denied.jsonl`
- Метрики Prometheus: `GET /metrics`

---

## 9) Env‑override: самые полезные
Любую настройку можно переопределить через переменные окружения (они применяются поверх YAML). Наиболее востребованные:

- Здоровье/латентность API:
  - `AURORA_LATENCY_GUARD_MS` — порог p95 (мс)
  - `AURORA_LATENCY_WINDOW_SEC` — окно оценки p95
  - `AURORA_COOLOFF_SEC` — базовый cool‑off
- OPS/API:
  - `AURORA_API_HOST`, `AURORA_API_PORT` — биндинг API
  - `OPS_TOKEN`/`AURORA_OPS_TOKEN` — токен для защищённых эндпоинтов
- Гейты (guards):
  - `AURORA_SPREAD_BPS_LIMIT`, `AURORA_LATENCY_MS_LIMIT`, `AURORA_VOL_GUARD_STD_BPS`
  - `TRAP_GUARD` — включить/выключить trap‑guard (true/false)
- Риск/размер:
  - `AURORA_PI_MIN_BPS` — минимальная ожидаемая доходность (б.п.)
  - `AURORA_MAX_CONCURRENT` — ограничение одновременно открытых
  - `AURORA_SIZE_SCALE` — масштаб размера [0..1]
- Слиппедж:
  - `AURORA_SLIP_ETA` — доля спреда, используемая как ожидание слиппеджа
- Профиль препрод: `AURORA_ORDER_PROFILE` (напр. `er_before_slip`)
- Trap‑окно:
  - `AURORA_TRAP_WINDOW_S`, `AURORA_TRAP_LEVELS`, `AURORA_TRAP_Z_THRESHOLD`, `AURORA_TRAP_CANCEL_PCTL`

Если одно и то же поле задано и в YAML, и через env, применяется значение из env.

---

## 10) Полезные сниппеты (опционально)
Проверка готовности обоих компонентов:
```bash
# API здоровье (должно вернуть ok=true)
curl -s http://127.0.0.1:8000/health | jq .
# ops-линесс (при наличии токена)
curl -s -H "X-OPS-TOKEN: ${AURORA_OPS_TOKEN:-$OPS_TOKEN}" http://127.0.0.1:8000/liveness | jq .
# проверка активности бота — быстрый хвост
for f in logs/aurora_events.jsonl logs/orders_success.jsonl; do 
  [ -f "$f" ] && echo "=== $f ===" && tail -n 5 "$f"; 
done
```

---

## 11) «Как для 6‑летки» — супер‑коротко про продакшн
1. Попроси взрослого: дадут боевые ключи и длинный `OPS_TOKEN`.
2. Открой файл `.env` и вставь:
  - `AURORA_MODE=prod`
  - `EXCHANGE_TESTNET=false`
  - `DRY_RUN=false`
  - `BINANCE_API_KEY=...` и `BINANCE_API_SECRET=...`
  - `OPS_TOKEN=...`
  - `AURORA_CONFIG_NAME=aurora/prod`
3. Установи зависимости (один раз):
  ```bash
  python -m pip install -r requirements.txt -r requirements-dev.txt
  ```
4. Запусти в один клик:
  ```bash
  python tools/auroractl.py one-click --mode live --minutes 30 --preflight --runner-config test_param
  ```
5. Смотри, что всё работает:
  ```bash
  curl -s http://127.0.0.1:8000/health | jq .
  python tools/auroractl.py metrics --window-sec 600
  ```
6. Чтобы остановить — нажми Ctrl+C, либо команда остановит API сама по завершении окна.

Заметка для взрослых: держите под рукой значения в `configs/aurora/prod.yaml` и при необходимости правьте пороги быстрыми env‑оверрайдами.

---

Советы, если «нет открытых сделок» на тестнете:
- Включите тейкер (рыночный) режим в конфиге исполнения или временно уменьшите фильтры — так исполняемость выше на тестнете.
- Ослабьте спред‑гард: `export AURORA_SPREAD_MAX_BPS=50` (или больше) на время проверки энд‑ту‑энд.
- Проверьте ATR: в логе могут быть строки `[GUARD] ATR unavailable, skip open` — значит не удалось получить OHLCV. Перезапустите бот/проверьте сеть.
- На консоли ищите `[GATE] BLOCKED: reason=...` и `[SKIP] reason=...` — это точные причины, почему ордер не ставится.

Готово. Если требуется добавить раздел «автозапуск как сервис» или отдельные профили (paper/shadow), дайте знать — дополним.